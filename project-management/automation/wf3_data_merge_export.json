{
  "name": "Engezna - WF3: Data Merge & Export",
  "nodes": [
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [200, 400]
    },
    {
      "parameters": {
        "operation": "read",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "1HTjVdxyh8Uhz1lMbe6CEvdSHXfzgwmlo96Cz6ZPrHU8"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": "Ù…Ø·Ø§Ø¹Ù… ğŸ½ï¸"
        },
        "options": {
          "range": "A3:W500"
        }
      },
      "id": "read-restaurants",
      "name": "Read Ù…Ø·Ø§Ø¹Ù…",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [480, 200],
      "credentials": {
        "googleSheetsApi": {
          "id": "google-sheets-sa",
          "name": "Google Sheets Service Account"
        }
      }
    },
    {
      "parameters": {
        "operation": "read",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "1HTjVdxyh8Uhz1lMbe6CEvdSHXfzgwmlo96Cz6ZPrHU8"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": "ØµÙŠØ¯Ù„ÙŠØ§Øª ğŸ’Š"
        },
        "options": {
          "range": "A3:W500"
        }
      },
      "id": "read-pharmacies",
      "name": "Read ØµÙŠØ¯Ù„ÙŠØ§Øª",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [480, 360],
      "credentials": {
        "googleSheetsApi": {
          "id": "google-sheets-sa",
          "name": "Google Sheets Service Account"
        }
      }
    },
    {
      "parameters": {
        "operation": "read",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "1HTjVdxyh8Uhz1lMbe6CEvdSHXfzgwmlo96Cz6ZPrHU8"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": "Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª ğŸ›’"
        },
        "options": {
          "range": "A3:W500"
        }
      },
      "id": "read-supermarkets",
      "name": "Read Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [480, 520],
      "credentials": {
        "googleSheetsApi": {
          "id": "google-sheets-sa",
          "name": "Google Sheets Service Account"
        }
      }
    },
    {
      "parameters": {
        "operation": "read",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "1HTjVdxyh8Uhz1lMbe6CEvdSHXfzgwmlo96Cz6ZPrHU8"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": "Ø­Ù„ÙˆÙŠØ§Øª ÙˆÙƒØ§ÙÙŠÙ‡Ø§Øª â˜•"
        },
        "options": {
          "range": "A3:W500"
        }
      },
      "id": "read-sweets",
      "name": "Read Ø­Ù„ÙˆÙŠØ§Øª ÙˆÙƒØ§ÙÙŠÙ‡Ø§Øª",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [480, 680],
      "credentials": {
        "googleSheetsApi": {
          "id": "google-sheets-sa",
          "name": "Google Sheets Service Account"
        }
      }
    },
    {
      "parameters": {
        "operation": "read",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "1HTjVdxyh8Uhz1lMbe6CEvdSHXfzgwmlo96Cz6ZPrHU8"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": "Ø®Ø¶Ø§Ø± ÙˆÙÙˆØ§ÙƒÙ‡ ğŸ¥¬"
        },
        "options": {
          "range": "A3:W500"
        }
      },
      "id": "read-vegetables",
      "name": "Read Ø®Ø¶Ø§Ø± ÙˆÙÙˆØ§ÙƒÙ‡",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [480, 840],
      "credentials": {
        "googleSheetsApi": {
          "id": "google-sheets-sa",
          "name": "Google Sheets Service Account"
        }
      }
    },
    {
      "parameters": {
        "operation": "read",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "1HTjVdxyh8Uhz1lMbe6CEvdSHXfzgwmlo96Cz6ZPrHU8"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": "enrichment_results"
        },
        "options": {}
      },
      "id": "read-enrichment",
      "name": "Read Enrichment Results",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [480, 1000],
      "credentials": {
        "googleSheetsApi": {
          "id": "google-sheets-sa",
          "name": "Google Sheets Service Account"
        }
      }
    },
    {
      "parameters": {
        "operation": "read",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "1HTjVdxyh8Uhz1lMbe6CEvdSHXfzgwmlo96Cz6ZPrHU8"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": "Ù…ØªØ§Ø¬Ø±_Ù…ÙƒØªØ´ÙØ©"
        },
        "options": {}
      },
      "id": "read-discovered",
      "name": "Read Discovered Merchants",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [480, 1160],
      "credentials": {
        "googleSheetsApi": {
          "id": "google-sheets-sa",
          "name": "Google Sheets Service Account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ØªØ¬Ù…ÙŠØ¹ ÙƒÙ„ Ø§Ù„Ø´ÙŠØªØ§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙÙŠ Ù…ØµÙÙˆÙØ© ÙˆØ§Ø­Ø¯Ø© Ù…Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØµÙ†ÙŠÙ\nconst restaurants = $('Read Ù…Ø·Ø§Ø¹Ù…').all().map(i => ({ ...i.json, _category: 'Ù…Ø·Ø§Ø¹Ù…', _sheet: 'Ù…Ø·Ø§Ø¹Ù…' }));\nconst pharmacies = $('Read ØµÙŠØ¯Ù„ÙŠØ§Øª').all().map(i => ({ ...i.json, _category: 'ØµÙŠØ¯Ù„ÙŠØ§Øª', _sheet: 'ØµÙŠØ¯Ù„ÙŠØ§Øª' }));\nconst supermarkets = $('Read Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª').all().map(i => ({ ...i.json, _category: 'Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª', _sheet: 'Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª' }));\nconst sweets = $('Read Ø­Ù„ÙˆÙŠØ§Øª ÙˆÙƒØ§ÙÙŠÙ‡Ø§Øª').all().map(i => ({ ...i.json, _category: 'Ø­Ù„ÙˆÙŠØ§Øª ÙˆÙƒØ§ÙÙŠÙ‡Ø§Øª', _sheet: 'Ø­Ù„ÙˆÙŠØ§Øª ÙˆÙƒØ§ÙÙŠÙ‡Ø§Øª' }));\nconst vegetables = $('Read Ø®Ø¶Ø§Ø± ÙˆÙÙˆØ§ÙƒÙ‡').all().map(i => ({ ...i.json, _category: 'Ø®Ø¶Ø§Ø± ÙˆÙÙˆØ§ÙƒÙ‡', _sheet: 'Ø®Ø¶Ø§Ø± ÙˆÙÙˆØ§ÙƒÙ‡' }));\n\nconst allOriginal = [...restaurants, ...pharmacies, ...supermarkets, ...sweets, ...vegetables];\n\nreturn allOriginal.map(m => ({ json: m }));"
      },
      "id": "combine-originals",
      "name": "Combine All Original Sheets",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [760, 400]
    },
    {
      "parameters": {
        "jsCode": "// === Smart Merge Logic ===\n// Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙØ«Ø±Ø§Ø© (enrichment) Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©\nconst originals = $('Combine All Original Sheets').all();\nconst enrichments = $('Read Enrichment Results').all();\nconst discovered = $('Read Discovered Merchants').all();\n\n// Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø±ÙŠØ·Ø© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙØ«Ø±Ø§Ø© Ø¨Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±\nconst enrichmentMap = new Map();\nfor (const e of enrichments) {\n  const name = (e.json.merchant_name || '').trim().toLowerCase();\n  if (name) enrichmentMap.set(name, e.json);\n}\n\n// === Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù…Ø¹ Ø§Ù„Ù…ÙØ«Ø±Ø§Ø© ===\nconst mergedResults = [];\nconst reviewNeeded = [];\nlet updatedCount = 0;\nlet conflictCount = 0;\n\nfor (const original of originals) {\n  const o = original.json;\n  const merchantName = (o['Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±'] || o['name'] || '').trim();\n  const enriched = enrichmentMap.get(merchantName.toLowerCase());\n  \n  const merged = { ...o };\n  \n  if (enriched) {\n    // === Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¯Ù…Ø¬ Ø§Ù„Ø°ÙƒÙŠØ© ===\n    \n    // 1. Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ\n    const origPhone = (o['Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ 1'] || o['Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ 2'] || '').trim();\n    const enrichPhone = (enriched.enriched_phone || '').trim();\n    if (!origPhone && enrichPhone) {\n      merged['Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ 1'] = enrichPhone;\n      updatedCount++;\n    } else if (origPhone && enrichPhone && origPhone !== enrichPhone) {\n      merged['Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ 1'] = origPhone; // Ù†Ø­ØªÙØ¸ Ø¨Ø§Ù„Ø£ØµÙ„ÙŠ\n      reviewNeeded.push({\n        merchant: merchantName,\n        field: 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ 1',\n        original: origPhone,\n        enriched: enrichPhone,\n        note: 'Ø±Ù‚Ù…ÙŠÙ† Ù…Ø®ØªÙ„ÙÙŠÙ† - ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©'\n      });\n      conflictCount++;\n    }\n    \n    // 2. Ø§Ù„Ø¹Ù†ÙˆØ§Ù†\n    const origAddr = (o['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'] || o['address'] || '').trim();\n    const enrichAddr = (enriched.enriched_address || '').trim();\n    if (!origAddr && enrichAddr) {\n      merged['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'] = enrichAddr;\n      updatedCount++;\n    } else if (origAddr && enrichAddr && origAddr.length < enrichAddr.length * 0.5) {\n      // Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙØ«Ø±Ù‰ Ø£ÙƒØ«Ø± ØªÙØµÙŠÙ„Ø§Ù‹\n      merged['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'] = enrichAddr;\n      updatedCount++;\n    }\n    \n    // 3. Ø¬ÙˆØ¬Ù„ Ù…Ø§Ø¨\n    const origMap = (o['Ø¬ÙˆØ¬Ù„ Ù…Ø§Ø¨'] || '').trim();\n    const enrichMap = (enriched.google_maps_url || '').trim();\n    if (!origMap && enrichMap) {\n      merged['Ø¬ÙˆØ¬Ù„ Ù…Ø§Ø¨'] = enrichMap;\n      updatedCount++;\n    }\n    \n    // 4. Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (ØªÙØ¶Ø§Ù Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©)\n    if (enriched.rating) merged['Ø§Ù„ØªÙ‚ÙŠÙŠÙ…'] = enriched.rating;\n    if (enriched.total_ratings) merged['Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª'] = enriched.total_ratings;\n    if (enriched.opening_hours) merged['Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„'] = enriched.opening_hours;\n    if (enriched.website) merged['Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ'] = enriched.website;\n    if (enriched.lat) merged['Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶'] = enriched.lat;\n    if (enriched.lng) merged['Ø®Ø· Ø§Ù„Ø·ÙˆÙ„'] = enriched.lng;\n    if (enriched.status_ar) merged['Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØ¬Ø±'] = enriched.status_ar;\n    \n    merged['Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] = new Date().toISOString().split('T')[0];\n  }\n  \n  mergedResults.push({ json: merged });\n}\n\n// === Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ« ===\nconst stats = {\n  total_original: originals.length,\n  total_enriched: enrichments.length,\n  total_discovered: discovered.length,\n  fields_updated: updatedCount,\n  conflicts_found: conflictCount,\n  review_items: reviewNeeded.length,\n  merge_date: new Date().toISOString()\n};\n\n// Ø£ÙˆÙ„ Ø¹Ù†ØµØ± = Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª\n// Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ± = Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ù…Ø¬Ø©\nreturn [{ json: { _type: 'stats', ...stats } }, ...mergedResults];"
      },
      "id": "smart-merge",
      "name": "Smart Merge",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1020, 580]
    },
    {
      "parameters": {
        "jsCode": "// ÙØµÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª\nconst items = $input.all();\nconst stats = items.find(i => i.json._type === 'stats');\nconst data = items.filter(i => i.json._type !== 'stats');\n\nreturn data;"
      },
      "id": "separate-data",
      "name": "Extract Merged Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1260, 480]
    },
    {
      "parameters": {
        "jsCode": "// ÙØµÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª\nconst items = $('Smart Merge').all();\nconst stats = items.find(i => i.json._type === 'stats');\n\nif (!stats) {\n  return [{ json: { message: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª' } }];\n}\n\nreturn [stats];"
      },
      "id": "extract-stats",
      "name": "Extract Stats",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1260, 700]
    },
    {
      "parameters": {
        "jsCode": "// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª\nconst items = $input.all();\nconst validated = [];\nconst invalid = [];\n\nconst phoneRegex = /^(\\+20|0)(1[0-9]{9}|[0-9]{8,9})$/;\nconst urlRegex = /^https?:\\/\\/.+/;\n\nfor (const item of items) {\n  const d = item.json;\n  const errors = [];\n  \n  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ\n  const phone = (d['Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ 1'] || d['Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ 2'] || '').replace(/[\\s-]/g, '');\n  if (phone && !phoneRegex.test(phone)) {\n    errors.push(`Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­: ${phone}`);\n  }\n  \n  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ø§Ø¨Ø· Ø¬ÙˆØ¬Ù„ Ù…Ø§Ø¨\n  const mapUrl = d['Ø¬ÙˆØ¬Ù„ Ù…Ø§Ø¨'] || '';\n  if (mapUrl && !urlRegex.test(mapUrl)) {\n    errors.push(`Ø±Ø§Ø¨Ø· Ø¬ÙˆØ¬Ù„ Ù…Ø§Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­: ${mapUrl}`);\n  }\n  \n  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±\n  const name = d['Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±'] || d['name'] || '';\n  if (!name.trim()) {\n    errors.push('Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø± ÙØ§Ø±Øº');\n    continue; // ØªØ®Ø·ÙŠ Ø§Ù„ØµÙÙˆÙ Ø§Ù„ÙØ§Ø±ØºØ©\n  }\n  \n  if (errors.length > 0) {\n    invalid.push({\n      json: {\n        ...d,\n        validation_errors: errors.join(' | '),\n        needs_review: true\n      }\n    });\n  } else {\n    validated.push(item);\n  }\n}\n\n// ØªØ±Ø¬Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© ÙÙ‚Ø·\n// Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø© Ù‡ØªØªØ³Ø¬Ù„ ÙÙŠ Ø´ÙŠØª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©\nreturn validated;"
      },
      "id": "validate-data",
      "name": "Validate Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1500, 480]
    },
    {
      "parameters": {
        "jsCode": "// ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ Ù„ÙƒØªØ§Ø¨ØªÙ‡Ø§ ÙÙŠ Ø§Ù„Ø´ÙŠØªØ§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©\nconst items = $input.all();\n\nconst sheets = {};\nfor (const item of items) {\n  const sheet = item.json._sheet || 'Ø£Ø®Ø±Ù‰';\n  if (!sheets[sheet]) sheets[sheet] = [];\n  \n  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ÙƒØªØ§Ø¨Ø©\n  const clean = { ...item.json };\n  delete clean._category;\n  delete clean._sheet;\n  delete clean._type;\n  \n  sheets[sheet].push({ json: clean });\n}\n\n// ØªØ±Ø¬ÙŠØ¹ Ø£ÙˆÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø¹ metadata Ø¹Ù† ÙƒÙ„ Ø§Ù„Ø´ÙŠØªØ§Øª\nconst allClean = items.map(i => {\n  const clean = { ...i.json };\n  delete clean._category;\n  delete clean._sheet;\n  delete clean._type;\n  return { json: clean };\n});\n\nreturn allClean;"
      },
      "id": "prepare-export",
      "name": "Prepare for Export",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1720, 480]
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "1HTjVdxyh8Uhz1lMbe6CEvdSHXfzgwmlo96Cz6ZPrHU8"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": "merged_final"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "matchingColumns": ["Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±"]
        },
        "options": {}
      },
      "id": "write-merged",
      "name": "Write Merged Results",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [1940, 480],
      "credentials": {
        "googleSheetsApi": {
          "id": "google-sheets-sa",
          "name": "Google Sheets Service Account"
        }
      }
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "1HTjVdxyh8Uhz1lMbe6CEvdSHXfzgwmlo96Cz6ZPrHU8"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": "ØªÙ‚Ø±ÙŠØ±_Ø§Ù„ØªØ­Ø¯ÙŠØ«"
        },
        "columns": {
          "mappingMode": "autoMapInputData"
        },
        "options": {}
      },
      "id": "write-stats",
      "name": "Write Update Report",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [1500, 700],
      "credentials": {
        "googleSheetsApi": {
          "id": "google-sheets-sa",
          "name": "Google Sheets Service Account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ø®Øµ Ø§Ù„ØªØ­Ø¯ÙŠØ«\nconst stats = $('Extract Stats').first().json;\n\nconst summary = `ØªÙ‚Ø±ÙŠØ± ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù†Ø¬Ø²Ù†Ø§\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nØ§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-EG')}\n\nØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:\nâ€¢ Ø§Ù„Ù…ØªØ§Ø¬Ø± Ø§Ù„Ø£ØµÙ„ÙŠØ©: ${stats.total_original || 0}\nâ€¢ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙØ«Ø±Ø§Ø©: ${stats.total_enriched || 0}\nâ€¢ Ù…ØªØ§Ø¬Ø± Ù…ÙƒØªØ´ÙØ© Ø¬Ø¯ÙŠØ¯Ø©: ${stats.total_discovered || 0}\nâ€¢ Ø­Ù‚ÙˆÙ„ ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§: ${stats.fields_updated || 0}\nâ€¢ ØªØ¹Ø§Ø±Ø¶Ø§Øª ØªØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©: ${stats.conflicts_found || 0}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nØ§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¬Ø§Ù‡Ø² ÙÙŠ Google Sheets`;\n\nreturn [{ json: { summary, ...stats } }];"
      },
      "id": "generate-summary",
      "name": "Generate Summary",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2160, 480]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "1HTjVdxyh8Uhz1lMbe6CEvdSHXfzgwmlo96Cz6ZPrHU8"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": "Ø³Ø¬Ù„_Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª"
        },
        "columns": {
          "mappingMode": "autoMapInputData"
        },
        "options": {}
      },
      "id": "write-log",
      "name": "Write Update Log",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [2380, 480],
      "credentials": {
        "googleSheetsApi": {
          "id": "google-sheets-sa",
          "name": "Google Sheets Service Account"
        }
      }
    }
  ],
  "connections": {
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Read Ù…Ø·Ø§Ø¹Ù…",
            "type": "main",
            "index": 0
          },
          {
            "node": "Read ØµÙŠØ¯Ù„ÙŠØ§Øª",
            "type": "main",
            "index": 0
          },
          {
            "node": "Read Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª",
            "type": "main",
            "index": 0
          },
          {
            "node": "Read Ø­Ù„ÙˆÙŠØ§Øª ÙˆÙƒØ§ÙÙŠÙ‡Ø§Øª",
            "type": "main",
            "index": 0
          },
          {
            "node": "Read Ø®Ø¶Ø§Ø± ÙˆÙÙˆØ§ÙƒÙ‡",
            "type": "main",
            "index": 0
          },
          {
            "node": "Read Enrichment Results",
            "type": "main",
            "index": 0
          },
          {
            "node": "Read Discovered Merchants",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Ù…Ø·Ø§Ø¹Ù…": {
      "main": [
        [
          {
            "node": "Combine All Original Sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read ØµÙŠØ¯Ù„ÙŠØ§Øª": {
      "main": [
        [
          {
            "node": "Combine All Original Sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª": {
      "main": [
        [
          {
            "node": "Combine All Original Sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Ø­Ù„ÙˆÙŠØ§Øª ÙˆÙƒØ§ÙÙŠÙ‡Ø§Øª": {
      "main": [
        [
          {
            "node": "Combine All Original Sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Ø®Ø¶Ø§Ø± ÙˆÙÙˆØ§ÙƒÙ‡": {
      "main": [
        [
          {
            "node": "Combine All Original Sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Enrichment Results": {
      "main": [
        [
          {
            "node": "Smart Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Discovered Merchants": {
      "main": [
        [
          {
            "node": "Smart Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Combine All Original Sheets": {
      "main": [
        [
          {
            "node": "Smart Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Smart Merge": {
      "main": [
        [
          {
            "node": "Extract Merged Data",
            "type": "main",
            "index": 0
          },
          {
            "node": "Extract Stats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Merged Data": {
      "main": [
        [
          {
            "node": "Validate Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Stats": {
      "main": [
        [
          {
            "node": "Write Update Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Data": {
      "main": [
        [
          {
            "node": "Prepare for Export",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare for Export": {
      "main": [
        [
          {
            "node": "Write Merged Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write Merged Results": {
      "main": [
        [
          {
            "node": "Generate Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Summary": {
      "main": [
        [
          {
            "node": "Write Update Log",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": null,
  "tags": [
    {
      "name": "engezna",
      "id": "1"
    },
    {
      "name": "data-merge",
      "id": "4"
    }
  ],
  "triggerCount": 0,
  "updatedAt": "2026-02-06T00:00:00.000Z",
  "versionId": "1"
}