# Engezna - n8n Merchant Data Workflows
# ุฅูุฌุฒูุง - ููุฑูููู ุชุฌููุน ูุชุญุฏูุซ ุจูุงูุงุช ุงููุชุงุฌุฑ

## ูุธุฑุฉ ุนุงูุฉ

3 ููุฑูููู ุนูููุฉ ูุชุฌููุน ูุชุญุฏูุซ ุจูุงูุงุช ุงููุชุงุฌุฑ ูู ุจูู ุณููู ุจุงุณุชุฎุฏุงู Google Maps API:

| Workflow | ุงูููู | ุงููุธููุฉ |
|----------|-------|---------|
| WF1 | `wf1_google_maps_enrichment.json` | ุฅุซุฑุงุก ุจูุงูุงุช ุงููุชุงุฌุฑ ุงูููุฌูุฏุฉ (ูุงุชูุ ุนููุงูุ ุชูููู) |
| WF2 | `wf2_new_merchant_discovery.json` | ุงูุชุดุงู ูุชุงุฌุฑ ุฌุฏูุฏุฉ ูู 5 ููุงุทู ร 6 ูุฆุงุช |
| WF3 | `wf3_data_merge_export.json` | ุชุฌููุน ูู ุงููุชุงุฆุฌ + ุงูุชุญูู + ุงูุชุตุฏูุฑ |

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ          ุชุฑุชูุจ ุงูุชุดุบูู                        โ
โ                                              โ
โ  WF1 (ุฅุซุฑุงุก) โโโ WF2 (ุงูุชุดุงู) โโโ WF3 (ุชุฌููุน) โ
โ                                              โ
โ  Google Sheets โโโ ูุตุฏุฑ ุงูุจูุงูุงุช ูุงููุชุงุฆุฌ      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ูุชุทูุจุงุช ุงูุฅุนุฏุงุฏ

### 1. Google Cloud Project

```
1. ุงุฐูุจ ุฅูู https://console.cloud.google.com
2. ุงูุชุญ ุงููุดุฑูุน: "Engezna" (engezna-6edd0)
3. ูุนูู ุงูู APIs:
   โ Places API
   โ Geocoding API
   โ Google Sheets API
   โ Google Drive API
4. ุฃูุดุฆ API Key ูู Credentials (ูู Google Maps)
5. ูููุฏ ุงูู API Key ุนูู Places API ู Geocoding API ููุท
```

> Google Maps ูุนุทูู $200 ุฑุตูุฏ ูุฌุงูู ุดูุฑูุงู - ูุงูู ูู 93 ูุชุฌุฑ + ุงูุชุดุงู.

### 2. ุฅุนุฏุงุฏ Google Sheets Credentials (Service Account - ุงูุทุฑููุฉ ุงููููุตู ุจูุง)

> โ๏ธ **ููู**: ุงุณุชุฎุฏู Service Account ุจุฏู OAuth2 - ุฃุณูู ููุง ูุญุชุงุฌ callback URL

```
ุงูุฎุทูุงุช:
1. ุงุฐูุจ ุฅูู Google Cloud Console โ IAM & Admin โ Service Accounts
2. ุงุถุบุท "Create Service Account"
3. ุงูุงุณู: "n8n-sheets-access"
4. ุงููุตู: "Service account for n8n Google Sheets access"
5. ุงุถุบุท "Create and Continue"
6. ูู ุงูู Role ุงุฎุชุฑ: "Editor" (ุฃู "Google Sheets API" specific)
7. ุงุถุบุท "Done"
8. ุงุถุบุท ุนูู ุงูู Service Account ุงููู ุฃูุดุฃุชู
9. ุงุฐูุจ ูุชุงุจ "Keys"
10. ุงุถุบุท "Add Key" โ "Create New Key" โ "JSON"
11. ูููุฒู ููู JSON - ุฏู ููุชุงุญู
12. โ๏ธ ููู: ุงูุชุญ Google Sheet ูุดูุฑ ูุน ุฅูููู ุงูู Service Account
    (ููููู ุดููู: n8n-sheets-access@engezna-6edd0.iam.gserviceaccount.com)
```

#### ุฅุนุฏุงุฏ ุงูู Credential ูู n8n:
```
1. ูู n8n ุงุฐูุจ ุฅูู Credentials โ Add Credential
2. ุงุจุญุซ ุนู "Google Sheets API"
3. ุงุฎุชุฑ "Service Account"
4. ุงูุตู ูุญุชูู ููู JSON ุงููู ูุฒูุชู
5. ุงุถุบุท "Save"
6. ุณูููู: "Google Sheets Service Account"
```

### 2b. ุฅุตูุงุญ OAuth2 (ูู ุนุงูุฒ ุชุณุชุฎุฏู OAuth ุจุฏู Service Account)

> ุงูุฎุทุฃ: "Client authentication failed" - ุฏู ุจูุญุตู ูุฃู ุฅุนุฏุงุฏุงุช OAuth Client ูุด ุตุญ

```
ูุฅุตูุงุญ ุงูุฎุทุฃ:
1. ุงุฐูุจ ุฅูู Google Cloud Console โ APIs & Services โ Credentials
2. ุชุฃูุฏ ุฅู ุงูู OAuth Client ID ููุนู "Web application" (ูุด Desktop!)
3. ูู "Authorized redirect URIs" ุฃุถู:
   http://localhost:5678/rest/oauth2-credential/callback
4. ูู n8n ุนูู domain ุฎุงุฑุฌู ุฃุถู ููุงู:
   https://your-domain.com/rest/oauth2-credential/callback
5. ุงุญูุธ ูุงุณุชูู ุฏูููุฉ
6. ุงูุณุฎ Client ID ู Client Secret ุงูุฌุฏูุฏูู
7. ูู n8n: Credentials โ Google Sheets OAuth2
8. ุงูุตู ุงูู Client ID ูุงูู Client Secret
9. ุงุถุบุท "Connect" ูุณุฌู ุฏุฎูู ุจุญุณุงุจ Google

โ๏ธ ุชุฃูุฏ ุฅู ุญุณุงุจู ูุถุงู ูู Test User ูู:
   Google Cloud Console โ OAuth Consent Screen โ Test Users
   (mosab.7ai@gmail.com โ ูุถุงู)
```

### 3. Google Sheets

```
ุงูุดูุช ุงูุญุงูู: "ูุฏููุฉ ุจูู ุณููู"
Sheet ID: 1HTjVdxyh8Uhz1lMbe6CEvdSHXfzgwmlo96Cz6ZPrHU8

ุดูุชุงุช ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ (ูุง ุชุนุฏูู ุนูููุง):
   - ููุญุฉ ุงูุชุญูู          โ Dashboard ุจุงูุฅุญุตุงุฆูุงุช
   - ูุทุงุนู ๐ฝ๏ธ            โ ุจูุงูุงุช ุงููุทุงุนู
   - ุตูุฏููุงุช ๐           โ ุจูุงูุงุช ุงูุตูุฏููุงุช
   - ุณูุจุฑ ูุงุฑูุช ๐        โ ุจูุงูุงุช ุงูุณูุจุฑูุงุฑูุช
   - ุญูููุงุช ููุงูููุงุช โ    โ ุจูุงูุงุช ุงูุญูููุงุช ูุงููุงูููุงุช
   - ุฎุถุงุฑ ูููุงูู ๐ฅฌ       โ ุจูุงูุงุช ุงูุฎุถุงุฑ ูุงูููุงูู
   - ูุชุงุจุนุฉ CRM           โ ูุชุงุจุนุฉ ุงูุชูุงุตู

โ๏ธ ูููู ูู ุดูุช:
   - ุตู 1-2: ุนููุงู ููุนูููุงุช (merged)
   - ุตู 3: ุฃุณูุงุก ุงูุฃุนูุฏุฉ (headers)
   - ุตู 4+: ุงูุจูุงูุงุช ุงููุนููุฉ
   - ุงูุฃุนูุฏุฉ: ุงุณู ุงููุชุฌุฑ | ุงููุฑุน ุงูุฑุฆูุณู | ุงูุนููุงู | ุงูููุทูุฉ | ุฑูู ุงููุงุชู 1 | ุฑูู ุงููุงุชู 2 | ููุณุจูู | ุงูุณุชุฌุฑุงู | ุฌูุฌู ูุงุจ | ...

ุฃูุดุฆ ุดูุชุงุช ุฅุถุงููุฉ ูุงุฑุบุฉ (ูููุชุงุฆุฌ):
   - enrichment_results    โ ูุชุงุฆุฌ ุงูุฅุซุฑุงุก ูู WF1
   - not_found_log         โ ูุชุงุฌุฑ ูู ูุชู ุงูุนุซูุฑ ุนูููุง
   - ูุชุงุฌุฑ_ููุชุดูุฉ         โ ูุชุงุฌุฑ ุฌุฏูุฏุฉ ูู WF2
   - all_merchants         โ ุงูุณุฎ ููู ูู ุงููุชุงุฌุฑ ูู ูู ุงูุดูุชุงุช (ูู WF2)
   - merged_final          โ ุงููุชุงุฆุฌ ุงูููุงุฆูุฉ ุงููุฏูุฌุฉ ูู WF3
   - ุชูุฑูุฑ_ุงูุชุญุฏูุซ        โ ุชูุฑูุฑ ุงูุฅุญุตุงุฆูุงุช
   - ุณุฌู_ุงูุชุญุฏูุซุงุช        โ ุณุฌู ูู ุงูุชุญุฏูุซุงุช

โ๏ธ ูู Service Account: ุดูุฑ ุงูู Sheet ูุน ุฅูููู ุงูู SA
```

### 4. n8n Environment Variables

ุฃุถู ูุฐู ุงููุชุบูุฑุงุช ูู ุฅุนุฏุงุฏุงุช n8n (Settings โ Environment Variables):

```
GOOGLE_MAPS_API_KEY=AIza...your_key_here
GOOGLE_SHEET_ID=1HTjVdxyh8Uhz1lMbe6CEvdSHXfzgwmlo96Cz6ZPrHU8
```

---

## ุทุฑููุฉ ุงูุงุณุชูุฑุงุฏ

```
1. ุงูุชุญ n8n
2. ุงุถุบุท "Import from file"
3. ุงุฎุชุฑ ุงูููู JSON
4. ุนุฏูู ุงูู credentials:
   - ููู Google Sheets node: ุงุฎุชุฑ "Google Sheets Service Account"
   - ุฃู "Google Sheets OAuth2" ูู ุตูุญุช ุงูู OAuth
5. ุชุฃูุฏ ุฅู Environment Variables ูุถุงูุฉ
6. ุงุถุบุท "Save"
```

---

## WF1: Google Maps Enrichment

### ูุงุฐุง ููุนูุ
- ููุฑุฃ ุงููุชุงุฌุฑ ูู Google Sheet
- ูููุชุฑ ุงููุชุงุฌุฑ ุงููู ุนูุฏูุง ุจูุงูุงุช ูุงูุตุฉ (ูุงุชู/ุนููุงู/ุฌูุฌู ูุงุจ)
- ูุจุญุซ ุนู ูู ูุชุฌุฑ ูู Google Places API
- ูุณุชุฎุฑุฌ ุงูุชูุงุตูู ุงููุงููุฉ (Place Details)
- ููุชุจ ุงููุชุงุฆุฌ ูู ุดูุช `enrichment_results`
- ุงููุชุงุฌุฑ ุงููู ูุด ูุงูููุง ุจุชุชุณุฌู ูู `not_found_log`

### ุงูุจูุงูุงุช ุงููุณุชุฎุฑุฌุฉ
- ุงูุนููุงู ุงููุงูู
- ุฑูู ุงููุงุชู
- ุฑุงุจุท ุฌูุฌู ูุงุจ
- ุงูุชูููู ูุนุฏุฏ ุงููุฑุงุฌุนุงุช
- ุณุงุนุงุช ุงูุนูู
- ุญุงูุฉ ุงููุดุงุท (ููุชูุญ/ูุบูู)
- ุงูุฅุญุฏุงุซูุงุช (lat/lng)
- ุงููููุน ุงูุฅููุชุฑููู

### ุงูุชูููุฉ
~93 ูุชุฌุฑ ร (Text Search + Place Details) = ~$4.6 (ุถูู ุงูุฑุตูุฏ ุงููุฌุงูู)

### ููุงุญุธุงุช
- **Batch size**: 5 ูุชุงุฌุฑ ูู ุงูุฏูุนุฉ ุงููุงุญุฏุฉ
- **Rate limit**: 2 ุซูุงูู ุจูู ูู ุฏูุนุฉ
- **ุดุบููู ุนูู ุดูุช ูุงุญุฏ ูู ุงููุฑุฉ** (ุนุฏูู ุงุณู ุงูุดูุช ูู node "โ๏ธ City Config")
- ุฃุณูุงุก ุงูุดูุชุงุช ุงููุชุงุญุฉ: `'ูุทุงุนู ๐ฝ๏ธ'` | `'ุตูุฏููุงุช ๐'` | `'ุณูุจุฑ ูุงุฑูุช ๐'` | `'ุญูููุงุช ููุงูููุงุช โ'` | `'ุฎุถุงุฑ ูููุงูู ๐ฅฌ'`
- ุงุจุฏุฃ ุจู 5 ูุชุงุฌุฑ ููุงุฎุชุจุงุฑ ูุจู ุชุดุบูู ุงููู

---

## WF2: New Merchant Discovery

### ูุงุฐุง ููุนูุ
- ูุจุญุซ ูู 5 ููุงุทู ูู ุจูู ุณููู ร 6 ูุฆุงุช = 30 ุนูููุฉ ุจุญุซ
- ูุณุชุฎุฏู Google Nearby Search API
- ููุงุฑู ุงููุชุงุฆุฌ ูุน ุงููุชุงุฌุฑ ุงูููุฌูุฏุฉ (ุจุงูุงุณู + ุงููููุน)
- ูุณุชุฎุฑุฌ ุชูุงุตูู ุงููุชุงุฌุฑ ุงูุฌุฏูุฏุฉ
- ูุตููู ุงูุฃููููุฉ (ุนุงููุฉ/ูุชูุณุทุฉ/ููุฎูุถุฉ) ุญุณุจ ุงูุชูููู
- ููุชุจ ูู ุดูุช `ูุชุงุฌุฑ_ููุชุดูุฉ`

### ููุงุทู ุงูุจุญุซ
| ุงูููุทูุฉ | ุงูุฅุญุฏุงุซูุงุช | ูุตู ุงููุทุฑ |
|---------|-----------|----------|
| ูุณุท ุงูุจูุฏ | 29.0744, 31.0983 | 3 ูู |
| ุดุฑู ุงูููู | 29.0680, 31.1120 | 3 ูู |
| ุฃุฑุถ ุงูุญุฑูุฉ | 29.0830, 31.0900 | 2 ูู |
| ุจูู ุณููู ุงูุฌุฏูุฏุฉ | 29.0500, 31.0800 | 3 ูู |
| ุงููุงุณุทู | 29.3333, 31.2000 | 5 ูู |

### ุงููุฆุงุช
ูุทุงุนูุ ุตูุฏููุงุชุ ุณูุจุฑ ูุงุฑูุชุ ุญูููุงุชุ ูุงูููุงุชุ ุฎุถุงุฑ ูููุงูู

### ุงูุฌุฏููุฉ
- **ูุฏูู**: ูู ุฃู ููุช

### ูุนุงููุฑ ุงูุฃููููุฉ
- **ุนุงููุฉ**: ุชูููู โฅ 4.0 + ูุฑุงุฌุนุงุช โฅ 20
- **ูุชูุณุทุฉ**: ุชูููู โฅ 3.5 ุฃู ูุฑุงุฌุนุงุช โฅ 10
- **ููุฎูุถุฉ**: ุจุงูู ุงููุชุงุฆุฌ

---

## WF3: Data Merge & Export

### ูุงุฐุง ููุนูุ
- ููุฑุฃ ูู ุงูุดูุชุงุช ุงูุฃุตููุฉ (5 ูุฆุงุช)
- ููุฑุฃ ูุชุงุฆุฌ ุงูุฅุซุฑุงุก (WF1) ูุงูุงูุชุดุงู (WF2)
- ูุฏูุฌ ุงูุจูุงูุงุช ุจุฐูุงุก:
  - ูู ุงูุญูู ุงูุฃุตูู ูุงุฑุบ ูุงูููุซุฑู ููุฌูุฏ โ ูุณุชุฎุฏู ุงูููุซุฑู
  - ูู ููู ุชุนุงุฑุถ โ ูุญุชูุธ ุจุงูุฃุตูู ููุณุฌู ุงูุชุนุงุฑุถ ูููุฑุงุฌุนุฉ
  - ุงูุจูุงูุงุช ุงูุฅุถุงููุฉ (ุชููููุ ุณุงุนุงุช ุนูู) ุจุชุชุถุงู ุฏุงููุงู
- ูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช (ุฃุฑูุงู ููุงุชูุ ุฑูุงุจุท)
- ููุชุจ ุงููุชุงุฆุฌ ุงูููุงุฆูุฉ ูู `merged_final`
- ููููุฏ ุชูุฑูุฑ ุจุงูุฅุญุตุงุฆูุงุช

### ุงูุฌุฏููุฉ
- **ูุฏูู**: ุจุนุฏ ุชุดุบูู WF1 + WF2

### ููุงุนุฏ ุงูุชุญูู
- **ุงููุงุชู**: ุตูุบุฉ ูุตุฑูุฉ (01xxxxxxxxx ุฃู 08xxxxxxx)
- **ุงูุฑูุงุจุท**: ุชุจุฏุฃ ุจู https://
- **ุงูุงุณู**: ูุงุฒู ูููู ููุฌูุฏ (ุงูุตููู ุงููุงุฑุบุฉ ุจุชุชุญุฐู)

---

## ุฎุทุฉ ุงูุชุดุบูู

### ุงููุฑุฉ ุงูุฃููู
```
1. ุฅุนุฏุงุฏ Google Cloud + Service Account + API Key
2. ุดูุฑ ุงูู Google Sheet ูุน ุฅูููู ุงูู Service Account
3. ุงุณุชูุฑุงุฏ ุงูู 3 workflows ูู n8n
4. ุฅุนุฏุงุฏ ุงูู credentials ูุงูู environment variables
5. WF1: ุดุบูู ุนูู ุดูุช "ูุทุงุนู" (ุงุฎุชุจุงุฑ ุนูู 5 ุฃููุงู)
6. WF1: ุดุบูู ุนูู ุจุงูู ุงูุดูุชุงุช ูุงุญุฏ ูุงุญุฏ
7. WF2: ุดุบูู ูุฏูู (ุงูุชุดุงู ูุชุงุฌุฑ ุฌุฏูุฏุฉ)
8. WF3: ุดุบูู ููุชุฌููุน ุงูููุงุฆู
9. ุฑุงุฌุน ุดูุช "merged_final" ูุตุฏูุฑู ูู Excel
```

### ุงูุชุญุฏูุซ ุงูุฏูุฑู
```
- ุฃุณุจูุนูุงู: WF2 ุดุบูู ูุฏูู (ุงูุชุดุงู ุฌุฏูุฏ)
- ุดูุฑูุงู: WF3 ูุฏูู (ุชุฌููุน)
- ุนูุฏ ุงูุญุงุฌุฉ: WF1 ูุฏูู ูุฅุนุงุฏุฉ ุฅุซุฑุงุก ุจูุงูุงุช ูุญุฏุฏุฉ
```

---

## ุงูุชูููุฉ ุงูุฅุฌูุงููุฉ

| ุงูุจูุฏ | ุงูุชูููุฉ |
|-------|---------|
| Google Maps API | $0 (ุถูู $200 ุงููุฌุงูู) |
| Google Sheets | $0 |
| n8n (self-hosted) | $0 |
| **ุงูุฅุฌูุงูู** | **$0** |

---

## ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### "Client authentication failed" (OAuth2)
- **ุงูุณุจุจ**: ุฅุนุฏุงุฏุงุช OAuth Client ุบูุฑ ุตุญูุญุฉ
- **ุงูุญู**:
  1. ุชุฃูุฏ ุฅู ููุน ุงูู Client ูู "Web application" (ูุด Desktop)
  2. ุฃุถู `http://localhost:5678/rest/oauth2-credential/callback` ูู Authorized Redirect URIs
  3. ุฃู **ุงุณุชุฎุฏู Service Account** ุจุฏู OAuth2 (ุฃุณูู ูุฃุซุจุช)

### "OVER_QUERY_LIMIT"
- ูุตูุช ูุญุฏ ุงูุงุณุชุฎุฏุงู โ ุงูุชุธุฑ ุณุงุนุฉ ุฃู ุฒููุฏ ุงูู Wait ุจูู ุงูู batches

### "REQUEST_DENIED"
- ุงูู API Key ุบูุท ุฃู ุงูู API ูุด ููุนูุฉ โ ุฑุงุฌุน Google Cloud Console

### "ZERO_RESULTS"
- ุงููุชุฌุฑ ูุด ุนูู ุฌูุฌู ูุงุจ โ ููุชุณุฌู ูู `not_found_log` ููุญุชุงุฌ ุจุญุซ ูุฏูู

### Google Sheets "Permission denied"
- **Service Account**: ุชุฃูุฏ ุฅูู ุดูุฑุช ุงูู Sheet ูุน ุฅูููู ุงูู SA
- **OAuth**: ุงูู credential ูุญุชุงุฌ ุชุฌุฏูุฏ โ ุงุนูู re-authenticate ูู n8n

### "Google hasn't verified this app"
- ุนุงุฏู ูู ุงูู app ูู Testing mode - ุงุถุบุท "Continue"
- ุชุฃูุฏ ุฅู ุญุณุงุจู ูุถุงู ูู Test User ูู OAuth consent screen

---

## ูููุงุช ุงูู Workflows

```
project-management/automation/
โโโ wf1_google_maps_enrichment.json    # ุฅุซุฑุงุก ุงูุจูุงูุงุช
โโโ wf2_new_merchant_discovery.json    # ุงูุชุดุงู ูุชุงุฌุฑ ุฌุฏูุฏุฉ
โโโ wf3_data_merge_export.json         # ุชุฌููุน ูุชุตุฏูุฑ
โโโ n8n_workflow.json                  # Knowledge Bot (ููุฌูุฏ ุณุงุจูุงู)
โโโ MERCHANT_DATA_WORKFLOWS.md         # ูุฐุง ุงูููู
โโโ TELEGRAM_BOT_SETUP.md             # ุฅุนุฏุงุฏ ุจูุช ุชูููุฌุฑุงู
```
