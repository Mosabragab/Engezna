# ğŸ¦ Ø®Ø·Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ ØµÙØ­Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª
## Admin Financial & Analytics Pages Synchronization Rebuild Plan

**Ø§Ù„ØªØ§Ø±ÙŠØ®**: 25 Ø¯ÙŠØ³Ù…Ø¨Ø± 2025
**Ø§Ù„Ø¥ØµØ¯Ø§Ø±**: 1.4
**Ø§Ù„Ø­Ø§Ù„Ø©**: Ø§Ù„Ù…Ø±Ø§Ø­Ù„ 1-4 Ø´Ø¨Ù‡ Ù…ÙƒØªÙ…Ù„Ø© âœ…

---

## ğŸŸ¢ Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù„ (Ù„Ù…Ø§Ø°Ø§ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù„ Ø°ÙƒÙŠØŸ)

### 1. Ø§Ù„Ù€ SQL View (Ù…Ø­Ø±Ùƒ Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ù…ÙˆØ­Ø¯) ğŸ¯
> **Ù‡Ø°Ù‡ Ù‡ÙŠ Ø£Ù‡Ù… Ø®Ø·ÙˆØ© ÙÙŠ Ø§Ù„Ø®Ø·Ø©**

Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© ÙÙŠ Frontend Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨ÙƒÙˆØ¯ØŒ ÙˆÙÙŠ Frontend Ø§Ù„ØªØ§Ø¬Ø± Ø¨ÙƒÙˆØ¯ Ø¢Ø®Ø±ØŒ ÙŠØªÙ… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (SQL View).

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âŒ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ:                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚ Admin Code  â”‚     â”‚ Provider    â”‚   â† ÙƒÙˆØ¯ Ù…Ø®ØªÙ„Ù = Ù†ØªØ§Ø¦Ø¬ Ù…Ø®ØªÙ„ÙØ©â”‚
â”‚  â”‚ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©â”‚     â”‚ Code Ø­Ø³Ø§Ø¨   â”‚                            â”‚
â”‚  â”‚ Ø¨Ø·Ø±ÙŠÙ‚Ø© A    â”‚     â”‚ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© B   â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ù‚ØªØ±Ø­:                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚        financial_settlement_engine (SQL View)           â”‚    â”‚
â”‚  â”‚        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•         â”‚    â”‚
â”‚  â”‚        Ù…ØµØ¯Ø± ÙˆØ§Ø­Ø¯ Ù„Ù„Ø­Ø³Ø§Ø¨ â† Ù†ØªØ§Ø¦Ø¬ Ù…ÙˆØ­Ø¯Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â†“                                  â†“                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Admin View  â”‚                    â”‚ Provider    â”‚             â”‚
â”‚  â”‚ (ÙŠÙ‚Ø±Ø£ ÙÙ‚Ø·)  â”‚                    â”‚ View        â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ø§Ù„ÙØ§Ø¦Ø¯Ø©: Ø¶Ù…Ø§Ù† Ø£Ù† 1 + 1 = 2 ÙÙŠ ÙƒÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øª.
Ø¥Ø°Ø§ ØªØºÙŠØ±Øª Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ØŒ ØªØªØºÙŠØ± ÙÙŠ Ù…ÙƒØ§Ù† ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·.
```

### 2. Ø§Ù„ØªÙ…ÙŠÙŠØ² Ø¨ÙŠÙ† "Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø¹Ø§Ù…" Ùˆ "Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥Ù‚Ù„ÙŠÙ…ÙŠ" ğŸ”

Ø§Ù„Ù…Ù‚ØªØ±Ø­ ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø£Ù…Ù†ÙŠØ© ÙˆØªÙ†Ø¸ÙŠÙ…ÙŠØ© ÙƒØ¨ÙŠØ±Ø©:
- **Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥Ù‚Ù„ÙŠÙ…ÙŠ ÙŠØ¬Ø¨ Ø£Ù„Ø§ ÙŠØ±Ù‰ Ù…Ø¨ÙŠØ¹Ø§Øª ØªØ¬Ø§Ø± ÙÙŠ Ù…Ù†Ø·Ù‚Ø© Ø£Ø®Ø±Ù‰**
- **Ø§Ù„ÙÙ„ØªØ±Ø© Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù€ Query** (ÙˆÙ„ÙŠØ³ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª) ØªØ¶Ù…Ù†:
  - âš¡ Ø£Ø¯Ø§Ø¡Ù‹ Ø³Ø±ÙŠØ¹Ø§Ù‹ (Performance)
  - ğŸ”’ Ø£Ù…Ø§Ù†Ø§Ù‹ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª

```sql
-- âŒ ÙÙ„ØªØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ø¨Ø·ÙŠØ¡ + ØºÙŠØ± Ø¢Ù…Ù†)
SELECT * FROM settlements; -- ÙŠØ­Ù…Ù„ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
â†’ Ø«Ù… ÙŠÙÙ„ØªØ± ÙÙŠ JavaScript

-- âœ… ÙÙ„ØªØ±Ø© Ù…Ù† Ø§Ù„Ù€ Query (Ø³Ø±ÙŠØ¹ + Ø¢Ù…Ù†)
SELECT * FROM settlements
WHERE provider_id IN (
  SELECT id FROM providers WHERE governorate_id = 'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©'
);
```

### 3. Ù…Ø¹Ø§Ù„Ø¬Ø© "Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØªØ³ÙˆÙŠØ©" (Settlement Direction) ğŸ”„

Ø­Ù„ ÙˆØ§Ø¶Ø­ Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø§Ø±ØªØ¨Ø§Ùƒ ÙÙŠ Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù€ COD:
> **"Ù‡Ù„ Ø§Ù„ØªØ§Ø¬Ø± Ù…Ø¯ÙŠÙ† Ù„Ù†Ø§ Ø£Ù… Ù†Ø­Ù† Ù…Ø¯ÙŠÙ†ÙˆÙ† Ù„Ù‡ØŸ"**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  netBalance = online_payout_owed - cod_commission_owed      â”‚
â”‚                                                             â”‚
â”‚  Ø¥Ø°Ø§ netBalance > 0:                                        â”‚
â”‚    â†’ direction = 'platform_pays_provider'                   â”‚
â”‚    â†’ Ø§Ù„Ù…Ù†ØµØ© ØªØ¯ÙØ¹ Ù„Ù„ØªØ§Ø¬Ø± âœ…                                  â”‚
â”‚                                                             â”‚
â”‚  Ø¥Ø°Ø§ netBalance < 0:                                        â”‚
â”‚    â†’ direction = 'provider_pays_platform'                   â”‚
â”‚    â†’ Ø§Ù„ØªØ§Ø¬Ø± ÙŠØ¯ÙØ¹ Ù„Ù„Ù…Ù†ØµØ© âœ…                                  â”‚
â”‚                                                             â”‚
â”‚  Ø¥Ø°Ø§ netBalance â‰ˆ 0:                                        â”‚
â”‚    â†’ direction = 'balanced'                                 â”‚
â”‚    â†’ Ù…ØªÙˆØ§Ø²Ù† (Ù„Ø§ Ø£Ø­Ø¯ ÙŠØ¯ÙØ¹) âœ…                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…Ù‡Ù…Ø© (ÙŠØ¬Ø¨ ØªØ·Ø¨ÙŠÙ‚Ù‡Ø§)

### 1. Ù…Ø¹Ø§Ù„Ø¬Ø© "ÙƒØ³ÙˆØ± Ø§Ù„Ù‚Ø±ÙˆØ´" (Floating Point Issues) ğŸ’°

> **Ù…Ø´ÙƒÙ„Ø© Ø­Ø±Ø¬Ø©**: ÙÙŠ Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©ØŒ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø´Ø±ÙŠØ© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ØªØ³Ø¨Ø¨ Ø£Ø®Ø·Ø§Ø¡ ØªÙ‚Ø±ÙŠØ¨!

```javascript
// âŒ Ù…Ø´ÙƒÙ„Ø© Ø´Ø§Ø¦Ø¹Ø©:
0.1 + 0.2 = 0.30000000000000004  // Ø®Ø·Ø£!

// âŒ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©:
const commission = 100.50 * 0.07;
// Ù‚Ø¯ ÙŠÙ†ØªØ¬: 7.035000000000001 Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 7.04
```

**Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:**

```typescript
// âœ… Ø§Ù„Ø­Ù„ 1: Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ø¨Ø§Ù„Ù‚Ø±ÙˆØ´ (Ø£ØµØºØ± ÙˆØ­Ø¯Ø© Ø¹Ù…Ù„Ø©)
// ØªØ®Ø²ÙŠÙ† 100.50 Ø¬Ù†ÙŠÙ‡ ÙƒÙ€ 10050 Ù‚Ø±Ø´
interface MoneyInPiasters {
  amount: number;  // Ø¨Ø§Ù„Ù‚Ø±ÙˆØ´ (integers ÙÙ‚Ø·)
}

// Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„Ù‚Ø±ÙˆØ´
const totalPiasters = 10050;  // 100.50 Ø¬Ù†ÙŠÙ‡
const commissionPiasters = Math.round(totalPiasters * 0.07);  // 704 Ù‚Ø±Ø´ = 7.04 Ø¬Ù†ÙŠÙ‡

// Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·
const displayAmount = commissionPiasters / 100;  // 7.04

// âœ… Ø§Ù„Ø­Ù„ 2: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙƒØªØ¨Ø© Ù…ØªØ®ØµØµØ©
import Decimal from 'decimal.js';

const total = new Decimal('100.50');
const rate = new Decimal('0.07');
const commission = total.times(rate).toDecimalPlaces(2);  // 7.04 Ø¨Ø§Ù„Ø¶Ø¨Ø·
```

**Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ FinancialService:**

```typescript
// src/lib/finance/money.ts

export class Money {
  private piasters: number;  // ØªØ®Ø²ÙŠÙ† Ø¯Ø§Ø®Ù„ÙŠ Ø¨Ø§Ù„Ù‚Ø±ÙˆØ´

  constructor(amount: number | string) {
    if (typeof amount === 'string') {
      this.piasters = Math.round(parseFloat(amount) * 100);
    } else {
      this.piasters = Math.round(amount * 100);
    }
  }

  // Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ©
  add(other: Money): Money {
    return Money.fromPiasters(this.piasters + other.piasters);
  }

  subtract(other: Money): Money {
    return Money.fromPiasters(this.piasters - other.piasters);
  }

  multiply(factor: number): Money {
    return Money.fromPiasters(Math.round(this.piasters * factor));
  }

  // Ù„Ù„Ø¹Ø±Ø¶
  toNumber(): number {
    return this.piasters / 100;
  }

  format(locale: 'ar' | 'en'): string {
    return `${this.toNumber().toFixed(2)} ${locale === 'ar' ? 'Ø¬.Ù…' : 'EGP'}`;
  }

  static fromPiasters(piasters: number): Money {
    const m = new Money(0);
    m.piasters = Math.round(piasters);
    return m;
  }
}

// Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:
const orderTotal = new Money(100.50);
const commission = orderTotal.multiply(0.07);  // 7.04 Ø¨Ø§Ù„Ø¶Ø¨Ø·
```

---

### 2. Ø­Ø§Ù„Ø© "Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‚" (Hold Status) Ù„Ù„Ù†Ø²Ø§Ø¹Ø§Øª âš–ï¸

> **Ø§Ù„Ù…Ø´ÙƒÙ„Ø©**: Ù…Ø§Ø°Ø§ ÙŠØ­Ø¯Ø« Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ Ø¹Ù„ÙŠÙ‡Ø§ Ù†Ø²Ø§Ø¹ (Dispute)ØŸ
> Ø§Ù„ØªØ§Ø¬Ø± Ù‚Ø¯ ÙŠØ·Ø§Ù„Ø¨ Ø¨Ù…Ø§Ù„ Ø·Ù„Ø¨ Ù„Ù… ÙŠÙ†ØªÙ‡Ù Ø£Ù…Ø±Ù‡ Ø¨Ø¹Ø¯!

**Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù‚ØªØ±Ø­:**

```typescript
// Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© On Hold Ù„Ù„Ø·Ù„Ø¨Ø§Øª
type OrderSettlementStatus =
  | 'eligible'      // Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³ÙˆÙŠØ©
  | 'on_hold'       // Ù…Ø¹Ù„Ù‚ - Ù„Ø§ ÙŠØ¯Ø®Ù„ Ø§Ù„ØªØ³ÙˆÙŠØ©
  | 'settled'       // ØªÙ…Øª ØªØ³ÙˆÙŠØªÙ‡
  | 'excluded';     // Ù…Ø³ØªØ¨Ø¹Ø¯ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹

interface Order {
  // ... Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  settlement_status: OrderSettlementStatus;
  hold_reason?: string;
  hold_until?: Date;
}
```

**Ù…ØªÙ‰ ÙŠØªÙ… ÙˆØ¶Ø¹ Ø§Ù„Ø·Ù„Ø¨ On HoldØŸ**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ø§Ù„Ø·Ù„Ø¨ ÙŠÙˆØ¶Ø¹ On Hold ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯:                           â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                             â”‚
â”‚  1. ğŸ”´ Ù†Ø²Ø§Ø¹ Ù…ÙØªÙˆØ­ (Dispute)                                 â”‚
â”‚     â†’ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¹Ù„Ù‚ Ø­ØªÙ‰ ÙŠÙØ­Ù„ Ø§Ù„Ù†Ø²Ø§Ø¹                            â”‚
â”‚                                                             â”‚
â”‚  2. ğŸ”´ Ø·Ù„Ø¨ Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© (Refund Pending)            â”‚
â”‚     â†’ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¹Ù„Ù‚ Ø­ØªÙ‰ ÙŠÙÙ‚Ø±Ø± Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯                        â”‚
â”‚                                                             â”‚
â”‚  3. ğŸ”´ Ø´ÙƒÙˆÙ‰ Ø¹Ù…ÙŠÙ„ Ø®Ø·ÙŠØ±Ø©                                      â”‚
â”‚     â†’ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¹Ù„Ù‚ Ø­ØªÙ‰ ØªÙØ­Ù„ Ø§Ù„Ø´ÙƒÙˆÙ‰                            â”‚
â”‚                                                             â”‚
â”‚  4. ğŸ”´ ØªØ­Ù‚ÙŠÙ‚ Ø¯Ø§Ø®Ù„ÙŠ                                          â”‚
â”‚     â†’ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¹Ù„Ù‚ Ø­ØªÙ‰ ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„ØªØ­Ù‚ÙŠÙ‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ³ÙˆÙŠØ§Øª:**

```typescript
// Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ ØªØ³ÙˆÙŠØ©ØŒ Ù†Ø³ØªØ¨Ø¹Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
async function generateSettlement(providerId: string, period: DateRange) {
  // âœ… ÙÙ‚Ø· Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ØªØ³ÙˆÙŠØ©
  const { data: orders } = await supabase
    .from('orders')
    .select('*')
    .eq('provider_id', providerId)
    .eq('status', 'delivered')
    .eq('settlement_status', 'eligible')  // â† Ù…Ù‡Ù…!
    .gte('created_at', period.start)
    .lte('created_at', period.end);

  // Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ØªØ¸Ù‡Ø± Ù„Ù„Ø£Ø¯Ù…Ù† ÙƒÙ€ "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±"
  const { data: heldOrders } = await supabase
    .from('orders')
    .select('*')
    .eq('provider_id', providerId)
    .eq('settlement_status', 'on_hold');

  if (heldOrders.length > 0) {
    // ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø£Ø¯Ù…Ù†
    console.warn(`âš ï¸ ${heldOrders.length} Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø© Ù„Ù… ØªØ¯Ø®Ù„ Ø§Ù„ØªØ³ÙˆÙŠØ©`);
  }
}
```

**Migration SQL:**

```sql
-- Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³ÙˆÙŠØ© Ù„Ù„Ø·Ù„Ø¨Ø§Øª
ALTER TABLE orders ADD COLUMN IF NOT EXISTS
  settlement_status TEXT DEFAULT 'eligible'
  CHECK (settlement_status IN ('eligible', 'on_hold', 'settled', 'excluded'));

ALTER TABLE orders ADD COLUMN IF NOT EXISTS
  hold_reason TEXT;

ALTER TABLE orders ADD COLUMN IF NOT EXISTS
  hold_until TIMESTAMPTZ;

-- Index Ù„Ù„Ø£Ø¯Ø§Ø¡
CREATE INDEX IF NOT EXISTS idx_orders_settlement_status
  ON orders(settlement_status);

-- Trigger: ÙˆØ¶Ø¹ Ø§Ù„Ø·Ù„Ø¨ on_hold Ø¹Ù†Ø¯ ÙØªØ­ Ù†Ø²Ø§Ø¹
CREATE OR REPLACE FUNCTION hold_order_on_dispute()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.status = 'open' THEN
    UPDATE orders
    SET settlement_status = 'on_hold',
        hold_reason = 'Ù†Ø²Ø§Ø¹ Ù…ÙØªÙˆØ­ #' || NEW.id
    WHERE id = NEW.order_id
      AND settlement_status = 'eligible';
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_hold_order_on_dispute
  AFTER INSERT ON disputes
  FOR EACH ROW EXECUTE FUNCTION hold_order_on_dispute();
```

---

### 3. Ø§Ù„Ù€ Audit Trail Ø§Ù„Ù…Ø­Ø³Ù‘Ù† (Ø³Ø¬Ù„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª) ğŸ“‹

> **Ù„Ù…Ø§Ø°Ø§ Ù…Ù‡Ù…ØŸ** Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„ØªÙ„Ø§Ø¹Ø¨ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ ÙˆØ§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©

**Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ø¨ ØªØ³Ø¬ÙŠÙ„Ù‡Ø§:**

| Ø§Ù„Ø­Ù‚Ù„ | Ø§Ù„ÙˆØµÙ | Ù…Ø«Ø§Ù„ |
|-------|-------|------|
| `admin_id` | Ù…Ù† Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø°ÙŠ Ù†ÙØ°ØŸ | `uuid-of-admin` |
| `admin_name` | Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù | "Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯" |
| `action` | Ù…Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ | `record_payment` |
| `performed_at` | Ù…ØªÙ‰ØŸ | `2025-12-25T14:30:00Z` |
| `ip_address` | Ù…Ù† Ø£ÙŠÙ†ØŸ | `192.168.1.100` |
| `payment_reference` | Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø¨Ù†ÙƒÙŠ | `TRX-123456` |
| `old_value` | Ø§Ù„Ù‚ÙŠÙ…Ø© Ù‚Ø¨Ù„ | `{ status: 'pending' }` |
| `new_value` | Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø¹Ø¯ | `{ status: 'paid' }` |
| `reason` | Ø§Ù„Ø³Ø¨Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) | "ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„" |

**Ø¬Ø¯ÙˆÙ„ Audit Trail:**

```sql
CREATE TABLE settlement_audit_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- Ù…Ø§Ø°Ø§ ØªØºÙŠØ±ØŸ
  settlement_id UUID REFERENCES settlements(id),
  action TEXT NOT NULL,  -- 'create', 'update_status', 'record_payment', 'delete'

  -- Ù…Ù† ÙØ¹Ù„ Ø§Ù„ØªØºÙŠÙŠØ±ØŸ
  admin_id UUID REFERENCES admin_users(id),
  admin_name TEXT,
  admin_role TEXT,

  -- Ù…ØªÙ‰ ÙˆØ£ÙŠÙ†ØŸ
  performed_at TIMESTAMPTZ DEFAULT NOW(),
  ip_address INET,
  user_agent TEXT,

  -- ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØºÙŠÙŠØ±
  old_value JSONB,
  new_value JSONB,

  -- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
  payment_reference TEXT,
  payment_method TEXT,
  amount DECIMAL(12,2),
  reason TEXT,

  -- Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes Ù„Ù„Ø¨Ø­Ø«
CREATE INDEX idx_audit_settlement ON settlement_audit_log(settlement_id);
CREATE INDEX idx_audit_admin ON settlement_audit_log(admin_id);
CREATE INDEX idx_audit_date ON settlement_audit_log(performed_at);
CREATE INDEX idx_audit_action ON settlement_audit_log(action);
```

**Trigger Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹:**

```sql
CREATE OR REPLACE FUNCTION log_settlement_changes()
RETURNS TRIGGER AS $$
DECLARE
  v_admin_id UUID;
  v_admin_name TEXT;
BEGIN
  -- Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©
  v_admin_id := current_setting('app.current_admin_id', true)::UUID;

  SELECT name INTO v_admin_name
  FROM admin_users WHERE id = v_admin_id;

  IF TG_OP = 'INSERT' THEN
    INSERT INTO settlement_audit_log (
      settlement_id, action, admin_id, admin_name,
      new_value
    ) VALUES (
      NEW.id, 'create', v_admin_id, v_admin_name,
      to_jsonb(NEW)
    );
  ELSIF TG_OP = 'UPDATE' THEN
    INSERT INTO settlement_audit_log (
      settlement_id, action, admin_id, admin_name,
      old_value, new_value,
      payment_reference, payment_method, amount
    ) VALUES (
      NEW.id,
      CASE
        WHEN OLD.status != NEW.status AND NEW.status = 'paid' THEN 'record_payment'
        WHEN OLD.status != NEW.status THEN 'update_status'
        ELSE 'update'
      END,
      v_admin_id, v_admin_name,
      to_jsonb(OLD), to_jsonb(NEW),
      NEW.payment_reference, NEW.payment_method, NEW.amount_paid
    );
  ELSIF TG_OP = 'DELETE' THEN
    INSERT INTO settlement_audit_log (
      settlement_id, action, admin_id, admin_name,
      old_value
    ) VALUES (
      OLD.id, 'delete', v_admin_id, v_admin_name,
      to_jsonb(OLD)
    );
  END IF;

  RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_settlement_audit
  AFTER INSERT OR UPDATE OR DELETE ON settlements
  FOR EACH ROW EXECUTE FUNCTION log_settlement_changes();
```

**Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª - ØªØ³ÙˆÙŠØ© #SET-2024-001                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸŸ¢ 25 Ø¯ÙŠØ³Ù…Ø¨Ø± 2025 - 14:30                                     â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡: ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹                                          â”‚ â”‚
â”‚  â”‚ Ø¨ÙˆØ§Ø³Ø·Ø©: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ (Finance Admin)                             â”‚ â”‚
â”‚  â”‚ Ø§Ù„Ù…Ø¨Ù„Øº: 2,100 Ø¬.Ù…                                             â”‚ â”‚
â”‚  â”‚ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ                                       â”‚ â”‚
â”‚  â”‚ Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹: TRX-2024-123456                                   â”‚ â”‚
â”‚  â”‚ IP: 192.168.1.100                                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸŸ¡ 20 Ø¯ÙŠØ³Ù…Ø¨Ø± 2025 - 10:00                                     â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡: Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ³ÙˆÙŠØ©                                        â”‚ â”‚
â”‚  â”‚ Ø¨ÙˆØ§Ø³Ø·Ø©: Ø§Ù„Ù†Ø¸Ø§Ù… (Auto-generated)                               â”‚ â”‚
â”‚  â”‚ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: 45                                               â”‚ â”‚
â”‚  â”‚ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 2,100 Ø¬.Ù…                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ Ù…Ù„Ø®Øµ ØªÙ†ÙÙŠØ°ÙŠ

Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·Ø© ØªØ¹Ø§Ù„Ø¬ **Ø§Ù„ØªØ²Ø§Ù…Ù† Ø¨ÙŠÙ† ØµÙØ­Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† ÙˆØ§Ù„ØªØ§Ø¬Ø±** ÙÙŠ:
1. Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Finance)
2. Ø§Ù„ØªØ³ÙˆÙŠØ§Øª (Settlements)
3. Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª (Analytics)

Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø©:
- ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù† (Super Admin vs Regional Manager)
- ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª ÙˆØ§Ù„Ù…Ø¯Ù†
- Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ²Ø§Ù…Ù† Ø¨ÙŠÙ† Ø§Ù„Ø·Ø±ÙÙŠÙ†

---

## ğŸ”´ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ´ÙØ© (Critical Issues)

### 1. Ø¹Ø¯Ù… ØªÙ†Ø§Ø³Ù‚ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©

| Ø§Ù„Ù…Ø´ÙƒÙ„Ø© | Ø§Ù„Ù…ÙˆÙ‚Ø¹ | Ø§Ù„Ø®Ø·ÙˆØ±Ø© |
|---------|--------|---------|
| **net_payout Ù…Ø®ØªÙ„Ù** | Admin: `gross - commission` vs Provider: uses `net_amount_due` | ğŸ”´ Ø¹Ø§Ù„ÙŠØ© |
| **Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª** | Admin Ù„Ø§ ÙŠØ­Ø³Ø¨ ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© | ğŸ”´ Ø¹Ø§Ù„ÙŠØ© |
| **Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„** | Admin ÙŠØ¹Ø±Ø¶Ù‡Ø§ Ù…Ù†ÙØµÙ„Ø©ØŒ Provider Ù„Ø§ ÙŠØ±Ø§Ù‡Ø§ Ø¨ÙˆØ¶ÙˆØ­ | ğŸŸ¡ Ù…ØªÙˆØ³Ø·Ø© |
| **ÙØªØ±Ø© Ø§Ù„Ø³Ù…Ø§Ø­** | Admin ÙŠØ¹Ø±Ø¶ Ø§Ù„Ù†Ø³Ø¨Ø©ØŒ Ù„ÙƒÙ† Ù„Ø§ ÙŠÙˆØ¶Ø­ Ø£Ù†Ù‡Ø§ 0% | ğŸŸ¡ Ù…ØªÙˆØ³Ø·Ø© |

### 2. Ø¹Ø¯Ù… ØªÙ†Ø§Ø³Ù‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©

| ØµÙØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† | ØµÙØ­Ø© Ø§Ù„ØªØ§Ø¬Ø± | Ø§Ù„ÙØ±Ù‚ |
|-------------|-------------|-------|
| `platform_commission` | `totalCommission` | Ù†ÙØ³ Ø§Ù„Ø­Ù‚Ù„ Ù„ÙƒÙ† Ø§Ù„Ù…Ø³Ù…ÙŠØ§Øª Ù…Ø®ØªÙ„ÙØ© |
| `pending_settlements` (Ù…Ø¨Ù„Øº) | `totalDue` (Ù…Ø¨Ù„Øº) | Ù†ÙØ³ Ø§Ù„Ù…ÙÙ‡ÙˆÙ… |
| Ù„Ø§ ÙŠÙˆØ¬Ø¯ `cod_commission_owed` | ÙŠÙˆØ¬Ø¯ | Ø§Ù„ØªØ§Ø¬Ø± ÙŠØ±Ù‰ ØªÙØ§ØµÙŠÙ„ Ø£ÙƒØ«Ø±! |
| Ù„Ø§ ÙŠÙˆØ¬Ø¯ `settlement_direction` | ÙŠÙˆØ¬Ø¯ | Ø§Ù„ØªØ§Ø¬Ø± ÙŠØ±Ù‰ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ |

### 3. Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ©

```
Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ØµÙØ­Ø© Finance/page.tsx:                                     â”‚
â”‚  âŒ Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… applyProviderFilter Ù…Ù† AdminRegionContext     â”‚
â”‚  âŒ ØªÙÙ„ØªØ± settlements Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ (ØºÙŠØ± ÙØ¹Ø§Ù„)         â”‚
â”‚  âŒ stats ØªØ­Ø³Ø¨ Ù„ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø«Ù… ØªÙÙ„ØªØ± (Ø£Ø±Ù‚Ø§Ù… ØºÙŠØ± Ø¯Ù‚ÙŠÙ‚Ø©)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ØµÙØ­Ø© Settlements/page.tsx:                                 â”‚
â”‚  âŒ Ù†ÙØ³ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© - ÙÙ„ØªØ±Ø© Ù…Ø­Ù„ÙŠØ©                               â”‚
â”‚  âŒ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ³ÙˆÙŠØ§Øª Ù„ÙƒÙ„ Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ† (Ù„Ø§ ÙŠØ­ØªØ±Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ØµÙØ­Ø© Analytics/page.tsx:                                   â”‚
â”‚  âœ… ØªØ³ØªØ®Ø¯Ù… useAdminGeoFilter Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­                      â”‚
â”‚  âœ… ØªÙÙ„ØªØ± Ù…Ù† Ø§Ù„Ù€ query Ù…Ø¨Ø§Ø´Ø±Ø©                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª

| Ø§Ù„Ù…Ø´ÙƒÙ„Ø© | Ø§Ù„ØªØ£Ø«ÙŠØ± |
|---------|---------|
| Regional Manager ÙŠØ±Ù‰ ÙƒÙ„ Ø§Ù„ØªØ³ÙˆÙŠØ§Øª | Ø®Ø·Ø£ Ø£Ù…Ù†ÙŠ |
| Finance Admin Ù„Ø§ ÙŠØ³ØªØ·ÙŠØ¹ Ø±Ø¤ÙŠØ© ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ù†Ø·Ù‚ØªÙ‡ ÙÙ‚Ø· | Ù…Ø®Ø§Ù„Ù Ù„Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª |
| Generate Settlements Ù„ÙƒÙ„ Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ† | Regional Manager ÙŠÙˆÙ„Ø¯ Ù„ØºÙŠØ± Ù…Ù†Ø·Ù‚ØªÙ‡ |

### 5. ØºÙŠØ§Ø¨ Ù…ÙŠØ²Ø§Øª Ù…Ù‡Ù…Ø©

| Ø§Ù„Ù…ÙŠØ²Ø© | Ø§Ù„Ø£Ø¯Ù…Ù† | Ø§Ù„ØªØ§Ø¬Ø± | Ø§Ù„Ø­Ø§Ù„Ø© |
|--------|--------|--------|--------|
| ØªØµØ¯ÙŠØ± PDF | âŒ | âŒ | Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø·Ø±ÙÙŠÙ† |
| ØªØµØ¯ÙŠØ± Excel | âŒ | âœ… (ÙÙŠ Analytics) | Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø£Ø¯Ù…Ù† |
| Audit Trail | âŒ | âŒ | Ù…Ø·Ù„ÙˆØ¨ |
| Notifications Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØªØ³ÙˆÙŠØ© | âŒ | âŒ | Ù…Ø·Ù„ÙˆØ¨ |
| Real-time updates | âŒ | âŒ | Ù…Ø·Ù„ÙˆØ¨ |

---

## ğŸ¯ Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù‚ØªØ±Ø­

### Ø§Ù„Ù…Ø¨Ø¯Ø£ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ: Single Source of Truth

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    financial_settlement_engine                   â”‚
â”‚                         (SQL View)                              â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚  â€¢ Ù…ØµØ¯Ø± ÙˆØ§Ø­Ø¯ Ù„Ù„Ø­Ù‚ÙŠÙ‚Ø© Ù„ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª                               â”‚
â”‚  â€¢ ÙŠØ³ØªØ®Ø¯Ù…Ù‡ Ø§Ù„Ø£Ø¯Ù…Ù† ÙˆØ§Ù„ØªØ§Ø¬Ø± Ù…Ø¹Ø§Ù‹                                  â”‚
â”‚  â€¢ ÙŠØ­ØªØ±Ù… Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„ (Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ØŒ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§ØªØŒ Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Admin Dashboard    â”‚              â”‚  Provider Dashboard  â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚              â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚  â€¢ ÙƒÙ„ Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ†       â”‚              â”‚  â€¢ Ù…Ø²ÙˆØ¯ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·     â”‚
â”‚  â€¢ ÙÙ„ØªØ±Ø© Ø¬ØºØ±Ø§ÙÙŠØ©     â”‚              â”‚  â€¢ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ø§Ù„Ø®Ø§ØµØ©    â”‚
â”‚  â€¢ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¥Ø¯Ø§Ø±ÙŠØ©    â”‚              â”‚  â€¢ Ù„Ù„Ø§Ø·Ù„Ø§Ø¹ ÙÙ‚Ø·      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©

### 1. Shared Financial Service

```typescript
// src/lib/finance/financial-service.ts

export class FinancialService {
  private supabase: SupabaseClient
  private geoFilter?: GeoFilterValue
  private providerId?: string

  constructor(options: {
    supabase: SupabaseClient
    geoFilter?: GeoFilterValue  // Ù„Ù„Ø£Ø¯Ù…Ù†
    providerId?: string          // Ù„Ù„ØªØ§Ø¬Ø±
  })

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Core Methods - ØªØ³ØªØ®Ø¯Ù… financial_settlement_engine
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async getSettlementsSummary(dateRange: DateRange): Promise<SettlementSummary>
  async getSettlementDetails(settlementId: string): Promise<SettlementDetails>
  async getProviderFinancials(providerId: string): Promise<ProviderFinancials>
  async getRevenueBreakdown(dateRange: DateRange): Promise<RevenueBreakdown>

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Admin-only Methods
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async generateSettlement(options: GenerateSettlementOptions): Promise<Settlement>
  async recordPayment(settlementId: string, payment: PaymentRecord): Promise<void>
  async exportReport(format: 'pdf' | 'excel', options: ExportOptions): Promise<Blob>

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Geographic Filtering - ØªØ·Ø¨Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private applyGeoFilter<T>(query: PostgrestFilterBuilder<T>): PostgrestFilterBuilder<T>
}
```

### 2. Shared Types

```typescript
// src/types/finance.ts

export interface SettlementSummary {
  // Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
  totalRevenue: number
  totalCommission: number
  totalDeliveryFees: number
  totalRefunds: number

  // Ø§Ù„ØªØ³ÙˆÙŠØ§Øª
  pendingSettlementsAmount: number
  pendingSettlementsCount: number
  overdueSettlementsAmount: number
  overdueSettlementsCount: number
  paidSettlementsAmount: number
  paidSettlementsCount: number

  // Ø§Ù„ØªÙ‚Ø³ÙŠÙ… Ø­Ø³Ø¨ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
  codBreakdown: PaymentMethodBreakdown
  onlineBreakdown: PaymentMethodBreakdown

  // Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØµØ§ÙÙŠ
  netBalance: number
  settlementDirection: 'platform_pays_provider' | 'provider_pays_platform' | 'balanced'
}

export interface PaymentMethodBreakdown {
  ordersCount: number
  grossRevenue: number
  commission: number
  netAmount: number
  refundsAmount: number
}

export interface SettlementDetails {
  id: string
  provider: ProviderInfo
  period: { start: string; end: string }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙŠØ¬Ø¨ Ø£Ù† ØªØªØ·Ø§Ø¨Ù‚ Ø¨ÙŠÙ† Admin Ùˆ Provider
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  grossRevenue: number

  // COD
  cod: {
    ordersCount: number
    revenue: number
    commissionOwed: number  // Ù…Ø§ ÙŠØ¯ÙŠÙ† Ø¨Ù‡ Ø§Ù„ØªØ§Ø¬Ø± Ù„Ù„Ù…Ù†ØµØ©
  }

  // Online
  online: {
    ordersCount: number
    revenue: number
    platformCommission: number
    payoutOwed: number      // Ù…Ø§ ØªØ¯ÙŠÙ† Ø¨Ù‡ Ø§Ù„Ù…Ù†ØµØ© Ù„Ù„ØªØ§Ø¬Ø±
  }

  // Refunds - Ù…Ø¹Ø§Ø¯Ù„Ø© ØµØ­ÙŠØ­Ø©
  refunds: {
    totalAmount: number
    percentage: number
    // Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ Ù„Ø§ ØªØªØ£Ø«Ø±!
  }

  // Delivery (Ø­Ù‚ Ø§Ù„ØªØ§Ø¬Ø± Ø§Ù„Ø«Ø§Ø¨Øª)
  deliveryFees: number

  // Net Calculation
  netBalance: number
  direction: 'platform_pays_provider' | 'provider_pays_platform' | 'balanced'

  // Payment
  status: SettlementStatus
  amountPaid: number
  paymentMethod?: string
  paymentReference?: string
  paidAt?: string
}
```

### 3. Geographic Filter Integration

```typescript
// src/lib/finance/geo-filter.ts

export function buildFinancialQuery(
  supabase: SupabaseClient,
  table: 'settlements' | 'orders' | 'financial_settlement_engine',
  options: {
    geoFilter?: GeoFilterValue
    providerId?: string
    dateRange?: DateRange
    isRegionalAdmin?: boolean
    allowedGovernorateIds?: string[]
  }
) {
  let query = supabase.from(table).select('*')

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 1. Regional Admin Filter (Ø£ÙˆÙ„ÙˆÙŠØ© Ù‚ØµÙˆÙ‰)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (options.isRegionalAdmin && options.allowedGovernorateIds?.length) {
    // Ø§Ù„ÙÙ„ØªØ±Ø© Ø¹Ù† Ø·Ø±ÙŠÙ‚ provider_id Ù…Ù† Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
    query = query.in('provider_id',
      await getProviderIdsInGovernorates(supabase, options.allowedGovernorateIds)
    )
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 2. Geographic Filter (Ù„Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø¹Ø§Ø¯ÙŠ)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (options.geoFilter?.governorate_id) {
    // ÙÙ„ØªØ±Ø© Ø¹Ù† Ø·Ø±ÙŠÙ‚ provider location
    const providerIds = await getProviderIdsInRegion(supabase, options.geoFilter)
    query = query.in('provider_id', providerIds)
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 3. Provider Filter (Ù„Ù„ØªØ§Ø¬Ø±)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (options.providerId) {
    query = query.eq('provider_id', options.providerId)
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 4. Date Range
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (options.dateRange) {
    query = query
      .gte('created_at', options.dateRange.start)
      .lte('created_at', options.dateRange.end)
  }

  return query
}
```

---

## ğŸ“Š Ø¥Ø¹Ø§Ø¯Ø© ØªØµÙ…ÙŠÙ… Ø§Ù„ØµÙØ­Ø§Øª

### 1. ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ø£Ø¯Ù…Ù† (Finance)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¦ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©                           [ØªØ­Ø¯ÙŠØ«] [ØªØµØ¯ÙŠØ± PDF/Excel]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“ ÙÙ„ØªØ±Ø©: [Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© â–¼] [Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© â–¼]    ğŸ“… Ø§Ù„ÙØªØ±Ø©: [Ø§Ù„ÙŠÙˆÙ…|Ø£Ø³Ø¨ÙˆØ¹|Ø´Ù‡Ø±|Ø³Ù†Ø©] â”‚
â”‚  âš ï¸ Ù…Ù†Ø·Ù‚ØªÙƒ: Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©ØŒ Ø§Ù„Ø¬ÙŠØ²Ø© (Ù„Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥Ù‚Ù„ÙŠÙ…ÙŠ)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ       â”‚ â”‚ ğŸ“Š Ø¹Ù…ÙˆÙ„Ø©       â”‚ â”‚ ğŸšš ØªÙˆØµÙŠÙ„       â”‚ â”‚ â³ Ù…Ø¹Ù„Ù‚â”‚â”‚
â”‚  â”‚ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª       â”‚ â”‚ Ø§Ù„Ù…Ù†ØµØ©         â”‚ â”‚ (Ø­Ù‚ Ø§Ù„ØªØ¬Ø§Ø±)     â”‚ â”‚        â”‚â”‚
â”‚  â”‚ â–² +15%         â”‚ â”‚ â–² +12%         â”‚ â”‚ Ø«Ø§Ø¨Øª           â”‚ â”‚ 5 ØªØ³ÙˆÙŠØ§Øªâ”‚â”‚
â”‚  â”‚ 150,000 Ø¬.Ù…    â”‚ â”‚ 10,500 Ø¬.Ù…     â”‚ â”‚ 3,000 Ø¬.Ù…      â”‚ â”‚ 8,500   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                         â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                         ğŸ’³ ØªÙ‚Ø³ÙŠÙ… Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ’µ Ù†Ù‚Ø¯ÙŠ (COD)       â”‚ â”‚ ğŸ’³ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ         â”‚ â”‚ ğŸ“± Ù…Ø­ÙØ¸Ø©         â”‚  â”‚
â”‚  â”‚ 60,000 Ø¬.Ù… (40%)   â”‚ â”‚ 75,000 Ø¬.Ù… (50%)   â”‚ â”‚ 15,000 Ø¬.Ù… (10%)â”‚  â”‚
â”‚  â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•     â”‚ â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚ â”‚ â•â•â•â•             â”‚  â”‚
â”‚  â”‚ Ø§Ù„ØªØ§Ø¬Ø± ÙŠØ¯ÙŠÙ†:        â”‚ â”‚ Ø§Ù„Ù…Ù†ØµØ© ØªØ¯ÙŠÙ†:        â”‚ â”‚                  â”‚  â”‚
â”‚  â”‚ 4,200 Ø¬.Ù…          â”‚ â”‚ 70,875 Ø¬.Ù…         â”‚ â”‚                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚  ğŸ”„ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„ØµØ§ÙÙŠ:                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Ø§Ù„Ù…Ù†ØµØ© ØªØ¯ÙØ¹ Ù„Ù„ØªØ¬Ø§Ø±: 66,675 Ø¬.Ù… â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶      â”‚   â”‚
â”‚  â”‚  (70,875 - 4,200 = 66,675)                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                        ğŸ“‹ Ø§Ù„ØªØ³ÙˆÙŠØ§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Ø§Ù„Ù…ØªØ¬Ø± â”‚ Ø§Ù„ÙØªØ±Ø©   â”‚ Ø§Ù„Ø·Ù„Ø¨Ø§Øª â”‚ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©   â”‚ Ø§Ù„Ø§ØªØ¬Ø§Ù‡   â”‚ Ø§Ù„Ø­Ø§Ù„Ø©     â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ ÙƒØ´Ø±ÙŠ   â”‚ 18-25 Ø¯ÙŠØ³â”‚ 45      â”‚ 1,050    â”‚ â—€ Ù„Ù„ØªØ§Ø¬Ø± â”‚ âœ… Ù…Ø¯ÙÙˆØ¹   â”‚   â”‚
â”‚  â”‚ Ø¨ÙŠØªØ²Ø§  â”‚ 18-25 Ø¯ÙŠØ³â”‚ 32      â”‚ 840      â”‚ â–¶ Ù„Ù„Ù…Ù†ØµØ© â”‚ â³ Ù…Ø¹Ù„Ù‚   â”‚   â”‚
â”‚  â”‚ Ø³ÙˆØ¨Ø±   â”‚ 18-25 Ø¯ÙŠØ³â”‚ 78      â”‚ 1,890    â”‚ âš–ï¸ Ù…ØªÙˆØ§Ø²Ù†â”‚ ğŸ”„ Ø¬Ø²Ø¦ÙŠ   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. ØµÙØ­Ø© Ø§Ù„ØªØ³ÙˆÙŠØ§Øª Ù„Ù„Ø£Ø¯Ù…Ù† (Settlements)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ³ÙˆÙŠØ§Øª                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [Ø¥Ù†Ø´Ø§Ø¡ ØªØ³ÙˆÙŠØ§Øª â–¼] [ØªØ³ÙˆÙŠØ© Ù…Ø®ØµØµØ©] [Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„ØªØ³ÙˆÙŠØ©]         [ØªØ­Ø¯ÙŠØ«]      â”‚
â”‚  â””â”€ ÙŠÙˆÙ…ÙŠ/3 Ø£ÙŠØ§Ù…/Ø£Ø³Ø¨ÙˆØ¹ÙŠ                                                  â”‚
â”‚  âš ï¸ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ³ÙˆÙŠØ§Øª ÙÙ‚Ø· Ù„Ù„Ù…Ø²ÙˆØ¯ÙŠÙ† ÙÙŠ Ù…Ù†Ø·Ù‚ØªÙƒ                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“ [Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© â–¼] [Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© â–¼]  ğŸ” [Ø¨Ø­Ø«...]  ğŸ“Š [Ø§Ù„Ø­Ø§Ù„Ø© â–¼]               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â”‚
â”‚  â•‘  ğŸ’š Ù…Ø¯ÙÙˆØ¹: 45,000 Ø¬.Ù…    ğŸ”´ Ù…ØªØ£Ø®Ø±: 5,000 Ø¬.Ù…    ğŸŸ¡ Ù…Ø¹Ù„Ù‚: 12,000  â•‘   â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Ø§Ù„Ù…Ø²ÙˆØ¯      â”‚ Ø§Ù„ÙØªØ±Ø©    â”‚ ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨Ø§Øª     â”‚ ğŸ’° Ø§Ù„Ù…Ø³ØªØ­Ù‚  â”‚ Ø§Ù„Ø­Ø§Ù„Ø© â”‚  â”‚
â”‚  â”‚             â”‚           â”‚ COD â”‚ Online   â”‚             â”‚        â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ ğŸª ÙƒØ´Ø±ÙŠ    â”‚ 18-25 Ø¯ÙŠØ³ â”‚ 20  â”‚ 25       â”‚ â—€ 2,100    â”‚ â³     â”‚  â”‚
â”‚  â”‚ Ø§Ù„Ø­Ø³ÙŠÙ†     â”‚           â”‚     â”‚          â”‚ Ù„Ù„ØªØ§Ø¬Ø±     â”‚        â”‚  â”‚
â”‚  â”‚ ğŸ“ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© â”‚           â”‚     â”‚          â”‚             â”‚ [ØªØ£ÙƒÙŠØ¯]â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ ğŸ• Ø¨ÙŠØªØ²Ø§   â”‚ 18-25 Ø¯ÙŠØ³ â”‚ 30  â”‚ 2        â”‚ â–¶ 450      â”‚ â³     â”‚  â”‚
â”‚  â”‚ Ù‡Øª         â”‚           â”‚     â”‚          â”‚ Ù„Ù„Ù…Ù†ØµØ©     â”‚        â”‚  â”‚
â”‚  â”‚ ğŸ“ Ø§Ù„Ø¬ÙŠØ²Ø©  â”‚           â”‚     â”‚          â”‚             â”‚ [ØªØ­ØµÙŠÙ„]â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚  ğŸ“Œ Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø£Ø²Ø±Ø§Ø± ØªØªØºÙŠØ± Ø­Ø³Ø¨ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØªØ³ÙˆÙŠØ©:                           â”‚
â”‚  â€¢ "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹" â† Ø¹Ù†Ø¯Ù…Ø§ Ø§Ù„Ù…Ù†ØµØ© ØªØ¯ÙØ¹ Ù„Ù„ØªØ§Ø¬Ø±                            â”‚
â”‚  â€¢ "ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ØµÙŠÙ„" â† Ø¹Ù†Ø¯Ù…Ø§ Ø§Ù„ØªØ§Ø¬Ø± ÙŠØ¯ÙØ¹ Ù„Ù„Ù…Ù†ØµØ©                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. ØµÙØ­Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ù„Ù„Ø£Ø¯Ù…Ù† (Analytics) - Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª

```
Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¬ÙŠØ¯Ø© âœ… - ØªØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø·ÙÙŠÙØ©:

1. Ø¥Ø¶Ø§ÙØ© ØªØ­Ù„ÙŠÙ„ Ù…Ø§Ù„ÙŠ:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ğŸ’° Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠ                        â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ â€¢ Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ­ØµÙŠÙ„: 95%                     â”‚
   â”‚ â€¢ Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„ØªØ³ÙˆÙŠØ©: 3 Ø£ÙŠØ§Ù…             â”‚
   â”‚ â€¢ Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª: 2.5%                  â”‚
   â”‚ â€¢ Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ (Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª): 7%             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. Ø¥Ø¶Ø§ÙØ© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…Ø§Ù„ÙŠ:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ğŸ“ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚                         â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©: 60% Ù…Ù† Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª               â”‚
   â”‚ Ø§Ù„Ø¬ÙŠØ²Ø©: 25% Ù…Ù† Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª                â”‚
   â”‚ Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©: 15% Ù…Ù† Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©
```

---

## ğŸ” Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØ§Ù„ÙÙ„ØªØ±Ø©

### Ù…ØµÙÙˆÙØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª

| Ø§Ù„Ø¯ÙˆØ± | Finance | Settlements | Analytics | Generate | Record Payment |
|-------|---------|-------------|-----------|----------|----------------|
| **Super Admin** | âœ… Ø§Ù„ÙƒÙ„ | âœ… Ø§Ù„ÙƒÙ„ | âœ… Ø§Ù„ÙƒÙ„ | âœ… Ø§Ù„ÙƒÙ„ | âœ… Ø§Ù„ÙƒÙ„ |
| **Regional Manager** | ğŸ“ Ù…Ù†Ø·Ù‚ØªÙ‡ | ğŸ“ Ù…Ù†Ø·Ù‚ØªÙ‡ | ğŸ“ Ù…Ù†Ø·Ù‚ØªÙ‡ | ğŸ“ Ù…Ù†Ø·Ù‚ØªÙ‡ | ğŸ“ Ù…Ù†Ø·Ù‚ØªÙ‡ |
| **Finance Admin** | âœ… Ø§Ù„ÙƒÙ„ | âœ… Ø§Ù„ÙƒÙ„ | âœ… Ø§Ù„ÙƒÙ„ | âœ… Ø§Ù„ÙƒÙ„ | âœ… Ø§Ù„ÙƒÙ„ |
| **Analyst** | ğŸ‘ï¸ Ø¹Ø±Ø¶ | ğŸ‘ï¸ Ø¹Ø±Ø¶ | âœ… Ø§Ù„ÙƒÙ„ | âŒ | âŒ |
| **Viewer** | ğŸ‘ï¸ Ø¹Ø±Ø¶ | ğŸ‘ï¸ Ø¹Ø±Ø¶ | ğŸ‘ï¸ Ø¹Ø±Ø¶ | âŒ | âŒ |

### ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©

```typescript
// ÙÙŠ ÙƒÙ„ ØµÙØ­Ø© Ø£Ø¯Ù…Ù† Ù…Ø§Ù„ÙŠØ©:

import { useRegionFilter } from '@/lib/contexts/AdminRegionContext'
import { usePermissions } from '@/lib/permissions/use-permissions'

function AdminFinancePage() {
  const {
    isSuperAdmin,
    isRegionalAdmin,
    allowedGovernorateIds,
    regionProviderIds,
    applyProviderFilter
  } = useRegionFilter()

  const { can, canSync } = usePermissions()

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
  useEffect(() => {
    if (!canSync('finance', 'view')) {
      router.push('/admin/unauthorized')
    }
  }, [])

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ù„ÙÙ„ØªØ±Ø©
  const loadData = async () => {
    let query = supabase.from('settlements').select('*')

    // âš ï¸ Ù…Ù‡Ù…: ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø© Ù…Ù† Ø§Ù„Ù€ query ÙˆÙ„ÙŠØ³ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    if (isRegionalAdmin && regionProviderIds.length > 0) {
      query = query.in('provider_id', regionProviderIds)
    } else if (!isSuperAdmin && allowedGovernorateIds.length > 0) {
      // Ù„Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
      const providerIds = await getProvidersByGovernorates(allowedGovernorateIds)
      query = query.in('provider_id', providerIds)
    }

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ø§Ù„Ù…Ø®ØªØ§Ø±
    if (geoFilter.governorate_id || geoFilter.city_id) {
      query = applyProviderFilter(query, 'provider_id')
    }

    const { data } = await query
    return data
  }
}
```

---

## ğŸ”„ Ø§Ù†Ø³ÙŠØ§Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†

### Workflow: Ø¥Ù†Ø´Ø§Ø¡ ØªØ³ÙˆÙŠØ©

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Admin Action   â”‚â”€â”€â”€â”€â–¶â”‚   Database       â”‚â”€â”€â”€â”€â–¶â”‚  Provider View   â”‚
â”‚  Ø¥Ù†Ø´Ø§Ø¡ ØªØ³ÙˆÙŠØ©     â”‚     â”‚  Settlement      â”‚     â”‚  ÙŠØ±Ù‰ Ø§Ù„ØªØ³ÙˆÙŠØ©     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                        â”‚                        â”‚
         â”‚                        â”‚                        â”‚
         â–¼                        â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Notification   â”‚â”€â”€â”€â”€â–¶â”‚   Realtime Sub   â”‚â”€â”€â”€â”€â–¶â”‚  Auto Refresh    â”‚
â”‚  Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„ØªØ§Ø¬Ø±    â”‚     â”‚  postgres_changesâ”‚     â”‚  ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Realtime Subscription Ù„Ù„ØªØ§Ø¬Ø±

```typescript
// Provider Finance Page
useEffect(() => {
  if (!providerId) return

  const subscription = supabase
    .channel('provider-settlements')
    .on('postgres_changes', {
      event: '*',
      schema: 'public',
      table: 'settlements',
      filter: `provider_id=eq.${providerId}`
    }, (payload) => {
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      if (payload.eventType === 'INSERT') {
        toast.info('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØªØ³ÙˆÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©')
      } else if (payload.eventType === 'UPDATE') {
        toast.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³ÙˆÙŠØ©')
      }
      loadFinanceData()
    })
    .subscribe()

  return () => subscription.unsubscribe()
}, [providerId])
```

---

## ğŸ“ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©

### Ù…Ù„ÙØ§Øª ØªØ­ØªØ§Ø¬ ØªØ¹Ø¯ÙŠÙ„

| Ø§Ù„Ù…Ù„Ù | Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© | Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© |
|-------|-------------------|----------|
| `src/app/[locale]/admin/finance/page.tsx` | Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ ÙƒØ§Ù…Ù„Ø© | ğŸ”´ Ø¹Ø§Ù„ÙŠØ© |
| `src/app/[locale]/admin/settlements/page.tsx` | ØªØµØ­ÙŠØ­ Ø§Ù„ÙÙ„ØªØ±Ø© + Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª | ğŸ”´ Ø¹Ø§Ù„ÙŠØ© |
| `src/app/[locale]/admin/settlements/[id]/page.tsx` | ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø¹Ø±Ø¶ Ù…Ø¹ Ø§Ù„ØªØ§Ø¬Ø± | ğŸŸ¡ Ù…ØªÙˆØ³Ø·Ø© |
| `src/app/[locale]/provider/finance/page.tsx` | Realtime + ØªÙˆØ­ÙŠØ¯ | ğŸŸ¡ Ù…ØªÙˆØ³Ø·Ø© |
| `src/lib/contexts/AdminRegionContext.tsx` | ØªØ­Ø³ÙŠÙ†Ø§Øª | ğŸŸ¢ Ù…Ù†Ø®ÙØ¶Ø© |

### Ù…Ù„ÙØ§Øª Ø¬Ø¯ÙŠØ¯Ø©

| Ø§Ù„Ù…Ù„Ù | Ø§Ù„ØºØ±Ø¶ |
|-------|-------|
| `src/lib/finance/money.ts` | ğŸ’° Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Ø¨Ø§Ù„Ù‚Ø±ÙˆØ´) |
| `src/lib/finance/financial-service.ts` | Ø®Ø¯Ù…Ø© Ù…Ø§Ù„ÙŠØ© Ù…ÙˆØ­Ø¯Ø© |
| `src/lib/finance/settlement-calculator.ts` | Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ØªØ³ÙˆÙŠØ© |
| `src/lib/finance/export-service.ts` | ØªØµØ¯ÙŠØ± PDF/Excel |
| `src/types/finance.ts` | Ø£Ù†ÙˆØ§Ø¹ Ù…ÙˆØ­Ø¯Ø© |
| `src/hooks/useFinancialData.ts` | Hook Ù…Ø´ØªØ±Ùƒ |
| `supabase/migrations/xxx_financial_settlement_engine.sql` | SQL View |
| `supabase/migrations/xxx_order_settlement_status.sql` | Ø­Ù‚Ù„ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³ÙˆÙŠØ© Ù„Ù„Ø·Ù„Ø¨Ø§Øª |
| `supabase/migrations/xxx_settlement_audit_log.sql` | Ø¬Ø¯ÙˆÙ„ Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ |

---

## ğŸ“‹ Ø®Ø·Ø© Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ø±Ø­Ù„ÙŠØ©

### Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª ÙˆØ§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªØ­ØªÙŠØ© âœ… (Ù…ÙƒØªÙ…Ù„Ø© - 25 Ø¯ÙŠØ³Ù…Ø¨Ø± 2025)

```
âœ… 1.1 Ø¥Ù†Ø´Ø§Ø¡ Money class Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Ø¨Ø§Ù„Ù‚Ø±ÙˆØ´)
     â†’ src/lib/finance/money.ts
âœ… 1.2 Ø¥Ù†Ø´Ø§Ø¡ financial_settlement_engine SQL View
     â†’ supabase/migrations/20251225100000_financial_settlement_engine.sql
âœ… 1.3 Ø¥Ù†Ø´Ø§Ø¡ FinancialService class (ÙŠØ³ØªØ®Ø¯Ù… Money class)
     â†’ src/lib/finance/financial-service.ts
âœ… 1.4 Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ÙˆØ­Ø¯Ø© (types/finance.ts)
     â†’ src/types/finance.ts
âœ… 1.5 Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ settlement_status Ù„Ù„Ø·Ù„Ø¨Ø§Øª + Migration
     â†’ orders.settlement_status, orders.hold_reason, orders.hold_until
âœ… 1.6 Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ settlement_audit_log + Triggers
     â†’ settlement_audit_log table + trg_settlement_audit trigger
âœ… 1.7 Ø¥Ù†Ø´Ø§Ø¡ React Hooks Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
     â†’ src/hooks/useFinancialData.ts
```

**Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (25 Ø¯ÙŠØ³Ù…Ø¨Ø± 2025):**
- âœ… Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 1: COD Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ - ØµØ­ÙŠØ­
- âœ… Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 2: ÙØªØ±Ø© Ø§Ù„Ø³Ù…Ø§Ø­ - ØµØ­ÙŠØ­
- âœ… Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 3: Ù…Ø±ØªØ¬Ø¹ ÙƒÙ„ÙŠ - ØµØ­ÙŠØ­ (Ø§Ù„ØªÙˆØµÙŠÙ„ Ù„Ø§ ÙŠÙØ³ØªØ±Ø¯)
- âœ… Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 4: Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ - ØµØ­ÙŠØ­ (319 Ø¬.Ù…)
- âœ… Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 5: Ù…ÙŠØ²Ø§Ù† Ù…ØªÙ‚Ø§Ø·Ø¹ - ØµØ­ÙŠØ­ (platform_pays_provider)

### Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: ØµÙØ­Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† âœ… (Ù…ÙƒØªÙ…Ù„Ø© - 25 Ø¯ÙŠØ³Ù…Ø¨Ø± 2025)

```
âœ… 2.1 ØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© Admin Finance Ù…Ø¹ Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
     â†’ Ø§Ø³ØªØ®Ø¯Ø§Ù… useAdminFinancialData hook
     â†’ Ø¹Ø±Ø¶ COD vs Online breakdown
     â†’ Ø¹Ø±Ø¶ Settlement Direction
     â†’ Ø¹Ø±Ø¶ Grace Period discount
âœ… 2.2 ØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© Admin Settlements Ù…Ø¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
     â†’ Ø¥Ø¶Ø§ÙØ© ÙÙ„ØªØ± settlement_status Ù„Ù„Ø·Ù„Ø¨Ø§Øª
     â†’ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¥Ù„Ù‰ settled Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ³ÙˆÙŠØ©
âœ… 2.3 Ø¥Ø¶Ø§ÙØ© ØªØ­Ù‚Ù‚ settlement_status Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ³ÙˆÙŠØ©
     â†’ ÙÙ‚Ø· Ø§Ù„Ø·Ù„Ø¨Ø§Øª eligible Ø£Ùˆ null ØªØ¯Ø®Ù„ Ø§Ù„ØªØ³ÙˆÙŠØ©
     â†’ Ø§Ù„Ø·Ù„Ø¨Ø§Øª on_hold Ø£Ùˆ excluded Ù…Ø³ØªØ¨Ø¹Ø¯Ø©
â–¡ 2.4 Ø¥Ø¶Ø§ÙØ© ØªÙ†Ø¨ÙŠÙ‡ "Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©" ÙÙŠ ØµÙØ­Ø© Ø§Ù„ØªØ³ÙˆÙŠØ§Øª
âœ… 2.5 Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Audit Trail ÙÙŠ ØµÙØ­Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ³ÙˆÙŠØ©
     â†’ Ù‚Ø³Ù… Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø·ÙŠ Ù…Ø¹ Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
     â†’ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„: Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø§Ù„Ù…Ø¨Ù„Øº
```

### Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø§Ù„ØªØ²Ø§Ù…Ù† ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª âœ… (Ø´Ø¨Ù‡ Ù…ÙƒØªÙ…Ù„Ø© - 25 Ø¯ÙŠØ³Ù…Ø¨Ø± 2025)

```
âœ… 3.1 ØªÙˆØ­ÙŠØ¯ Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ØªØ³ÙˆÙŠØ© Ø¨ÙŠÙ† Admin Ùˆ Provider
     â†’ Ø§Ø³ØªØ®Ø¯Ø§Ù… financial_settlement_engine ÙƒÙ…ØµØ¯Ø± Ù…ÙˆØ­Ø¯
âœ… 3.2 Ø¥Ø¶Ø§ÙØ© Realtime subscriptions Ù„Ù„ØªØ§Ø¬Ø±
     â†’ provider/finance/page.tsx ÙŠØ³ØªÙ…Ø¹ Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ØªØ³ÙˆÙŠØ§Øª
â–¡ 3.3 Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØªØºÙŠÙŠØ± Ø§Ù„ØªØ³ÙˆÙŠØ© (toast notifications)
âœ… 3.4 ØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ³ÙˆÙŠØ© (Admin + Provider)
     â†’ Ø¹Ø±Ø¶ Audit Trail + PDF Export
âœ… 3.5 Trigger Ù„ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ù†Ø¯ ÙØªØ­ Ù†Ø²Ø§Ø¹
     â†’ hold_order_on_refund_request trigger
```

### Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± âœ… (Ø´Ø¨Ù‡ Ù…ÙƒØªÙ…Ù„Ø© - 25 Ø¯ÙŠØ³Ù…Ø¨Ø± 2025)

```
âœ… 4.1 Ø¥Ø¶Ø§ÙØ© ØªØµØ¯ÙŠØ± PDF Ù„Ù„ØªØ³ÙˆÙŠØ§Øª
     â†’ src/lib/finance/export-service.ts
     â†’ Ø²Ø± ØªØµØ¯ÙŠØ± PDF ÙÙŠ ØµÙØ­Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ³ÙˆÙŠØ©
âœ… 4.2 Ø¥Ø¶Ø§ÙØ© ØªØµØ¯ÙŠØ± CSV Ù„Ù„ØªØ³ÙˆÙŠØ§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
     â†’ exportSettlementsToCSV function
â–¡ 4.3 ØªØ­Ø³ÙŠÙ† ØµÙØ­Ø© Analytics Ø§Ù„Ù…Ø§Ù„ÙŠØ©
â–¡ 4.4 ØªØµØ¯ÙŠØ± Audit Trail Ù…Ù†ÙØµÙ„
```

### Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5: Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ§Ù„ØªÙˆØ«ÙŠÙ‚

```
â–¡ 5.1 ÙƒØªØ§Ø¨Ø© Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù„Ù„Ù€ Money class (floating point)
â–¡ 5.2 ÙƒØªØ§Ø¨Ø© Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
â–¡ 5.3 Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØ§Ù„ÙÙ„ØªØ±Ø©
â–¡ 5.4 Ø§Ø®ØªØ¨Ø§Ø± Hold Status Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªÙ†Ø§Ø²Ø¹ Ø¹Ù„ÙŠÙ‡Ø§
â–¡ 5.5 Ø§Ø®ØªØ¨Ø§Ø± Audit Trail
â–¡ 5.6 Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ²Ø§Ù…Ù† Ø¨ÙŠÙ† Admin Ùˆ Provider
â–¡ 5.7 ØªÙˆØ«ÙŠÙ‚ API ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
```

---

## âœ… Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù‚Ø¨ÙˆÙ„

### 1. ØªÙ†Ø§Ø³Ù‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
- [x] `net_payout` Ù…ØªØ·Ø§Ø¨Ù‚ ÙÙŠ Admin Ùˆ Provider âœ… (financial_settlement_engine)
- [x] Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù…ÙˆØ­Ø¯ âœ… (calculate_commission trigger)
- [x] Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ Ù…Ø¹Ø±ÙˆØ¶Ø© Ø¨ÙˆØ¶ÙˆØ­ ÙƒØ­Ù‚ Ù„Ù„ØªØ§Ø¬Ø± âœ… (Ù…Ø­Ø±Ùƒ Ø§Ù„ØªØ³ÙˆÙŠØ©)

### 2. Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
- [ ] Regional Manager ÙŠØ±Ù‰ ÙÙ‚Ø· Ù…Ù†Ø·Ù‚ØªÙ‡
- [ ] Generate Settlements ÙŠØ­ØªØ±Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
- [ ] Record Payment ÙŠØªØ·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ© `finance.settle`

### 3. Ø§Ù„ÙÙ„ØªØ±Ø©
- [x] Ø§Ù„ÙÙ„ØªØ±Ø© ØªØ·Ø¨Ù‚ Ù…Ù† Ø§Ù„Ù€ query âœ… (financial_settlement_engine ÙŠØ¯Ø¹Ù… governorate_id)
- [x] Ø§Ù„Ù€ stats ØªØ­Ø³Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø© âœ…
- [ ] Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø±Ø¨Ø©

### 4. Ø§Ù„ØªØ²Ø§Ù…Ù†
- [x] Ø§Ù„ØªØ§Ø¬Ø± ÙŠØ±Ù‰ Ø§Ù„ØªØ³ÙˆÙŠØ© ÙÙˆØ± Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§ âœ… (Realtime subscription)
- [ ] Ø§Ù„ØªØ§Ø¬Ø± ÙŠØªÙ„Ù‚Ù‰ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©
- [x] Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù…ØªØ·Ø§Ø¨Ù‚Ø© ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ âœ… (Ù†ÙØ³ SQL View)

### 5. Ø§Ù„ØªØµØ¯ÙŠØ±
- [x] PDF ÙŠØ­ØªÙˆÙŠ ÙƒÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ âœ… (exportSettlementToPDF)
- [x] CSV ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ù… âœ… (exportSettlementsToCSV)
- [x] Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ø­ØªØ±Ø§ÙÙŠ âœ… (RTL + Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„Ù„ØºØ©)

### 6. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Floating Point) ğŸ’°
- [x] ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ØªØ³ØªØ®Ø¯Ù… `Money` class Ø£Ùˆ `decimal.js` âœ…
- [x] Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø¨Ø§Ù„Ù‚Ø±ÙˆØ´ (integers) Ø£Ùˆ `DECIMAL(12,2)` ÙÙŠ DB âœ…
- [x] Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ ØªÙ‚Ø±ÙŠØ¨ ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª âœ…
- [ ] Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù„Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ© (0.1 + 0.2 = 0.3)

### 7. Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© (Hold Status) âš–ï¸
- [x] Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªÙ†Ø§Ø²Ø¹ Ø¹Ù„ÙŠÙ‡Ø§ Ù„Ø§ ØªØ¯Ø®Ù„ Ø§Ù„ØªØ³ÙˆÙŠØ§Øª âœ… (settlement_status)
- [x] Ø­Ù‚Ù„ `settlement_status` Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø¬Ø¯ÙˆÙ„ `orders` âœ…
- [x] Trigger ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Ø·Ù„Ø¨ Ø§Ø³ØªØ±Ø¯Ø§Ø¯ âœ… (hold_order_on_refund_request)
- [ ] Ø§Ù„Ø£Ø¯Ù…Ù† ÙŠØ±Ù‰ ØªÙ†Ø¨ÙŠÙ‡ "Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©" Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ³ÙˆÙŠØ©

### 8. Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ (Audit Trail) ğŸ“‹
- [x] ÙƒÙ„ ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„ØªØ³ÙˆÙŠØ© Ù…Ø³Ø¬Ù„ âœ… (settlement_audit_log)
- [x] ØªØ³Ø¬ÙŠÙ„: Ù…Ù†ØŒ Ù…ØªÙ‰ØŒ Ù…Ø§Ø°Ø§ØŒ Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ âœ…
- [x] Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ ØµÙØ­Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ³ÙˆÙŠØ© âœ… (Ù‚Ø³Ù… Audit Trail Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø·ÙŠ)
- [x] Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ âœ… (Ø¬Ø¯ÙˆÙ„ Ù…Ù†ÙØµÙ„ Ø¨Ø¯ÙˆÙ† DELETE policy)

---

## ğŸ”— Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹

- [FINANCIAL_SYSTEM_REBUILD_PLAN.md](./FINANCIAL_SYSTEM_REBUILD_PLAN.md) - Ø®Ø·Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠ Ù„Ù„ØªØ§Ø¬Ø±
- [src/types/permissions.ts](../src/types/permissions.ts) - Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
- [src/lib/contexts/AdminRegionContext.tsx](../src/lib/contexts/AdminRegionContext.tsx) - Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©

---

**ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·Ø© Ø¨ÙˆØ§Ø³Ø·Ø©**: Claude Code Review Agent
**ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«**: 25 Ø¯ÙŠØ³Ù…Ø¨Ø± 2025
**Ø§Ù„Ø¥ØµØ¯Ø§Ø±**: 1.4 (Ø§Ù„Ù…Ø±Ø§Ø­Ù„ 1-4 Ø´Ø¨Ù‡ Ù…ÙƒØªÙ…Ù„Ø©)
