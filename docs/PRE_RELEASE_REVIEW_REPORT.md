# ุชูุฑูุฑ ูุฑุงุฌุนุฉ ูุง ูุจู ุงููุดุฑ ุนูู Google Play

## Engezna - Pre-Release Deep Review Report

**ุชุงุฑูุฎ ุงููุฑุงุฌุนุฉ:** 2026-02-12
**ูุทุงู ุงููุฑุงุฌุนุฉ:** ุฃูุงูุ ุฌูุฏุฉ ุงูููุฏุ ุงูุชุฏููุงุช ุงูุชุฌุงุฑูุฉุ ุฌุงูุฒูุฉ Capacitor/Google Play
**ุงูุญุงูุฉ:** ุชูุฑูุฑ ุดุงูู - ูุชุทูุจ ุฅุฌุฑุงุกุงุช ูุจู ุงููุดุฑ

---

## โ๏ธ ุชูุจูู ููู: ุณูุงุณุฉ ุงูุชุนุงูู ูุน Supabase ููุงุนุฏุฉ ุงูุจูุงูุงุช

> **ูุงุนุฏุฉ ุตุงุฑูุฉ:** ูุฐุง ุงูุชูุฑูุฑ ูุจูู ุนูู ูุฑุงุฌุนุฉ **ููุฏ ุงููุดุฑูุน ููุท** (migrationsุ typesุ API routes).
> ูู ูุง ูุฎุต ุญุงูุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุนููุฉ (ุงูุฌุฏุงููุ ุงูุฃุนูุฏุฉุ ุงูุณูุงุณุงุชุ ุงูู RLSุ ุงูู triggersุ ุงูู functions) **ูุง ูููู ุงูุชุฃูุฏ ููู ุจูุณุจุฉ 100%** ูู ุงูููุฏ ูุญุฏู.
>
> **ูุฐูู:**
>
> - ูุง ูุฌุจ ุงูุชุฑุงุถ ุฃู migrations ุชู ุชุทุจูููุง ุจุงููุนู ุนูู ูุงุนุฏุฉ ุงูุฅูุชุงุฌ
> - ูุง ูุฌุจ ุงูุชุฑุงุถ ุฃู RLS policies ุชุนูู ููุง ูู ูุชููุน ุจุฏูู ูุญุต ูุจุงุดุฑ
> - ูุง ูุฌุจ ุงูุชุฑุงุถ ูุฌูุฏ ุฃู ุนุฏู ูุฌูุฏ ุฃุนูุฏุฉ/ุฌุฏุงูู/constraints ุจุฏูู ุงุณุชุนูุงู
>
> **ุงูุจุฑูุชูููู ุงููุทููุจ ูุจู ุชูููุฐ ุฃู ูููุฉ ุชุชุนูู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช:**
>
> 1. Claude ููุชุจ ุงุณุชุนูุงูุงุช SQL ูููุญุต ูุงูุชุญูู
> 2. ุงููุงูู ูููุฐูุง ุนูู Supabase SQL Editor
> 3. ุงููุงูู ูุดุงุฑู ุงููุชุงุฆุฌ ูุน Claude
> 4. Claude ูุญูู ููุจูู ูุฑุงุฑุงุชู ุนูู **ุจูุงูุงุช ุญููููุฉ** ูููุณ ุงูุชุฑุงุถุงุช
>
> **ุฃูุซูุฉ ุนูู ุงุณุชุนูุงูุงุช ุณุชููู ูุทููุจุฉ ูุจู ุจุฏุก ุงูุนูู:**
>
> ```sql
> -- ูุญุต ุงูุฌุฏุงูู ุงูููุฌูุฏุฉ ูุนููุงู
> SELECT table_name FROM information_schema.tables WHERE table_schema = 'public';
>
> -- ูุญุต ุฃุนูุฏุฉ ุฌุฏูู ูุนูู
> SELECT column_name, data_type, is_nullable, column_default
> FROM information_schema.columns WHERE table_name = 'orders';
>
> -- ูุญุต ุณูุงุณุงุช RLS ุงูููุนูุฉ
> SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual
> FROM pg_policies WHERE schemaname = 'public';
>
> -- ูุญุต ุงูู constraints
> SELECT conname, contype, conrelid::regclass
> FROM pg_constraint WHERE conrelid = 'orders'::regclass;
>
> -- ูุญุต ุงูู triggers ุงูููุนูุฉ
> SELECT trigger_name, event_manipulation, action_statement
> FROM information_schema.triggers WHERE trigger_schema = 'public';
>
> -- ูุญุต ุงูู cron jobs ุงููุณุฌูุฉ
> SELECT * FROM cron.job;
> ```
>
> **ูุฐุง ุงูุจุฑูุชูููู ูุถูู ุนุฏู:**
>
> - ุฅูุดุงุก migration ูุฌุฏูู ููุฌูุฏ ุจุงููุนู
> - ุฅุถุงูุฉ constraint ููุฑุฑ
> - ุชุนุฏูู ุณูุงุณุฉ RLS ุจูุงุกู ุนูู ุงูุชุฑุงุถ ุฎุงุทุฆ
> - ุชุฌุงูู ูุดููุฉ ูุนููุฉ ูุฃู ุงูููุฏ ูุจุฏู ุณูููุงู

---

## ููุฎุต ุชูููุฐู

ุจุนุฏ ูุฑุงุฌุนุฉ ูุนููุฉ ูุฎุงุฑุทุฉ ุทุฑูู ุงููุดุฑ (`GOOGLE_PLAY_RELEASE_ROADMAP.md`) ููุงูู ุงูููุฏุ ุชู ุชุญุฏูุฏ **ููุงู ุญุฑุฌุฉ ูุฌุจ ุชูููุฐูุง** ูุจู ุงุณุชููุงู ุฑุญูุฉ ุงููุดุฑ. ุงููุฑุงุญู 0 ู 1 ููุชููุฉ ุจูุฌุงุญุ ููู ููุงู ูุดุงูู ููุชุดูุฉ ูู ุงูุชุฏููุงุช ุงูุชุฌุงุฑูุฉ ุงูุฃุณุงุณูุฉ ููุฌูุงุช ุฃูููุฉ ุชุญุชุงุฌ ูุนุงูุฌุฉ.

### ุงูุชูููู ุงูุนุงู

| ุงูุฌุงูุจ             | ุงูุชูููู | ููุงุญุธุงุช                                 |
| ------------------ | ------- | --------------------------------------- |
| ุงูุฃูุงู             | B+      | ุฌูุฏ ูุน ุซุบุฑุงุช ูุชูุณุทุฉ ุชุญุชุงุฌ ุฅุตูุงุญ         |
| ุฌูุฏุฉ ุงูููุฏ         | A-      | ููุชุงุฒ ูุน ูููุงุช ูุจูุฑุฉ ุชุญุชุงุฌ ุชูุณูู        |
| ุงูุชุฏููุงุช ุงูุชุฌุงุฑูุฉ  | B       | ููุชููุฉ ูููููุงู ูุน ุญุงูุงุช ุญุฏูุฉ ุบูุฑ ูุนุงูุฌุฉ |
| ุฌุงูุฒูุฉ Capacitor   | C+      | ุฃุณุงุณ PWA ููุชุงุฒุ ุฅุนุฏุงุฏ Capacitor ูู ูุจุฏุฃ |
| ุฌุงูุฒูุฉ Google Play | D       | ูู ูุจุฏุฃ (ุงููุฑุญูุฉ 3-6 ูู ุงูุฎุงุฑุทุฉ)        |

---

## ุงููุณู ุงูุฃูู: ูุดุงูู ุญุฑุฌุฉ ูุฌุจ ุญููุง ููุฑุงู (Priority: CRITICAL)

### 1.0 ๐ด๐ด ุชุณุฑูุจ Service Role Key ูู Triggers (ุงูุฃุนูู ุฎุทูุฑุฉ - ูุคูุฏ ูู SQL ุญูููู)

**ุงููุตุฏุฑ:** ูุชุงุฆุฌ SQL ูุจุงุดุฑุฉ ูู ูุงุนุฏุฉ ุงูุฅูุชุงุฌ (2026-02-12)
**ุงูุญุงูุฉ:** ูุคูุฏ 100% - ููุณ ุงูุชุฑุงุถุงู

**ุงููุดููุฉ:** 7 triggers ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุญูุฉ ุชุญุชูู ุนูู **Service Role JWT ููุชูุจ ุญุฑููุงู** ุฏุงุฎู `action_statement`:

| Trigger                        | ุงูุฌุฏูู          | ุงูููุน         |
| ------------------------------ | --------------- | ------------- |
| `new_review_notification`      | reviews         | INSERT        |
| `support_tickets_notification` | support_tickets | INSERT/UPDATE |
| `ticket_messages_notification` | ticket_messages | INSERT        |
| `new_order_notification`       | orders          | INSERT        |
| `refunds_notification`         | refunds         | INSERT/UPDATE |
| `order_status_notification`    | orders          | UPDATE        |
| `new_message_notification`     | chat_messages   | INSERT        |

ูู ูุฐู ุงูู triggers ุชุณุชุฎุฏู `supabase_functions.http_request()` ูุน Bearer token ุญุฑูู ููุซู ุงูู Service Role Key.

**ุงูุณุจุจ:** ุฃููุดุฆุช ุนุจุฑ **Supabase Dashboard โ Database Webhooks** ุงูุฐู ูุถุน ุงูู JWT ูู literal ุจุฏู ุงุณุชุฎุฏุงู `current_setting()`. ูููุงุช ุงูู migrations ูู ุงูููุฏ ุชุณุชุฎุฏู ุงูููุท ุงูุขูู `current_setting('supabase.service_role_key', true)` ููู ุงูู Dashboard ุชุฌุงูุฒ ุฐูู.

**ุงูุฎุทุฑ:**

- ุงูู Service Role Key ูุชุฎุทู **ูู ุณูุงุณุงุช RLS** ููุนุทู ุตูุงุญูุงุช ูุงููุฉ
- ุฃู ุดุฎุต ูุณุชุทูุน ูุฑุงุกุฉ `pg_trigger` (ุญุณุจ ุตูุงุญูุงุช DB) ูุญุตู ุนูู ุงูููุชุงุญ
- ุงูููุชุงุญ ูุณูุญ ุจูุฑุงุกุฉ/ูุชุงุจุฉ/ุญุฐู **ุฃู ุจูุงูุงุช** ูู ูู ุงูุฌุฏุงูู

**ููุงุญุธุฉ ูููุฉ:** ููุงู ุฃูุถุงู **triggers ููุฑุฑุฉ ุงููุธููุฉ** - ูุซูุงู:

- `new_order_notification` (ุบูุฑ ุขููุ webhook) + `on_new_order_notification` (ุขููุ PL/pgSQL function)
- ููุงููุง ูุนููุงู ุนูู ููุณ ุงูุญุฏุซ โ ุชูุฑุงุฑ ูู ุงูุฅุดุนุงุฑุงุช + ูุฎุงุทุฑ ุฃูููุฉ

**ุงูุฅุฌุฑุงุก ุงููุทููุจ (ุจุงูุชุฑุชูุจ):**

1. **ููุฑู:** ุญุฐู ุงูู 7 triggers ุบูุฑ ุงูุขููุฉ:

```sql
DROP TRIGGER IF EXISTS new_review_notification ON public.reviews;
DROP TRIGGER IF EXISTS support_tickets_notification ON public.support_tickets;
DROP TRIGGER IF EXISTS ticket_messages_notification ON public.ticket_messages;
DROP TRIGGER IF EXISTS new_order_notification ON public.orders;
DROP TRIGGER IF EXISTS refunds_notification ON public.refunds;
DROP TRIGGER IF EXISTS order_status_notification ON public.orders;
DROP TRIGGER IF EXISTS new_message_notification ON public.chat_messages;
```

2. **ููุฑู ุจุนุฏ ุงูุญุฐู:** ุนูู Rotate ููู Service Role Key ูู Supabase Dashboard:
   - Settings โ API โ Service Role Key โ Rotate
   - ุชุญุฏูุซ ูู ุงูุจูุฆุงุช ุงูุชู ุชุณุชุฎุฏู ุงูููุชุงุญ ุงููุฏูู (Vercel env vars, .env.local, etc.)

3. **ุชุญูู:** ุงูุชุฃูุฏ ุฃู ุงูู triggers ุงูุขููุฉ (ุงููุจุฏูุกุฉ ุจู `on_`) ุชุนูู ุจุดูู ุตุญูุญ ูุชุบุทู ูู ุงูุญุงูุงุช

4. **ููุน ุงูุชูุฑุงุฑ:** ุนุฏู ุงุณุชุฎุฏุงู Database Webhooks ูู ุงูู Dashboard ูุณุชูุจูุงู - ุงุณุชุฎุฏุงู migrations ููุท

---

### 1.1 ๐ด ุฎุทุฑ ุงูุทูุจุงุช ุงูููููุฉ (Phantom Orders) - ุงูุฏูุน ุงูุฅููุชุฑููู

**ุงููููุน:** `src/app/[locale]/checkout/page.tsx` (ุณุทุฑ 1016-1018)
**ุงููููุน:** `src/app/[locale]/orders/[id]/payment-result/page.tsx` (ุณุทุฑ 122-145)

**ุงููุดููุฉ:** ุนูุฏ ุงูุฏูุน ุงูุฅููุชุฑููู ุนุจุฑ Kashier:

- ุงูุทูุจ **ูุง ูููุดุฃ** ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฃุซูุงุก ุงูู checkout
- ุจูุงูุงุช ุงูุทูุจ ุชูุญูุธ ูุคูุชุงู ูู `localStorage` (`pendingOnlineOrderData`)
- ุงูุทูุจ ูููุดุฃ ููุท ุนูุฏ ุงูุนูุฏุฉ ูุตูุญุฉ ูุชูุฌุฉ ุงูุฏูุน ุฃู ุนุจุฑ ุงูู webhook

**ุงูุฎุทุฑ:**

- ุฅุฐุง ุฃุบูู ุงููุณุชุฎุฏู ุงููุชุตูุญ ุจุนุฏ ุงูุฏูุน ููุจู ุงูุนูุฏุฉ โ ุงูุทูุจ ูู ูููุดุฃ
- ุงูู webhook ุณูุตู ุจุฏูู ุทูุจ ููุงุจู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุฎุณุงุฑุฉ ุฅูุฑุงุฏุงุช + ุงุฑุชุจุงู ููุนููู

**ุงูุญู ุงูููุชุฑุญ:**

- ุฅูุดุงุก ุงูุทูุจ ุจุญุงูุฉ `pending_payment` **ูุจู** ุชูุฌูู ุงููุณุชุฎุฏู ูู Kashier
- ุฅุถุงูุฉ cron job ูุชูุธูู ุงูุทูุจุงุช ุงููุนููุฉ ุจุนุฏ 30 ุฏูููุฉ

---

### 1.2 ๐ด ุนุฏู ูุฌูุฏ ูุนุงูุฌุฉ ุงุณุชุฑุฌุงุน ูุงูู ูุนููุฉ (Refund API Missing)

**ุงููููุน:** `src/app/[locale]/admin/refunds/page.tsx`
**ุงููููุน:** `src/components/customer/support/RefundRequestModal.tsx`

**ุงููุดููุฉ:**

- ุงูุนููู ูุณุชุทูุน ุทูุจ ุงุณุชุฑุฌุงุน โ ุงูุฃุฏูู ููุงูู โ **ููู ุงููุงู ูุง ูุนูุฏ ููุนููู ูุนููุงู**
- ูุง ููุฌุฏ endpoint ูุชุตู ุจู Kashier Refund API
- ุงูุฃุฏูู ูุถุบุท "ุชูุช ุงููุนุงูุฌุฉ" ููู ูุง ุดูุก ูุญุฏุซ ูุนููุงู

**ุงูุญู ุงูููุชุฑุญ:**

- ุฅูุดุงุก `/api/payment/kashier/refund` endpoint ูุชุตู ุจู Kashier Refund API
- ุชุฎุฒูู `refund_transaction_id` ุนูุฏ ุฅุฑุณุงู ุงูุงุณุชุฑุฌุงุน
- ุฅุถุงูุฉ webhook handler ูุชุฃููุฏ ุงูุงุณุชุฑุฌุงุน ูู Kashier

---

### 1.3 ๐ด ุนุฏู ูุฌูุฏ ุญูุงูุฉ ูู ุงูุฏูุน ุงูููุฑุฑ (Duplicate Payment)

**ุงููููุน:** `src/app/api/payment/kashier/webhook/route.ts` (ุณุทุฑ 50-59)

**ุงููุดููุฉ:**

- ุงูู webhook ูุง ูุณุชุฎุฏู ููุชุงุญ idempotency
- ุฅุฐุง ุฃุฑุณู Kashier ููุณ ุงูู webhook ูุฑุชูู โ ูููู ูุนุงูุฌุฉ ูุฒุฏูุฌุฉ
- ูุง ููุฌุฏ unique constraint ุนูู `payment_transaction_id`

**ุงูุญู ุงูููุชุฑุญ:**

- ุฅุถุงูุฉ unique constraint ุนูู `payment_transaction_id` ูู ุฌุฏูู ุงูุทูุจุงุช
- ูุญุต ูุฌูุฏ ุงููุนุงููุฉ ูุจู ุงููุนุงูุฌุฉ (idempotency check)

---

### 1.4 ๐ด Edge Functions ุบูุฑ ููุดูุฑุฉ (Push Notifications ูู ุชุนูู ูุนููุงู)

**ุงููููุน:** ุฎุงุฑุทุฉ ุงูุทุฑูู - ุงููุฑุญูุฉ 1.7

**ุงููุดููุฉ (ูู ุงูุฎุงุฑุทุฉ ููุณูุง):**

- `send-notification` Edge Function **ุบูุฑ ููุดูุฑุฉ** ุนูู Supabase
- `handle-notification-trigger` Edge Function **ุบูุฑ ููุดูุฑุฉ**
- `FIREBASE_SERVICE_ACCOUNT` **ุบูุฑ ูุนุฏ** ูู Supabase Secret
- ุงูุฅุดุนุงุฑุงุช ุชูุณุฌู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ููู **ูุง ุชุตู ูุนููุงู** ููุฌูุงุฒ ุนุจุฑ FCM

**ุงูุญู:** ูุดุฑ Edge Functions ุญุณุจ `docs/EDGE_FUNCTIONS_DEPLOYMENT.md`

---

### 1.5 โ ~~Kashier Webhook ููุจู Payload ุจุฏูู Signature ุฅูุฒุงููุฉ~~ (ุชู ุงูุฅุตูุงุญ 2/13)

**ุงููููุน:** `src/app/api/payment/kashier/webhook/route.ts`

**ุชู ุงูุฅุตูุงุญ:** ุงูุชุญูู ูู ุงูุชูููุน ุฃุตุจุญ **ุฅูุฒุงููุงู** - ุฃู request ุจุฏูู signature ุตุงูุญุฉ ููุฑูุถ ููุฑุงู ุจู 403. ุชู ุงุณุชุจุฏุงู console.log ุจู logger.

---

### 1.6 โ ~~Promo Validation ูุซู ุจู user_id ูู ุงูุนููู~~ (ุชู ุงูุฅุตูุงุญ 2/13)

**ุงููููุน:** `src/app/api/promo/validate/route.ts`

**ุชู ุงูุฅุตูุงุญ:** ุญูุฐู `user_id` ูู body ุงูุทูุจ. ููุณุชุฎุฏู ุงูุขู `getUser()` ูู Supabase Auth ูุฌูุจ ูููุฉ ุงููุณุชุฎุฏู ุงููุนููุฉ ูู ุงูุฌูุณุฉ. ุฃู ุทูุจ ุจุฏูู session ุตุงูุญุฉ ููุฑูุถ ุจู 401.

---

## ุงููุณู ุงูุซุงูู: ูุดุงูู ุฃูููุฉ ุชุญุชุงุฌ ุฅุตูุงุญ (Priority: HIGH)

### 2.1 โ๏ธ ุญูุงูุฉ CSRF ูุจููุฉ ููู ุบูุฑ ููุนูุฉ

**ุงููููุน:** `src/lib/security/csrf.ts`

**ุงููุดููุฉ:**

- ูุธุงู CSRF ูุงูู ููุจูู (Double Submit Cookie pattern)
- `withCsrf` middleware wrapper ููุฌูุฏ
- **ูููู ุบูุฑ ูุทุจู ุนูู ุฃู API route ูุนููุงู**

**ุงูุญู:** ุชุทุจูู `withCsrf` ุนูู endpoints ุงูุชู ุชุบูุฑ ุงูุจูุงูุงุช (POST, PUT, DELETE)

---

### 2.2 โ๏ธ ~80+ console.log ูู ููุฏ ุงูุฅูุชุงุฌ

**ุงูููุงูุน ุงูุฃูุซุฑ ุชุฃุซูุฑุงู:**

- `src/lib/ai/agentTools.ts` - ุนุดุฑุงุช console.log
- `src/lib/ai/agentHandler.ts` - 15+ console.log
- `src/app/api/payment/kashier/webhook/route.ts` - 3 console.log (ุจูุงูุงุช ุฏูุน ุญุณุงุณุฉ!)
- `src/app/api/cron/settlements/route.ts` - 3 console.log
- `src/lib/email/resend.ts` - 5 console.log
- `src/hooks/useBadge.ts` - 4 console.log
- `src/components/customer/support/RefundRequestModal.tsx` - 4 console.log
- `src/app/[locale]/checkout/page.tsx` - console.log
- `src/app/api/admin/orders/route.ts` - console.log

**ุงูุฎุทุฑ:** ุชุณุฑูุจ ูุนูููุงุช ุญุณุงุณุฉ ูู ูุญุฏุฉ ุงูุชุญูู + ุฃุซุฑ ุนูู ุงูุฃุฏุงุก
**ุงูุญู:** ุงุณุชุจุฏุงู ุจู `src/lib/logger/index.ts` ุงูููุฌูุฏ ูุนูุงู ุฃู ุฅุฒุงูุชูุง

---

### 2.3 โ ~~Kashier credentials ุชุณุชุฎุฏู fallback ูุงุฑุบ~~ (ุชู ุงูุฅุตูุงุญ 2/13)

**ุงููููุน:** `src/lib/payment/kashier.ts`

**ุชู ุงูุฅุตูุงุญ:** ุงุณุชูุจุฏู `process.env.X || ''` ุจู getter functions ุชููู ุฎุทุฃ ูุงุถุญ (`throw new Error(...)`) ุฅุฐุง ุงููุชุบูุฑ ููููุฏ. ูุง ูุดู ุตุงูุช ุจุนุฏ ุงูุขู.

---

### 2.4 โ๏ธ ูุง ููุฌุฏ timeout ููุทูุจุงุช ุงููุนููุฉ ุจุงูุฏูุน

**ุงููุดููุฉ:** ูุง ููุฌุฏ cron job ูุญูู ุงูุทูุจุงุช ุฐุงุช `payment_status='pending'` ูู `failed` ุจุนุฏ ูุชุฑุฉ
**ุงูุฎุทุฑ:** ุงูุนููู ูุฑู "ููุฏ ุงูุงูุชุธุงุฑ" ููุฃุจุฏ ุฅุฐุง ูุดู ุงูู webhook ุจุตูุช
**ุงูุญู:** ุฅูุดุงุก cron job ูุนุงูุฌ ุงูุทูุจุงุช ุงููุนููุฉ ุจุนุฏ 30 ุฏูููุฉ

### 2.5 โ ~~ูุง ููุฌุฏ Content-Security-Policy (CSP) header~~ (ุชู ุงูุฅุตูุงุญ ุฌุฒุฆูุงู 2/13)

**ุงููููุน:** `next.config.ts`

**ุชู ุงูุฅุตูุงุญ:** ุฃูุถูู `Content-Security-Policy-Report-Only` header ุดุงูู ูุบุทู Supabase, Kashier, Firebase, HERE Maps, Sentry, Vercel. ูุนูู ูู ูุถุน report-only ุญุงููุงู. ูุญุชุงุฌ ุงุฎุชุจุงุฑ ุชูุงูู ุซู ุชุญููู ูู enforce.

---

### 2.6 โ๏ธ ุณูุงุณุงุช RLS SELECT ูุงุณุนุฉ ุฌุฏุงู (ูุคูุฏ - ูู ุชูุฑูุฑ Codex + SQL)

**ุงููุดููุฉ:** ุนุฏุฉ ุฌุฏุงูู ุชุณูุญ ุจุงููุฑุงุกุฉ ุงูุนุงูุฉ ุจุฏูู ุฃู ุดุฑุท:

| ุงูุฌุฏูู        | ุงูุณูุงุณุฉ        | ุงูุฎุทุฑ                           |
| ------------- | -------------- | ------------------------------- |
| `promo_codes` | `using (true)` | ุฃู ุดุฎุต ูุฑู ูู ุฃููุงุฏ ุงูุฎุตู       |
| `profiles`    | `using (true)` | ุจูุงูุงุช ุงููุณุชุฎุฏููู ููุดููุฉ ููุฌููุน |
| `reviews`     | `using (true)` | ููุจูู (ุนุฑุถ ุนุงู ุทุจูุนู)           |
| `categories`  | `using (true)` | ููุจูู (ุจูุงูุงุช ุนุงูุฉ)             |

**ุงูุญู:**

- `promo_codes`: ุชุถููู ูู `active = true AND valid_from <= now() AND valid_until >= now()`
- `profiles`: ุฅุฎูุงุก ุงูุฃุนูุฏุฉ ุงูุญุณุงุณุฉ (phone, email) ุนุจุฑ view ุฃู ุชุถููู ุงูู policy

---

## ุงููุณู ุงูุซุงูุซ: ููุงู ูู ุฎุงุฑุทุฉ ุงูุทุฑูู ูู ุชูููุฐ ุจุนุฏ

### ุงููุฑุญูุฉ 0 - ููุงู ูุชุจููุฉ:

| ุงููููุฉ                                                                        | ุงูุญุงูุฉ      |
| ----------------------------------------------------------------------------- | ----------- |
| ุชุดุบูู security tests: `npx playwright test comprehensive-e2e --grep SECURITY` | โฌ ูู ููููุฐ |

### ุงููุฑุญูุฉ 1 - ููุงู ูุชุจููุฉ:

| ุงููููุฉ                                                                  | ุงูุญุงูุฉ      |
| ----------------------------------------------------------------------- | ----------- |
| ุงุฎุชุจุงุฑ ุงูุตูุช ุนูู Chrome Android, Safari iOS, Chrome Desktop             | โฌ ูู ููููุฐ |
| ุงุฎุชุจุงุฑ FCM token generation ุนูู ุจูุฆุฉ staging                            | โฌ ูู ููููุฐ |
| ุฅุถุงูุฉ ุตูุช ูููุฒ ููุทูุจุงุช ุงูุฌุฏูุฏุฉ (persistent alert ุญุชู ููุจู ุงููุฒูุฏ)       | โฌ ูู ููููุฐ |
| ูุดุฑ `send-notification` Edge Function ุนูู Supabase                      | โฌ ูู ููููุฐ |
| ูุดุฑ `handle-notification-trigger` Edge Function ุนูู Supabase            | โฌ ูู ููููุฐ |
| ุฅุนุฏุงุฏ `FIREBASE_SERVICE_ACCOUNT` ูู Supabase Secret                     | โฌ ูู ููููุฐ |
| ุงุฎุชุจุงุฑ ุงูุฏูุฑุฉ ุงููุงููุฉ: trigger โ webhook โ Edge Function โ FCM โ device | โฌ ูู ููููุฐ |

### ุงููุฑุญูุฉ 2 - ุชุญุณูู ุงูุฃุฏุงุก (ูู ุชุจุฏุฃ):

- LCP 7.9s โ ุงููุฏู < 2.5s
- CLS โ ุงููุฏู < 0.1
- FCP โ ุงููุฏู < 1.5s
- ุงูุจุงูุฑ ุงูุฑุฆูุณู 938KB โ ูุฌุจ < 200KB

### ุงููุฑุญูุฉ 3 - Capacitor (ูู ุชุจุฏุฃ):

- ุชุซุจูุช ูุฅุนุฏุงุฏ Capacitor
- Native plugins
- Android project setup
- Build ูุชุฌุฑูุจ

### ุงููุฑุญูุฉ 4-6 (ูู ุชุจุฏุฃ):

- Google Play Developer account
- Store listing content
- Screenshots ุจุตูุบุฉ PNG (ุงูุญุงููุฉ SVG)
- Testing tracks
- Production release

---

## ุงููุณู ุงูุฑุงุจุน: ูุดุงูู ุฌูุฏุฉ ุงูููุฏ ุงูููุชุดูุฉ

### 4.1 ูููุงุช ุถุฎูุฉ ุชุญุชุงุฌ ุชูุณูู

| ุงูููู                                         | ุนุฏุฏ ุงูุฃุณุทุฑ | ุงูุชูุตูุฉ                                             |
| --------------------------------------------- | ---------- | --------------------------------------------------- |
| `src/lib/ai/agentTools.ts`                    | 3,265      | ุชูุณูู ุฅูู: search-tools, order-tools, utility-tools |
| `src/app/[locale]/provider/settings/page.tsx` | 2,583      | ุงุณุชุฎุฑุงุฌ sub-components ููู ูุณู                      |
| `src/app/[locale]/admin/banners/page.tsx`     | 2,209      | ุงุณุชุฎุฑุงุฌ BannerForm, BannerList                      |
| `src/app/[locale]/checkout/page.tsx`          | 2,073      | ุงุณุชุฎุฑุงุฌ CheckoutForm, OrderSummary, PaymentSection  |
| `src/app/[locale]/provider/finance/page.tsx`  | 1,990      | ุงุณุชุฎุฑุงุฌ FinanceCharts, SettlementsList              |
| `src/app/[locale]/admin/locations/page.tsx`   | 1,956      | ุงุณุชุฎุฑุงุฌ LocationForm, LocationList                  |
| `src/app/[locale]/admin/settlements/page.tsx` | 1,828      | ุงุณุชุฎุฑุงุฌ SettlementTable, SettlementFilters          |
| `src/lib/ai/agentHandler.ts`                  | 1,472      | ุชูุณูู ุงููุนุงูุฌ ุญุณุจ ููุน ุงูุทูุจ                         |

**ููุงุญุธุฉ:** ูุฐู ูุดุงูู ุตูุงูุฉ ูููุณุช ุญุงุฌุฒุฉ ูููุดุฑุ ููููุง ุชุฒูุฏ ุตุนูุจุฉ ุงูุตูุงูุฉ ุงููุณุชูุจููุฉ.

---

### 4.2 Supabase Client Creation Pattern

**ุงููููุน:** `src/lib/supabase/admin.ts`, `client.ts`, `server.ts`

**ุงูููุงุญุธุฉ:** ูู route ูcomponent ูุณุชุฏุนู `createClient()` ุจุฏูู caching. ูุฐุง ููุจูู ูู Next.js SSR ููู ูููู ุชุญุณููู ุจู singleton pattern ูุชูููู ุงุณุชููุงู ุงูุฐุงูุฑุฉ.

**ุงูุชูุตูุฉ (ุชุญุณููุ ููุณ ุญุฑุฌุงู):** ุฅุถุงูุฉ memoization ููู client instances.

---

## ุงููุณู ุงูุฎุงูุณ: ุชุญุฏูุงุช Capacitor / Google Play

### 5.1 ุงููุดุฑูุน ูุนุชูุฏ ุนูู Server ุจุงููุงูู

**ุงููุดููุฉ ุงูุฌููุฑูุฉ:** ุงูุชุทุจูู ููุณ static export - ูุนุชูุฏ ุนูู:

- **34 API route** ุชุญุชุงุฌ server
- **Middleware** ูููุตุงุฏูุฉ ูุงูุชูุฌูู
- **ISR (Incremental Static Regeneration)** ูู ุตูุญุงุช ุงููุฒูุฏูู
- **Next.js Image Optimization** ูุญุชุงุฌ server
- **Server Actions** ูู `src/lib/auth/actions.ts`

**ุงูุงุณุชุฑุงุชูุฌูุฉ ุงูููุชุฑุญุฉ: Hybrid App (ุงูุฃูุถู)**

1. ุฅุจูุงุก backend ุนูู Vercel ููุง ูู
2. ุงุณุชุฎุฏุงู Capacitor ูุชุบููู ุงูุชุทุจูู
3. ุชูุฌูู ุงูู WebView ูู URL ุงูููุดูุฑ (ูุซู `https://app.engezna.com`)
4. ุงุณุชุฎุฏุงู Native Plugins ููุฅุดุนุงุฑุงุช ูุงููุงููุฑุง ูุงููููุน

### 5.2 ุงูุฌุงูุฒ ูุงูููููุฏ

**โ ุฌุงูุฒ:**

- PWA Manifest ูุงูู ููููุฒ
- Service Worker ุจุฃุฏุงุก ุนุงูู
- ุฃููููุงุช ุจูู ุงูุฃุญุฌุงู ุงููุทููุจุฉ (192x192, 512x512)
- Deep linking ููุนุฏ
- Offline page ููุฌูุฏุฉ

**โ ููููุฏ:**

- Capacitor ุบูุฑ ูุซุจุช ุฃู ูุนุฏ
- ูุง ููุฌุฏ `capacitor.config.ts`
- ูุง ููุฌุฏ ูุดุฑูุน Android native
- ูุง ููุฌุฏ Splash Screen
- ูุง ููุฌุฏ `google-services.json`
- Screenshots ุจุตูุบุฉ SVG (Google Play ูุทูุจ PNG/JPEG)
- ูุง ููุฌุฏ `output: 'standalone'` ูู `next.config.ts`

---

## ุงููุณู ุงูุณุงุฏุณ: ููุงู ุฅุถุงููุฉ ููุชุดูุฉ (ููุณุช ูู ุงูุฎุงุฑุทุฉ ุงูุฃุตููุฉ)

### 6.1 ููุงู ุญุฑุฌุฉ ููุชุดูุฉ ุฌุฏูุฏุฉ

| #   | ุงููููุฉ                                                     | ุงูุฃููููุฉ | ุงูุณุจุจ                    |
| --- | ---------------------------------------------------------- | -------- | ------------------------ |
| 1   | ุฅูุดุงุก ุงูุทูุจ ุจุญุงูุฉ `pending_payment` ูุจู ุงูุชูุฌูู ูู Kashier | ๐ด ุญุฑุฌ   | ููุน ุงูุทูุจุงุช ุงูููููุฉ      |
| 2   | ุฅูุดุงุก Kashier Refund API endpoint                          | ๐ด ุญุฑุฌ   | ุงูุงุณุชุฑุฌุงุน ูุง ูุนูู ูุนููุงู |
| 3   | ุฅุถุงูุฉ idempotency check ููู webhook                        | ๐ด ุญุฑุฌ   | ููุน ุงูุฏูุน ุงูููุฑุฑ         |
| 4   | ูุดุฑ Edge Functions ููุฅุดุนุงุฑุงุช                               | ๐ด ุญุฑุฌ   | ุงูุฅุดุนุงุฑุงุช ูุง ุชุตู ููุฃุฌูุฒุฉ |
| 5   | ุชูุนูู CSRF middleware ุนูู API routes                       | โ๏ธ ุนุงูู  | ุญูุงูุฉ ูู ูุฌูุงุช CSRF      |
| 6   | ุฅุฒุงูุฉ console.log ูู ููุฏ ุงูุฅูุชุงุฌ                           | โ๏ธ ุนุงูู  | ุชุณุฑูุจ ูุนูููุงุช + ุฃุฏุงุก     |
| 7   | ุฅุถุงูุฉ cron ูุชูุธูู ุงูุทูุจุงุช ุงููุนููุฉ                          | โ๏ธ ุนุงูู  | ุทูุจุงุช "ูุนููุฉ" ููุฃุจุฏ      |
| 8   | ุฅุตูุงุญ Kashier credentials validation                       | โ๏ธ ูุชูุณุท | ูุดู ุตุงูุช ุจุฏู ุฎุทุฃ ูุงุถุญ    |
| 9   | ุฅุถุงูุฉ confirmation dialog ูุชุบููุฑ ุญุงูุฉ ุงูุทูุจ ุนูุฏ ุงููุฒูุฏ     | โ๏ธ ูุชูุณุท | ููุน ุงูุชุบููุฑ ุจุงูุฎุทุฃ       |
| 10  | ูุฑุงุฌุนุฉ alt text ููุตูุฑ ูู ุตูุญุงุช ุงูุจุญุซ ูุงูุฃุฏูู               | ๐ก ููุฎูุถ | ุชุญุณูู Accessibility      |

### 6.2 ููุงู ุชุญุณูููุฉ (ููุณุช ุญุงุฌุฒุฉ ูููุดุฑ)

| ุงููููุฉ                                   | ุงููุงุฆุฏุฉ               |
| ---------------------------------------- | --------------------- |
| ุชูุณูู ุงููููุงุช ุงููุจูุฑุฉ (>2000 ุณุทุฑ)        | ุณูููุฉ ุงูุตูุงูุฉ         |
| ุชุทุจูู Supabase singleton pattern         | ุชูููู ุงุณุชููุงู ุงูุฐุงูุฑุฉ |
| ุฅููุงู Background Sync ูู Service Worker  | ุฏุนู offline ุฃูุถู      |
| ุฅุถุงูุฉ IndexedDB ููุจูุงูุงุช ุงููุจูุฑุฉ offline | ุชุฌุฑุจุฉ offline ุฃุบูู    |
| ุฅุถุงูุฉ payment_completed_at timestamp     | ุชุชุจุน ุฏููู ููุฏูุน       |

---

## ุงููุณู ุงูุณุงุจุน: ุชุฑุชูุจ ุงูููุงู ุงูููุชุฑุญ ูุจู ุงููุดุฑ

### ุงููุฌููุนุฉ ุฃ: ูุจู ุจุฏุก ุงููุฑุญูุฉ 2 (ุญุฑุฌ - ูุฌุจ ุชูููุฐู ุงูุขู)

1. โ ุฅุตูุงุญ Phantom Orders (ุฅูุดุงุก ุงูุทูุจ ูุจู ุงูุฏูุน)
2. โ ุฅุถุงูุฉ Kashier Refund API
3. โ ุฅุถุงูุฉ Webhook idempotency
4. โ ูุดุฑ Edge Functions ููุฅุดุนุงุฑุงุช
5. โ ุฅุฒุงูุฉ console.log statements
6. โ ุชูุนูู CSRF ุนูู API routes
7. โ ุฅุถุงูุฉ cron ูุชูุธูู ุงูุทูุจุงุช ุงููุนููุฉ ุจุงูุฏูุน
8. โ ุฅุตูุงุญ Kashier credentials validation

### ุงููุฌููุนุฉ ุจ: ุฃุซูุงุก ุงููุฑุญูุฉ 2 (ุชุญุณูู ุงูุฃุฏุงุก)

9. ุชุญุณูู LCP, CLS, FCP ุญุณุจ ุงูุฎุงุฑุทุฉ
10. ุถุบุท ุงูุตูุฑ ูุชุญููููุง ูู WebP/AVIF
11. ุฅุถุงูุฉ Skeleton loaders
12. ูุฑุงุฌุนุฉ Accessibility

### ุงููุฌููุนุฉ ุฌ: ุฃุซูุงุก ุงููุฑุญูุฉ 3 (ุฅุนุฏุงุฏ Capacitor)

13. ูุฑุงุฑ ุงูุงุณุชุฑุงุชูุฌูุฉ: Hybrid App (ููุตู) vs Static Export
14. ุฅุนุฏุงุฏ `output: 'standalone'` ูู next.config.ts
15. ุชุซุจูุช ูุฅุนุฏุงุฏ Capacitor
16. ุฅุนุฏุงุฏ Android project ูุน ุงูุฃุฐููุงุช
17. ุชุญููู Screenshots ูู SVG ูู PNG

### ุงููุฌููุนุฉ ุฏ: ูุจู ุงููุดุฑ ุงูููุงุฆู (ุงููุฑุญูุฉ 5)

18. ุชุดุบูู Security tests
19. ุงุฎุชุจุงุฑ ุงูุตูุช ุนูู ุฃุฌูุฒุฉ ูุชุนุฏุฏุฉ
20. ุงุฎุชุจุงุฑ FCM token generation
21. ูุฑุงุฌุนุฉ ุฃูููุฉ ููุงุฆูุฉ
22. npm audit

---

## ุงููุณู ุงูุซุงูู: ุงูููุงุท ุงูุฅูุฌุงุจูุฉ ุงูููุญูุธุฉ

ุงููุดุฑูุน ูุจูู ุจุฌูุฏุฉ ุนุงููุฉ ูู ุนุฏุฉ ุฌูุงูุจ:

- โ **ูุง ููุฌุฏ API keys ููุดููุฉ** - ูููุง ูู environment variables
- โ **ูุง ููุฌุฏ SQL injection** - ูุณุชุฎุฏู Supabase SDK ูุน parameterized queries
- โ **ูุง ููุฌุฏ XSS** - ูุง ูุณุชุฎุฏู dangerouslySetInnerHTML ุฃู eval
- โ **Error handling ููุชุงุฒ** ูู 34 API route (try/catch + proper status codes)
- โ **TypeScript strict mode** ุจุฏูู @ts-ignore ุฃู @ts-nocheck
- โ **Memory leak protection** - ูู useEffect ููู cleanup
- โ **Form validation** ุดุงูู ุจู Zod schemas
- โ **Security headers** ูุทุจูุฉ ุจุงููุงูู (HSTS, X-Frame, CSP, etc.)
- โ **Rate limiting** ูุจูู ุจู Upstash Redis
- โ **Payment signature validation** ุจู HMAC-SHA256
- โ **RLS (Row Level Security)** ููุนู ุนูู ูู ุงูุฌุฏุงูู
- โ **RBAC/ABAC** ูุธุงู ุตูุงุญูุงุช ุดุงูู
- โ **270+ unit tests, 76 security tests, 114+ E2E tests**

---

## ุงูุฎูุงุตุฉ

ุงููุดุฑูุน ูู ุญุงูุฉ ุฌูุฏุฉ ุฌุฏุงู ูู ุงููุงุญูุฉ ุงููููููุฉ ูุงููุนูุงุฑูุฉ. ุงููุฑุงุญู 0 ู 1 ูู ุฎุงุฑุทุฉ ุงูุทุฑูู ููุชููุฉ ุจูุฌุงุญ. **ููู ููุงู 8 ููุงู ุญุฑุฌุฉ ููุชุดูุฉ** (ุงููุณู ุงูุฃูู ูุงูุซุงูู) ูุฌุจ ุชูููุฐูุง **ูุจู** ุงูุงูุชูุงู ูููุฑุญูุฉ 2ุ ูุฃููุง ุชุชุนูู ุจุณูุงูุฉ ุงูุนูููุงุช ุงููุงููุฉ ูุฃูุงู ุงูุชุทุจูู.

ุงููุฑุงุญู 2-6 ูู ุฎุงุฑุทุฉ ุงูุทุฑูู ูู ุชุจุฏุฃ ุจุนุฏุ ููุฐุง ูุชููุน ุญุณุจ ุงูุฌุฏูู ุงูุฒููู. ุงููุฑุงุฑ ุงูุงุณุชุฑุงุชูุฌู ุงูุฃูู ูู ุงุนุชูุงุฏ **Hybrid App approach** ูู Capacitor (ุงุณุชุฎุฏุงู WebView ูุดูุฑ ูู backend ุงูููุดูุฑ) ุจุฏูุงู ูู ูุญุงููุฉ static export ุงูุชู ุณุชุชุทูุจ ุฅุนุงุฏุฉ ููููุฉ ูุจูุฑุฉ.
