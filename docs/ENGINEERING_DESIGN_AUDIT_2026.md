# ุชุฏููู ุงููุฑุงุฑุงุช ุงูููุฏุณูุฉ โ ุฅูุฌุฒูุง (Engezna)

**ุงูุชุงุฑูุฎ:** 26 ูุจุฑุงูุฑ 2026
**ุงููุฏูู:** Claude (Senior Software Architect)
**ุงููุณุฎุฉ:** 3.0 โ Deep-Dive Engineering Design Review + Implementation Tracking
**ุงููุทุงู:** Production Readiness ูู 10,000 ูุณุชุฎุฏู ูุชุฒุงูู
**ุขุฎุฑ ุชุญุฏูุซ ููุญุงูุฉ:** 26 ูุจุฑุงูุฑ 2026

---

## ููุฎุต ุญุงูุฉ ุงูุชูููุฐ

```
ุฎุฑูุทุฉ ุงูุทุฑูู:  โโโโโโโโโโโโโโโโโโโโโโโโโ  48% ููุชูู (12/25 ุจูุฏ)

ุงููุฑุญูุฉ 0 (ุงูุฃุฏุงุก ุงูููุฑู):       โโโโโโโโโโโโโโโโโโโโโ  4.5/5  (90%)
ุงููุฑุญูุฉ 1 (ุณูุงูุฉ ุงูุจูุงูุงุช):       โโโโโโโโโโโโโโโโโโโโโ  5/5    (100%) โ
ุงููุฑุญูุฉ 2 (Frontend):             โโโโโโโโโโโโโโโโโโโโโ  1/4    (25%)
ุงููุฑุญูุฉ 3 (ุงููุชุงูุฉ ูุงููุฑุงูุจุฉ):     โโโโโโโโโโโโโโโโโโโโโ  1/6    (17%)
ุงููุฑุญูุฉ 4 (ุงูุชุญุฌูู):               โโโโโโโโโโโโโโโโโโโโโ  0.5/5  (10%)
```

| ุงูุญุงูุฉ | ุงูุนุฏุฏ | ุงูุจููุฏ |
| ------ | ----- | ------ |
| โ ููุชูู | 10 | #2, #3, #4, #5, #6, #7, #8, #9, #10, #19 |
| ๐ถ ุฌุฒุฆู | 5 | #1, #13, #14, #18, #21 |
| โ ูู ูุจุฏุฃ | 10 | #11, #12, #15, #16, #17, #20, #22, #23, #24, #25 |

---

## ุงูููุฎุต ุงูุชูููุฐู

| ุงููููุงุณ                    | ุงููููุฉ ุงูุฃุตููุฉ (ูุจู ุงูุชูููุฐ)       | ุงููููุฉ ุงูุญุงููุฉ (ุจุนุฏ ุงูุชูููุฐ)        |
| -------------------------- | ----------------------------------- | ----------------------------------- |
| **ุงูุชูููู ุงูุนุงู**          | **61/100**                          | **~78/100**                         |
| **ูุดุงูู ุญุฑุฌุฉ (CRITICAL)**  | 8                                   | 3 (ุชู ุญู 5)                        |
| **ูุดุงูู ุนุงููุฉ (HIGH)**     | 11                                  | 7 (ุชู ุญู 4)                        |
| **ูุดุงูู ูุชูุณุทุฉ (MEDIUM)**  | 14                                  | 10 (ุชู ุญู 4)                       |
| **ุงูุฌุงูุฒูุฉ ูู 10K ูุชุฒุงูู** | **ุบูุฑ ุฌุงูุฒ โ ุณูุณูุท ุฎูุงู 2-4 ุณุงุนุงุช** | **ุฌุฒุฆู โ ูุชุญูู ~8,000 ูุน ุจุทุก**     |

### ุงูุชุตููู ุญุณุจ ุงููุญูุฑ

| ุงููุญูุฑ                           | ุงูุฏุฑุฌุฉ ุงูุฃุตููุฉ | ุงูุฏุฑุฌุฉ ุงูุญุงููุฉ | ุงูุญุงูุฉ                                       |
| -------------------------------- | -------------- | -------------- | -------------------------------------------- |
| Infrastructure Efficiency & Cost | 45/100         | **72/100**     | โ ุชุญุณู ูุจูุฑ โ Cache + Polling + Realtime    |
| Data Integrity & Concurrency     | 50/100         | **88/100**     | โ ุชุญุณู ุฌุฐุฑู โ Atomic RPC + Guards + RLS     |
| Resiliency & Error Handling      | 62/100         | **65/100**     | ๐ถ ุชุญุณู ุทููู โ ูุง ูุฒุงู Validation ูุงูุต      |
| Security & Observability         | 72/100         | **78/100**     | ๐ถ ุชุญุณู โ RLS ููุตูุญ ููู Alerting ุบุงุฆุจ       |
| Frontend Architecture            | 40/100         | **45/100**     | โ ูุง ูุฒุงู ุถุนูู โ ูุนุธู ุงูุจููุฏ ูู ุชููููุฐ     |

---

## ุงููุณู 1: Infrastructure Efficiency & Cost (45/100)

### 1.1 ูุงุฑุซุฉ Realtime: ุงูุฃุฑูุงู ุงูุญููููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  WAL Query #1:  12,537,981 ุงุณุชุฏุนุงุก  =  75,106 ุซุงููุฉ        โ
โ                 = 20.9 ุณุงุนุฉ ููุช CPU ุฎุงูุต                   โ
โ  WAL Query #2:   2,141,851 ุงุณุชุฏุนุงุก  =  11,121 ุซุงููุฉ        โ
โ                 =  3.1 ุณุงุนุฉ ููุช CPU ุฎุงูุต                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ          โ
โ  ุงููุฌููุน: 14.68 ููููู ุงุณุชุฏุนุงุก = 24 ุณุงุนุฉ CPU                โ
โ  ูุฐุง ููู ูุงูู ูู ุนูู ุงููุนุงูุฌ ูู Realtime ููุท!              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ุงูุชุดุฎูุต:** ุฑุบู ุชุญุณูู ุงููููุงุช ูู 10 ุฅูู 1ุ ุงูุงุณุชุฏุนุงุกุงุช ุงุฑุชูุนุช ูู 10.5M ุฅูู 12.5M (ุฒูุงุฏุฉ 19%). ูุฐุง ูุนูู ุฃู ุงููุดููุฉ ููุณุช ูู ุนุฏุฏ ุงููููุงุช ุจู ูู **ุทุจูุนุฉ ุงูุงุดุชุฑุงูุงุช** โ ูู WAL change ููุฑ ุนุจุฑ filter evaluation ุญุชู ูู ูู ูุทุงุจู ุฃู subscription.

**ุงููุฑุงุฑ ุงูููุฏุณู ุงูููููุฏ:** ูุง ููุฌุฏ ูุตู ุจูู ุงูุฌุฏุงูู ุงูุชู ุชุญุชุงุฌ Realtime ูุงูุชู ูุง ุชุญุชุงุฌ. ุฌููุน ุงูุฌุฏุงูู ูุถุงูุฉ ูู `supabase_realtime` publicationุ ููุง ูุนูู ุฃู ูู INSERT/UPDATE/DELETE ุนูู ุฃู ุฌุฏูู ููุฑ ุนุจุฑ WAL processing.

### 1.2 ุงุณุชุนูุงู ุงูู governorates: 576,006 ุงุณุชุฏุนุงุก ูู 27 ุตู

```sql
-- ูุฐุง ุงูุงุณุชุนูุงู ููุณุชุฏุนู 576,006 ูุฑุฉ:
SELECT id, name_ar, name_en, is_active FROM governorates
-- ุจูุนุฏู 0.06ms ููู ุงุณุชุฏุนุงุก = 34.2 ุซุงููุฉ ุฅุฌูุงูู
-- ููู 27 ุตู ูุง ุชุชุบูุฑ ุฃุจุฏุงู!
```

**ูุตุฏุฑ ุงููุดููุฉ:** `Footer.tsx` + middleware + ุตูุญุงุช ูุชุนุฏุฏุฉ ุชุณุชุนูู ุนู ุงููุญุงูุธุงุช ูู ูู ุทูุจ. ูุฐู ุจูุงูุงุช ุดุจู ุซุงุจุชุฉ ูุฌุจ ุฃู ุชููู ููุฎุฒูุฉ ูุคูุชุงู ุจู TTL ุทููู (24 ุณุงุนุฉ).

**ุงูุฃุซุฑ ุงููุงูู:** ุนูู Supabase Free/Pro tierุ ูุฐุง ูุณุชููู ุญุตุฉ ุงูุงุณุชุนูุงูุงุช ุจุฏูู ุฃู ูููุฉ ูุถุงูุฉ.

### 1.3 Polling ุจุฏูู ุฐูุงุก: ุชูููุฉ ุงููุฑุงุฑ ุงูุญุงูู

| ุงููููู           | ุงูุงุณุชุนูุงูุงุช/ุฏูุฑุฉ | ุงููุชุฑุฉ     | ุงููุณุชุฎุฏููู ุงููุชููุนูู | ุงูุงุณุชุนูุงูุงุช/ุซุงููุฉ |
| ---------------- | ---------------- | ---------- | -------------------- | ----------------- |
| ProviderLayout   | 6 ุงุณุชุนูุงูุงุช      | 60 ุซุงููุฉ   | 200 ุชุงุฌุฑ             | 20/ุซ              |
| BottomNavigation | 2 ุงุณุชุนูุงูุงุช      | 30 ุซุงููุฉ   | 5,000 ุนููู           | 333/ุซ             |
| Admin Layout     | 5 ุงุณุชุนูุงูุงุช      | 30 ุซุงููุฉ   | 10 ูุฏูุฑ              | 1.7/ุซ             |
| getUser() ููุฑุฑ   | 1 ุงุณุชุนูุงู        | ูู poll    | 5,200                | 173/ุซ             |
| Middleware       | 1-3 ุงุณุชุนูุงูุงุช    | ูู request | ูู ุงูุทูุจุงุช           | ~500/ุซ            |
| **ุงููุฌููุน**      |                  |            |                      | **~1,028/ุซ**      |

**ุงููุดุงูู ุงูููุฏุณูุฉ:**

1. **ูุง ููุฌุฏ `document.visibilitychange` guard:** ุงูู polling ูุณุชูุฑ ุญุชู ูู ูุงู ุงูุชุทุจูู ูู ุงูุฎูููุฉ. ุงููุณุชุฎุฏู ุงูุฐู ููุชุญ ุงูุชุงุจ ูููุณุงู ููููู 4,320 ุงุณุชุนูุงู/ุณุงุนุฉ
2. **`getUser()` ููุณุชุฏุนู ูุน ูู poll:** ูู `BottomNavigation.tsx`ุ ูู 30 ุซุงููุฉ ูุชู ุงุณุชุฏุนุงุก `supabase.auth.getUser()` โ ููุฐุง ููุฑุณู ุทูุจ HTTP ูู Supabase Auth service. ุนูุฏ 5,000 ุนููู = 167 ุทูุจ auth ุฅุถุงูู/ุซุงููุฉ
3. **Pending Orders ุชุฌูุจ ุงูุตููู ุจุฏูุงู ูู COUNT:** `ProviderLayout` ูุฌูุจ `select('id, status')` ุซู ูุนุฏ ุงููุชุงุฆุฌ ุจุฏู ุงุณุชุฎุฏุงู `count: 'exact', head: true`
4. **ูุง ููุฌุฏ parallelization ูู Admin:** 5 ุงุณุชุนูุงูุงุช ุชูููุฐ ุจุงูุชุชุงุจุน ุจุฏู `Promise.all`

### 1.4 ุฃูุธูุฉ ูุจููุฉ โ ุญุงูุฉ ุงูุชูุนูู

| ุงููุธุงู                      | ุงูููู                                  | ุงูุญุงูุฉ ุงูุฃุตููุฉ                   | ุงูุญุงูุฉ ุงูุญุงููุฉ                                                                         |
| --------------------------- | -------------------------------------- | -------------------------------- | ------------------------------------------------------------------------------------- |
| **Cache Layer (LRU + TTL)** | `src/lib/cache/cached-queries.ts`      | ุตูุฑ ุงุณุชุฎุฏุงู ูู Production        | ๐ถ **ุฌุฒุฆู** โ ูููุนูู ูู `Footer.tsx` ููุท. ุจุงูู ุงูุฃูุงูู ูุง ุชุฒุงู ุชุณุชุนูู ูุจุงุดุฑุฉ          |
| **Realtime Manager**        | `src/lib/supabase/realtime-manager.ts` | ุบูุฑ ูุณุชุฎุฏู                       | โ **ูููุนูู** โ ููุณุชุฎุฏู ูู `ProviderLayout.tsx` ูุน `subscribeWithErrorHandling()`     |
| **`withErrorHandler`**      | `src/lib/api/error-handler.ts`         | ูุณุชุฎุฏู ูู 0 ูู 45 API route      | โ **ูุง ูุฒุงู ุบูุฑ ูููุนูู** โ 0 ูู 45 API route                                         |
| **`withValidation`**        | `src/lib/api/validate.ts`              | ูุณุชุฎุฏู ูู 2 ูู 45 route           | โ **ูุง ูุฒุงู ุบูุฑ ูููุนูู** โ 0 API routes ุชุณุชุฎุฏู ุงูู wrapper                            |
| **`strongPasswordSchema`**  | `src/lib/validations/common.ts`        | ูุง ููุณุชุฎุฏู ูู auth               | โ **ูุง ูุฒุงู ุบูุฑ ูููุนูู** โ ูุง ููุณุชุฎุฏู ูู ุฃู ุตูุญุฉ auth                                |
| **Visibility Polling**      | `src/hooks/useVisibilityPolling.ts`    | _(ูู ููู ููุฌูุฏุงู)_               | โ **ูููุฌุฒ** โ ููุณุชุฎุฏู ูู `BottomNavigation.tsx` ู `ProviderLayout.tsx`               |

> **ุชุญุฏูุซ:** ุชู ุชูุนูู 2 ูู 5 ุฃูุธูุฉ (Cache ุฌุฒุฆูุงูุ Realtime Manager ุจุงููุงูู). ููู 3 ุฃูุธูุฉ ุญุฑุฌุฉ (`withErrorHandler`ุ `withValidation`ุ `strongPasswordSchema`) ูุง ุชุฒุงู ุบูุฑ ูููุนููุฉ ูุชููุซูู ุฃุนูู ROI ูุชุจูู โ ุงูููุฏ ุฌุงูุฒ ููุญุชุงุฌ ููุท ุฑุจุทู ุจุงูู API routes.

### 1.5 Indexes: 120+ ููุฑุณ ููุช

ูู ุจูุงูุงุช `pg_stat_user_indexes` ูุน `idx_scan = 0`:

- **120+ ููุฑุณ ูู ููุณุชุฎุฏู ุฃุจุฏุงู** ููุฐ ุขุฎุฑ ุฅุนุงุฏุฉ ุชุดุบูู ูู PostgreSQL
- **`idx_menu_items_embedding`:** 3,296 KB โ ููุฑุณ embedding ุซููู ูู ููุณุชุฏุนู ููู ูุฑุฉ
- **`provider_staff` indexes:** ุงูุฌุฏูู ูุญุชูู 0 ุตููู ููู ุนูุฏู ููุงุฑุณ ููุนูุฉ ุชุฃุฎุฐ ูุณุงุญุฉ
- ูู `INSERT`/`UPDATE` ุนูู ูุฐู ุงูุฌุฏุงูู ููุญุฏูุซ ูู ุงูููุงุฑุณ ุงูููุชุฉ

**ุงูุฃุซุฑ ุนูู Write Performance:** ูู ุนูููุฉ ูุชุงุจุฉ ูู `orders` ูุซูุงู ุชูุญุฏูุซ ุงูููุงุฑุณ ุงูููุชุฉ ูุน ุงููุนุงูุฉ. ูุฐุง overhead ูุชุฑุงูู ุฎุงุตุฉ ูู ุงูุฌุฏุงูู ุนุงููุฉ ุงููุชุงุจุฉ.

---

## ุงููุณู 2: Data Integrity & Concurrency (50/100)

### 2.1 CRITICAL: Checkout ุบูุฑ ุฐุฑู โ ุฃุฎุทุฑ ุซุบุฑุฉ ูู ุงููุดุฑูุน

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ูุณุงุฑ ุฅูุดุงุก ุงูุทูุจ (COD):                                   โ
โ                                                              โ
โ  ุงูุฎุทูุฉ 1: ุชุญุฏูุซ usage_count ููู promo โโโโโโโโ โ ูุฌุญ     โ
โ  ุงูุฎุทูุฉ 2: ุฅูุดุงุก ุณุฌู promo_code_usage โโโโโโโโ โ ูุฌุญ     โ
โ  ุงูุฎุทูุฉ 3: ุฅูุดุงุก ุงูุทูุจ ูู orders โโโโโโโโโโโโโโ โ ูุฌุญ     โ
โ  ุงูุฎุทูุฉ 4: ุฅูุดุงุก ุนูุงุตุฑ ุงูุทูุจ ูู order_items โโโ โ ูุดู    โ
โ                                                              โ
โ  ุงููุชูุฌุฉ: ุทูุจ ููุฌูุฏ ุจุฏูู ุฃู ุนูุงุตุฑ!                          โ
โ  ุงูู catch block ูุณุชุฑุฌุน ุงูู promo ููุท โ ูุง ูุญุฐู ุงูุทูุจ       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ุงูููู:** `src/app/[locale]/checkout/page.tsx` (ุฃุณุทุฑ 1056-1276)

ูุฐู ุฃุฑุจุน ุนูููุงุช DB ูููุตูุฉ **ุจุฏูู ุฃู transaction wrapper**. ูุง ููุฌุฏ `BEGIN`/`COMMIT`/`ROLLBACK` ูู ุงููุดุฑูุน ุจุงููุงูู.

**ุณููุงุฑูู ุงููุดู ุงููุงูุนู:**

- ุงูุนููู ูุทูุจ 15 ุตูู ูุน promo code
- ุงูุฎุทูุงุช 1-3 ุชูุฌุญ
- ุงูุฎุทูุฉ 4 ุชูุดู (timeoutุ RLS errorุ constraint violation)
- ุงูุชุงุฌุฑ ูุฑู ุทูุจ ุจู 0 ุฃุตูุงู ููุจูุบ 0
- ุงูู promo code ุชู ุงุณุชุฑุฌุงุนู ููู ุงูุทูุจ ูุจูู "ูุชูู"

**ููุณ ุงููุดููุฉ ูู ุงูุฏูุน ุงูุฅููุชุฑููู:** `src/app/api/payment/kashier/initiate/route.ts` (ุฃุณุทุฑ 99-178) โ ุฅุฐุง ูุดู ุฅูุดุงุก ุงูุนูุงุตุฑุ ุงูุนููู ููุญูููู ูู Kashier ูุฏูุน ุทูุจ ุจุฏูู ุนูุงุตุฑ.

### 2.2 CRITICAL: ุฃุณุนุงุฑ ุงูุทูุจ ุชูุญุณุจ Client-Side ูุชููุซู ุจูุง Server-Side

```typescript
// src/app/[locale]/checkout/page.tsx โ ุณุทุฑ 1028
const finalTotal = subtotal + calculatedDeliveryFee - discountAmount;

// ูุฐู ุงูููู ุชูุฑุณู ูุจุงุดุฑุฉ ููู database:
.insert({
  subtotal: subtotal,           // โ ูุญุณูุจ ุนูู ุงููุชุตูุญ
  delivery_fee: deliveryFee,    // โ ูุญุณูุจ ุนูู ุงููุชุตูุญ
  discount: discountAmount,     // โ ูุญุณูุจ ุนูู ุงููุชุตูุญ
  total: finalTotal,            // โ ูุญุณูุจ ุนูู ุงููุชุตูุญ
})
```

**ูุง ููุฌุฏ ุฃู ุชุญูู Server-Side** ูู ุฃู:

- `subtotal` = ูุฌููุน (ุณุนุฑ_ุงููุญุฏุฉ ร ุงููููุฉ) ููู ุตูู
- `delivery_fee` ูุทุงุจู ุงููููุฉ ุงูุญููููุฉ ูููุญุงูุธุฉ
- `discount` ูุง ูุชุฌุงูุฒ ุงูุฎุตู ุงููุนูู ููููุฏ

**ุงููุฎุงุทุฑ:**

- ุนููู ุฎุจูุซ ููููู ุชุนุฏูู `subtotal` ูู 500 ูู 50 ุฌููู
- ุงูู `platform_commission` trigger ูุญุณุจ ุงูุนูููุฉ ุตุญูุญุงู... ููู ุนูู ุฃุณุงุณ ุฎุงุทุฆ
- ูุง ููุฌุฏ audit trail ููุดู ุงูุชูุงุนุจ

### 2.3 CRITICAL: Cart ูู localStorage โ ุฃุณุนุงุฑ ูุฌูุฏุฉ

```typescript
// src/lib/store/cart.ts โ ุณุทุฑ 316-317
storage: createJSONStorage(() => localStorage),
```

ุณููุงุฑูู:

1. ุงูุนููู ูุถูู ูุฌุจุฉ ุจุณุนุฑ 100 ุฌููู ุงูุณุงุนุฉ 2:00 PM
2. ุงูุชุงุฌุฑ ูุฑูุน ุงูุณุนุฑ ูู 150 ุฌููู ุงูุณุงุนุฉ 3:00 PM
3. ุงูุนููู ูุทูุจ ุงูุณุงุนุฉ 6:00 PM ุจุงูุณุนุฑ ุงููุฏูู (100 ุฌููู)
4. ุงูุทูุจ ูููุดุฃ ุจู 100 ุฌููู โ ุงูุฃุณุนุงุฑ ูู localStorage ูุง ุชูุญุฏููุซ

**ูุง ููุฌุฏ re-validation ููุฃุณุนุงุฑ ุนูุฏ ุงูู checkout.**

### 2.4 ูุง ููุฌุฏ Double-Submit Prevention

```typescript
// src/app/[locale]/checkout/page.tsx โ ุณุทุฑ 972
const handlePlaceOrder = async () => {
  // ุงูุญูุงูุฉ ุงููุญูุฏุฉ: setIsLoading(true) โ client-side React state
  // ูุง ููุฌุฏ idempotency key
  // ูุง ููุฌุฏ unique constraint ูููุน ุงูุชูุฑุงุฑ
  // ูุง ููุฌุฏ server-side deduplication
```

ุนูุฏ double-click ุณุฑูุน ุฃู ุถุนู ุงูุดุจูุฉุ ูููู ุฅูุดุงุก ุทูุจูู ูุชุทุงุจููู.

### 2.5 ูุง ููุฌุฏ Status Transition Guards

```typescript
// src/lib/repositories/orders-repository.ts โ ุณุทุฑ 441-472
// updateStatus ููููุฐ UPDATE ... WHERE id = ? ููุท
// ูุง ููุฌุฏ WHERE status = 'current_status'
// ูููู ููู ุทูุจ ูู 'delivered' ุฅูู 'pending' ุจุฏูู ุฃู ุญูุงูุฉ
```

### 2.6 ููุงุท ุงูููุฉ ูู Data Integrity

| ุงูููุฒุฉ                             | ุงูุชูููู                                                                                            |
| ---------------------------------- | -------------------------------------------------------------------------------------------------- |
| Commission Calculation             | ููุชุงุฒ โ PostgreSQL trigger ูููุน ุงูุชูุงุนุจ                                                            |
| Payment Webhook Idempotency        | ููุชุงุฒ โ 5 ุทุจูุงุช ุญูุงูุฉ (terminal state, cancelled check, duplicate txn, status guard, empty result) |
| Promo Code Optimistic Locking      | ุฌูุฏ โ compare-and-swap ุนูู `usage_count`                                                           |
| Financial Views as Source of Truth | ููุชุงุฒ โ `financial_settlement_engine` ู `admin_financial_summary`                                  |

---

## ุงููุณู 3: Resiliency & Error Handling (62/100)

### 3.1 Error Boundaries: ุฌูุฏ

| ุงูุญุฏ           | ุงูููู                                 | Sentry               | Recovery                    |
| -------------- | ------------------------------------- | -------------------- | --------------------------- |
| Global (fatal) | `src/app/global-error.tsx`            | ูุนูุ level: `fatal`  | Reset                       |
| Locale         | `src/app/[locale]/error.tsx`          | ูุนูุ tag: `locale`   | Reset + Home                |
| Admin          | `src/app/[locale]/admin/error.tsx`    | ูุนูุ tag: `admin`    | Reset + Dashboard           |
| Provider       | `src/app/[locale]/provider/error.tsx` | ูุนูุ tag: `provider` | Reset + Dashboard + Support |

**ูุดููุฉ:** ุฌููุน error boundaries ุชุญุชูู ุนูู ุฑูุงุจุท hardcoded ูู `/ar` โ ุงููุณุชุฎุฏู ุงูุฅูุฌููุฒู ููุฑุณู ูุตูุญุฉ ุนุฑุจูุฉ.

### 3.2 SDUI Graceful Degradation: ููุชุงุฒ

ูุธุงู 3 ุทุจูุงุช ูู `src/hooks/sdui/useSDUI.ts`:

1. **ุงูุทุจูุฉ 1:** Hardcoded defaults โ ุงูุชุทุจูู ูุนูู ููุฑุงู
2. **ุงูุทุจูุฉ 2:** LocalStorage cache ุจู TTL 30 ุฏูููุฉ
3. **ุงูุทุจูุฉ 3:** Supabase RPC fetch โ ุฅุฐุง ูุดูุ ูุณุชูุฑ ูุน ุงูุทุจูุฉ ุงูุฃูู

**ูุฑุงุฑ ููุฏุณู ุฐูู:** ุญุชู ุฎุทุฃ `42883` (Type Cast) ููุนุงูู ุจุตูุช โ ุงูุชุทุจูู ูุง ูุชููู ุฃุจุฏุงู ุจุณุจุจ SDUI.

### 3.3 Firebase Graceful Degradation: ุฌูุฏ

- Lazy loading ููู SDK
- Null-safe returns ูู ูู ุงูุญุงูุงุช
- Feature detection ูุจู ุงุณุชุฎุฏุงู Notification/ServiceWorker/PushManager
- ุฅุฐุง Firebase ูุนุทู ุจุงููุงูู: ุงูุชุทุจูู ูุนูู ุจุดูู ุทุจูุนู ุจุฏูู push notifications

### 3.4 CRITICAL: Server-Side Validation ุดุจู ูุนุฏููุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ูู 45 API route:                                           โ
โ  โ ุชุณุชุฎุฏู schema validation: 2 (4.4%)                       โ
โ  โ ุชุณุชุฎุฏู withErrorHandler:  0 (0%)                         โ
โ  โ ุชุณุชุฎุฏู try-catch ูุฏูู:   43 (95.6%)                     โ
โ                                                              โ
โ  ุงูู withValidation ู withErrorHandler ููุฌูุฏูู               โ
โ  ููู ูู ูููุนููุง ูู ุฃู API route!                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 3.5 CRITICAL: Silent Failures ูู ูุณุงุฑุงุช ุญุฑุฌุฉ

| ุงูููู                     | ุงูุณุทุฑ         | ุงูุณูุงู                                                    | ุงูุฎุทูุฑุฉ   |
| ------------------------- | ------------- | --------------------------------------------------------- | --------- |
| `ProvidersClient.tsx`     | 326           | ุตูุญุฉ ุนุฑุถ ุงููุญูุงุช โ `catch {}` ุจุฏูู ุฃู ุฑุณุงูุฉ ุฎุทุฃ ุฃู Sentry | **ุญุฑุฌ**   |
| `delete-account/route.ts` | 62-80         | ุญุฐู ุงูุญุณุงุจ โ 6 ุนูููุงุช delete ุจุฏูู ูุญุต ูุชูุฌุฉ ุฃู ูููุง       | **ุญุฑุฌ**   |
| `RefundRequestModal.tsx`  | 249, 314, 330 | 3 ูุดู ุตุงูุช: ุฑูุน ุตูุฑุฉุ ุฅูุดุงุก ุชุฐูุฑุฉุ ุฅุดุนุงุฑ                  | **ุนุงูู**  |
| `useHereMaps.ts`          | 55-167        | 4 fetch calls ุจุฏูู `response.ok` check                    | **ุนุงูู**  |
| `AppUpdateDialog.tsx`     | 59            | ูุญุต ุงูุชุญุฏูุซุงุช ููุดู ุจุตูุช โ ุงููุณุชุฎุฏู ูู ูุนุฑู ุจุชุญุฏูุซ ุฃููู    | **ูุชูุณุท** |
| `middleware.ts`           | 50            | maintenance mode check ููุดู ุจุตูุช โ ูุชุฎุทู ูุถุน ุงูุตูุงูุฉ      | **ูุชูุณุท** |

### 3.6 Sentry Configuration: ุฌูุฏ

- 3 ุจูุฆุงุช: Client + Server + Edge
- Data scrubbing ููู headers ุงูุญุณุงุณุฉ (authorization, cookie, api-key)
- Session replay 1% ูู productionุ 10% ุนูุฏ ุงูุฎุทุฃ
- Smart error filtering (ResizeObserver, ChunkLoadError, etc.)

**ูุดููุฉ:** Edge config ูุง ูุญุชูู ุนูู data scrubbing โ headers auth ูุฏ ุชูุณุฑููุจ ูู Sentry ูู middleware.

---

## ุงููุณู 4: Security & Observability (72/100)

### 4.1 RLS: ุฌูุฏ ูุน ุชุณุฑุจ ุจูุงูุงุช ุญุฑุฌ

**ุงูููุฉ:** ุชูุช ูุนุงูุฌุฉ ุซุบุฑุฉ `OR true` ูู `providers` RLS. ุฌููุน ุงูู views ุชุญููุช ูู `SECURITY DEFINER` ุฅูู `SECURITY INVOKER`.

**CRITICAL: ุชุณุฑุจ ุจูุงูุงุช ุงููููุงุช ุงูุดุฎุตูุฉ**

```sql
-- supabase/migrations/20260213000004_tighten_rls_policies.sql ุณุทุฑ 22
-- ุณูุงุณุฉ profiles SELECT:
USING (auth.uid() IS NOT NULL)
-- ุฃู ูุณุชุฎุฏู ูุณุฌู ูุณุชุทูุน ูุฑุงุกุฉ ุฌููุน ุงููููุงุช ุงูุดุฎุตูุฉ!
-- ุจูุง ูู ุฐูู: email, phone, full_name
```

**ุงููุฎุงุทุฑ:** ุชุงุฌุฑ ููููู ุงุณุชุนูุงู ุฌุฏูู `profiles` ูุฑุคูุฉ ุจูุงูุงุช ูู ุงููุณุชุฎุฏููู. ุญุชู ุงูุนููุงุก ูููููู ุฑุคูุฉ ุจูุงูุงุช ุงูุชุฌุงุฑ ุงูุดุฎุตูุฉ. ุงูููู ููุณู ูุนุชุฑู ุฃููุง "interim fix".

### 4.2 Endpoint Protection Matrix

| Endpoint                            | Auth        | Rate Limit        | ุงููุดููุฉ                                                     |
| ----------------------------------- | ----------- | ----------------- | ----------------------------------------------------------- |
| `POST /api/banners/track`           | **ูุง**      | **ูุง**            | ูุณุชุฎุฏู service role key ุจุฏูู ุฃู auth โ ููุจู `user_id` ุชุนุณูู |
| `POST /api/contact`                 | **ูุง**      | **ูุง**            | ูุณุชุฎุฏู admin client โ spam risk                             |
| `POST /api/auth/register`           | ูุง (public) | **ูุง**            | ุฅูุดุงุก ุญุณุงุจุงุช ุฌูุงุนู ูููู                                     |
| `POST /api/webhooks/menu-item`      | **ุงุฎุชูุงุฑู** | **ูุง**            | ุฅุฐุง env var ููููุฏุ ุงูู webhook ููุชูุญ                        |
| `POST /api/promo/validate`          | ูุนู         | **in-memory ููุท** | ูุง ูุนูู ุนุจุฑ serverless instances                            |
| `POST /api/admin/*`                 | ูุนู (admin) | **ูุง**            | ุญุณุงุจ admin ูุฎุชุฑู = data exfiltration ุจุฏูู ุญุฏูุฏ              |
| `POST /api/chat`                    | ูุนู         | ูุนู (Upstash)     | **ูุญูู ุจุดูู ุตุญูุญ**                                          |
| `POST /api/payment/kashier/webhook` | Signature   | N/A               | **ููุชุงุฒ**                                                   |

### 4.3 RBAC (Role-Based Access Control): ุฌูุฏ

- Middleware RBAC ููุญุต ุงูุฏูุฑ ูุจู ุงูุณูุงุญ ุจุงููุตูู ูู `/admin/*` ู `/provider/*`
- ูู API route admin ููุญุต ุงูุฏูุฑ ูุณุชููุงู (defense-in-depth)
- RLS policies ุชุญูู ุนูู ูุณุชูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### 4.4 Rate Limiting Architecture

```
Upstash Redis (ููุฒุน - ูุนูู ุนุจุฑ instances):
โโโ OTP send:       5 / 10 min
โโโ OTP verify:     5 / 5 min
โโโ Login:          10 / 15 min
โโโ Password reset: 3 / hour
โโโ Chat API:       30 / min
โโโ Voice order:    10 / min
โโโ Order creation: 20 / 5 min
โโโ Search:         60 / min

In-Memory (ูุง ูุนูู ุนุจุฑ instances):
โโโ Promo validation: 10 / min  โ ูุดููุฉ
โโโ Legacy rate-limit.ts         โ ูุดููุฉ
```

### 4.5 Monitoring & Alerting: ูุงูุต

| ุงูุฃุฏุงุฉ                            | ุงูุญุงูุฉ                                        |
| --------------------------------- | --------------------------------------------- |
| Sentry Error Tracking             | ูููุนูู                                        |
| Sentry Session Replay             | ูููุนูู (1%)                                   |
| Vercel Analytics                  | ูููุนูู                                        |
| Vercel Speed Insights             | ูููุนูู                                        |
| **Alerting Rules**                | **ุบูุฑ ููุฌูุฏ** โ ูุง PagerDuty, ูุง Slack alerts |
| **Suspicious Activity Detection** | **ุบูุฑ ููุฌูุฏ**                                 |
| **Rate Limit Violation Alerts**   | **ุบูุฑ ููุฌูุฏ**                                 |
| **Log Aggregation**               | **ุบูุฑ ููุฌูุฏ** โ ูุง Datadog, ูุง CloudWatch     |

**ูุนูู:** ุฅุฐุง ุญุฏุซ ูุฌูู ุฃู ุฎูู ูู ุงูุณุงุนุฉ 3 ุตุจุงุญุงูุ ูู ูุนุฑู ุฃุญุฏ ุญุชู ูุดุชูู ุงููุณุชุฎุฏููู.

### 4.6 Security Strengths

| ุงูููุฒุฉ                | ุงูุชูููู                            |
| --------------------- | ---------------------------------- |
| CSP Headers           | ููุชุงุฒ โ ุดุงูู ูููุตู                 |
| CSRF Protection       | ููุชุงุฒ โ double-submit cookie       |
| Zod Client Validation | ููุชุงุฒ โ ุดุงูู                       |
| Secret Management     | ููุชุงุฒ โ ูุง secrets ููุดููุฉ          |
| XSS Protection        | ููุชุงุฒ โ enterprise-grade headers   |
| HSTS                  | ููุชุงุฒ โ 2 ุณูุฉ ูุน includeSubDomains |
| Webhook Signature     | ููุชุงุฒ โ Kashier webhook ูุญูู       |

---

## ุงููุณู 5: Frontend Architecture (40/100)

### 5.1 Server vs Client Rendering: ูุงุฑุซู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ูู 117 route:                                              โ
โ  โ Client Components ('use client'):  112 (95.7%)           โ
โ  โ Server Components:                   5 (4.3%)            โ
โ                                                              โ
โ  ูุฐุง ูุนูู:                                                  โ
โ  โข ูู ุตูุญุฉ ุชุฑุณู JavaScript ูุงูู ูููุชุตูุญ                    โ
โ  โข ูุง SSR/SSG ูุฃู ุตูุญุฉ ุนููู                                โ
โ  โข ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ููุณูุง 'use client'                       โ
โ  โข SEO = ุตูุฑ (Google ูููุฑุณ HTML ูุงุฑุบ)                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 5.2 Loading States: ุดุจู ูุนุฏูู

| ุงููููุงุณ             | ุงููููุฉ   |
| ------------------- | -------- |
| Routes ุฅุฌูุงูู       | 117      |
| `loading.tsx`       | 4 (3.4%) |
| Suspense boundaries | 0        |

**ุงูุฃุซุฑ:** 113 route ุชุนุฑุถ ุดุงุดุฉ ุจูุถุงุก ุฃุซูุงุก ุงูุชุญููู. ุนูู ุดุจูุฉ 3G ูู ุตุนูุฏ ูุตุฑุ ูุฐุง ูุนูู 3-8 ุซูุงู ูู ุงููุฑุงุบ.

### 5.3 Code Splitting: ุดุจู ูุนุฏูู

| ุงููููุงุณ                | ุงููููุฉ                   |
| ---------------------- | ------------------------ |
| `next/dynamic`         | 4 ูููุงุช                  |
| `React.lazy()`         | 0                        |
| ูููุงุช ุฃูุจุฑ ูู 1500 ุณุทุฑ | 5 ูููุงุช                  |
| ุฃูุจุฑ ููู               | 2,909 ุณุทุฑ (Admin Orders) |

**ุงููููุงุช ุงููุจุฑู:**

1. `admin/orders/page.tsx` โ 2,909 ุณุทุฑ
2. `provider/orders/page.tsx` โ 2,301 ุณุทุฑ
3. `checkout/page.tsx` โ 2,209 ุณุทุฑ
4. `admin/providers/page.tsx` โ ~1,900 ุณุทุฑ
5. `provider/menu/page.tsx` โ ~1,800 ุณุทุฑ

ูู ูุฐู ุงููููุงุช ุชูุญููู ููุญุฏุฉ ูุงุญุฏุฉ ุจุฏูู ุฃู splitting.

### 5.4 Image Optimization: ุฌูุฏ

- 92.9% ูู ุงูุตูุฑ ุชุณุชุฎุฏู `next/image`
- AVIF + WebP ูููุนููุงู ูู `next.config.ts`
- `priority` prop ูุณุชุฎุฏู ูู LCP images

### 5.5 framer-motion Impact: ูุชูุณุท

- ูุณุชุฎุฏู ูู 28/267 ููู (10.5%)
- **ููุณ over-engineering** โ ููุณุชุฎุฏู ูู page transitions ู carousel animations
- ููู `OffersCarousel.tsx` (933 ุณุทุฑ) ู `HeroSection` ููุญูููุงู eagerly ูุน framer-motion ูู ุงูู initial bundle

### 5.6 lucide-react: ููุชุงุฒ

- ูุณุชุฎุฏู ูู 202/267 ููู โ ููู ูุน **named imports ููุท**
- Tree-shaking ูุนูู ุจุดูู ุตุญูุญ โ ููุท ุงูุฃููููุงุช ุงููุณุชุฎุฏูุฉ ุชูุญููู
- **ูุง ูุดููุฉ ููุง**

### 5.7 Home Page: Client-Side Data Waterfall

```
ุงููุชุตูุญ ูุญูู JavaScript โ ููููุฐ React โ ูุจุฏุฃ fetch ูู Supabase
                                              โ
                              HeroSection ูุฌูุจ banners (fetch #1)
                              OffersCarousel ูุฌูุจ offers (fetch #2)
                              Categories ูุฌูุจ categories (fetch #3)
                              Providers ูุฌูุจ providers (fetch #4)
```

ูู ูุฐู ุงูู fetches ุชุญุฏุซ **ุจุนุฏ** ุชุญููู ูุชูููุฐ JavaScript. ุนูู SSR ูุงู ูููู ุชูุญููู ุงูุจูุงูุงุช ูุน HTML ูุจุงุดุฑุฉ.

---

## ุงููุณู 6: ุชุญููู ุงููุฎุงุทุฑ โ 10,000 ูุณุชุฎุฏู ูุชุฒุงูู

### 6.1 ุงูุณููุงุฑูู

```
10,000 ูุณุชุฎุฏู ูุชุฒุงูู:
โโโ 8,000 ุนููู (customers)
โโโ 1,500 ุชุงุฌุฑ (providers)
โโโ 50 ูุฏูุฑ (admins)
โโโ 450 ุฒุงุฆุฑ (unauthenticated)
```

### 6.2 ุญูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุชููุน

| ุงููุตุฏุฑ                  | ุงูุญุณุงุจ                   | ุงูุงุณุชุนูุงูุงุช/ุซุงููุฉ |
| ----------------------- | ------------------------ | ----------------- |
| Customer Polling        | 8,000 ร 2 queries / 30s  | 533               |
| Customer getUser()      | 8,000 ร 1 / 30s          | 267               |
| Provider Polling        | 1,500 ร 6 queries / 60s  | 150               |
| Admin Polling           | 50 ร 5 queries / 30s     | 8                 |
| Middleware queries      | 10,000 ร 2 avg / 5s avg  | 4,000             |
| Page data fetches       | 10,000 ร 3 avg / 30s avg | 1,000             |
| Realtime WAL processing | Fixed overhead           | ~500              |
| governorates/static     | 10,000 ร 1 / 30s avg     | 333               |
| **ุงููุฌููุน**             |                          | **~6,791/ุซุงููุฉ**  |

### 6.3 Supabase Connection Limits

| ุงูุฎุทุฉ | Max Connections | ุงููุชุงุญ ุจุนุฏ system overhead |
| ----- | --------------- | -------------------------- |
| Free  | 60              | ~40                        |
| Pro   | 60              | ~40                        |
| Team  | 120             | ~90                        |

**ุงูุญุงูุฉ ุงูุญุงููุฉ:** 9 ุงุชุตุงูุงุช (ูู ุจูุงูุงุช DB). ููู ูุน 10K ูุณุชุฎุฏู:

- PostgREST pooler ูุฏูุฑ ุงูุงุชุตุงูุงุชุ ููู ~6,800 query/s ุนุจุฑ 40 connection = 170 query/connection/second
- PostgreSQL ุนูู Supabase Pro ูุนุงูุฌ ~10,000-15,000 query/s ูุญุฏ ุฃูุตู

### 6.4 ููุงุท ุงูุงูููุงุฑ ุงููุชููุนุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ุงูุชุฑุชูุจ ุงูุฒููู ุงููุชููุน ููุงูููุงุฑ ุนูุฏ 10K ูุชุฒุงูู:              โ
โ                                                                  โ
โ  โฑ๏ธ ุงูุฏูููุฉ 0-30:                                               โ
โ     - ุงููุธุงู ูุนูู ุจุจุทุก ููุญูุธ                                    โ
โ     - Response times ุชุฑุชูุน ูู 200ms ุฅูู 2-5 ุซูุงู               โ
โ     - Supabase connection pool ูุจุฏุฃ ุจุงูุงูุชูุงุก                    โ
โ                                                                  โ
โ  โฑ๏ธ ุงูุฏูููุฉ 30-60:                                              โ
โ     - Connection pool ูุดุจุน โ ุทูุจุงุช ุฌุฏูุฏุฉ ุชูุชุธุฑ ูู Queue         โ
โ     - Timeouts ุชุจุฏุฃ โ polling intervals ุชูุดู                     โ
โ     - ุงููุณุชุฎุฏููู ูุญุฏุซูู ุงูุตูุญุฉ (refresh) โ ุญูู ูุถุงุนู           โ
โ                                                                  โ
โ  โฑ๏ธ ุงูุณุงุนุฉ 1-2:                                                 โ
โ     - WAL processing ูุณุชููู CPU ุจุงููุงูู                          โ
โ     - Realtime subscriptions ุชูุดู ุจุตูุช (ูุง error handling)       โ
โ     - ุงูู polling ูุณุชูุฑ ุจุฏูู visibility guard                     โ
โ     - ุงููุณุชุฎุฏููู ูู ุงูุฎูููุฉ ูุฒูุฏูู ุงูุญูู ุจุฏูู ูุงุฆุฏุฉ              โ
โ                                                                  โ
โ  โฑ๏ธ ุงูุณุงุนุฉ 2-4:                                                 โ
โ     - PostgreSQL max CPU โ queries ุชูุดู                          โ
โ     - Supabase rate limits ุชููุนูู (ุฅุฐุง ููุช ุนูู Free/Pro)        โ
โ     - ุงูุณูุณุชู ูุณูุท ุชูุงูุงู ุฃู ูุตุจุญ ุบูุฑ ูุณุชุฌูุจ                    โ
โ     - ูุง ุฃุญุฏ ูุนุฑู โ ูุง ููุฌุฏ alerting!                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 6.5 ุงููุฎุงุทุฑ ุงูุฎูุณุฉ ุงููุงุชูุฉ

| #   | ุงููุฎุงุทุฑุฉ                       | ุงูุงุญุชูุงู   | ุงูุฃุซุฑ | ูุตู                                                           |
| --- | ------------------------------ | ---------- | ----- | ------------------------------------------------------------- |
| 1   | **DB CPU Exhaustion**          | ูุฑุชูุน ุฌุฏุงู | ูุงุฑุซู | 6,800 query/s + WAL processing ุชุชุฌุงูุฒ ูุฏุฑุฉ Supabase Pro       |
| 2   | **Connection Pool Saturation** | ูุฑุชูุน      | ูุงุฑุซู | 40 connection ูู 6,800 query/s = queue overflow               |
| 3   | **Memory Leak ูู Polling**     | ูุฑุชูุน      | ุนุงูู  | Tabs ูู ุงูุฎูููุฉ ุจุฏูู visibility guard ุชุณุชููู ููุงุฑุฏ ุจูุง ูุงุฆุฏุฉ  |
| 4   | **Double Orders under Load**   | ูุชูุณุท      | ุนุงูู  | ุจุฏูู idempotency keyุ latency ุนุงูู + retry = duplicate orders |
| 5   | **No Alerting**                | ูุคูุฏ       | ุนุงูู  | ูู ูุนุฑู ุฃุญุฏ ุฃู ุงููุธุงู ูุนุงูู ุญุชู ูุดุชูู ุงููุณุชุฎุฏููู              |

---

## ููุงุท ุงูููุฉ ุงูููุฏุณูุฉ

ุฑุบู ุงููุดุงููุ ุงููุดุฑูุน ูุญุชูู ุนูู ูุฑุงุฑุงุช ููุฏุณูุฉ ููุชุงุฒุฉ:

### 1. Commission Trigger (10/10)

ุงูุนูููุฉ ุชูุญุณุจ ุญุตุฑูุงู ุนุจุฑ PostgreSQL trigger โ ูุง ูููู ููู client ุงูุชูุงุนุจ ุจูุง. ูุฐุง ุงููุฑุงุฑ ูุญุฏู ูููุน ูุฆุฉ ูุงููุฉ ูู ุงูุซุบุฑุงุช ุงููุงููุฉ.

### 2. Payment Webhook Idempotency (10/10)

5 ุทุจูุงุช ุญูุงูุฉ ุถุฏ replay attacks ู race conditions. ูุฐุง ููุฏ enterprise-grade.

### 3. SDUI 3-Layer Fallback (9/10)

Defaults โ Cache โ Server. ุงูุชุทุจูู ูุง ูุชููู ุฃุจุฏุงู ุจุณุจุจ ูุดู SDUI. ูุนุงูุฌุฉ ุฎุทุฃ `42883` ุจุฐูุงุก.

### 4. Security Headers (9/10)

CSP ุดุงููุฉุ HSTS ูุน preloadุ CSRF double-submitุ XSS protection. ุนูู ูุณุชูู enterprise.

### 5. Financial Views as Source of Truth (9/10)

SQL views (`financial_settlement_engine`, `admin_financial_summary`) ุชุถูู ุฃู ุงูุฃุฑูุงู ุงููุงููุฉ ุชุฃุชู ุฏุงุฆูุงู ูู ูุตุฏุฑ ูุงุญุฏ.

### 6. Error Class Hierarchy (8/10)

`AppError โ ValidationError, AuthenticationError, RateLimitError` โ ูุน `toJSON()` ู `isOperational` flags. ูุจูู ุจุดูู ููุชุงุฒ.

### 7. Sentry Integration (8/10)

3 ุจูุฆุงุช (Client/Server/Edge)ุ data scrubbingุ smart filteringุ session replay.

### 8. Zod Client Validation (8/10)

Egyptian phone schemasุ address validationุ comprehensive order schemas.

### 9. Firebase Graceful Degradation (8/10)

Null-safe returnsุ feature detectionุ lazy loading. ูุง crashes ุฅุฐุง Firebase ูุนุทู.

### 10. RLS Security Hardening (7/10)

ุฅุตูุงุญ `OR true`ุ ุชุญููู views ูู `SECURITY INVOKER`ุ RBAC ูู middleware + API + DB layers.

---

## ุฎุฑูุทุฉ ุงูุทุฑูู ูู 99.9% Availability

### ุงููุฑุญูุฉ 0: ุฅููุงุฐ ููุฑู (ุฃุณุจูุน 1 โ ูุจู ุฃู growth) โ 90% ููุชูู โ

| #   | ุงูุฅุฌุฑุงุก                                                                         | ุงูุญุงูุฉ | ุงูุชูุงุตูู |
| --- | ------------------------------------------------------------------------------- | ------ | -------- |
| 1   | **ุชูุนูู Cache Layer ุงูููุฌูุฏ** ูู governorates, categories, maintenance settings | ๐ถ ุฌุฒุฆู | `src/lib/cache/cached-queries.ts` ูุญุชูู `getCachedGovernorates()` ู `getCachedBusinessCategories()` ู `getCachedDeliveryFees()`. ูููุนูู ูู `Footer.tsx` ููุท (ููู ูุงุญุฏ). ุจุงูู ุงูุฃูุงูู ุงูุชู ุชุณุชุนูู governorates/categories ูุง ุชุณุชุฎุฏู ุงูู cache ุจุนุฏ |
| 2   | **ุฅุถุงูุฉ `document.visibilitychange`** ููู polling                               | โ ููุชูู | `src/hooks/useVisibilityPolling.ts` ูููุฌุฒ ุจุงููุงูู ูุน visibility detection. ููุณุชุฎุฏู ูู `BottomNavigation.tsx` (ุณุทุฑ 74) ู `ProviderLayout.tsx` (ุฃุณุทุฑ 495-507) ูุน pause/resume ุนูุฏ ุชุบููุฑ ุญุงูุฉ ุงูู tab |
| 3   | **ุฅุฒุงูุฉ `getUser()` ูู BottomNavigation polling**                               | โ ููุชูู | `BottomNavigation.tsx` (ุฃุณุทุฑ 37-42) ูุฌูุจ userId ูุฑุฉ ูุงุญุฏุฉ ุนูุฏ mount ุจุงุณุชุฎุฏุงู `useEffect` ููุฎุฒูู ูู ref. ุงูู polling callback (ุฃุณุทุฑ 45-66) ูุณุชุฎุฏู ุงูู ref ุงูููุฎุฒู ุจุฏู ุงุณุชุฏุนุงุก `getUser()` ูู ุฏูุฑุฉ |
| 4   | **ุชุญููู pending orders ูู COUNT** ุจุฏู SELECT rows                               | โ ููุชูู | `ProviderLayout.tsx` (ุฃุณุทุฑ 410-469) ูุณุชุฎุฏู `select('*', { count: 'exact', head: true })` ูุฌููุน badge counts ุจูุง ูููุง pending orders. ููุฑุฌุน ุงูุนุฏุฏ ููุท ุจุฏูู ุฌูุจ ุงูุตููู |
| 5   | **ุชูุนูู Realtime Manager** ุจุฏู raw `.subscribe()` ูู ProviderLayout             | โ ููุชูู | `ProviderLayout.tsx` (ุฃุณุทุฑ 191-389) ูุณุชุฎุฏู `subscribeWithErrorHandling()` ูู `src/lib/supabase/realtime-manager.ts` ูุน exponential backoff ู polling fallback ู connection status tracking |

**ุงูุฃุซุฑ ุงูููุญูู:** ุชุฎููุถ queries/second ุจูุณุจุฉ ~40% โ ุงูุจูุฏ #1 ูุญุชุงุฌ ุชูุณูุน ุงุณุชุฎุฏุงู ุงูู cache ูุจููุฉ ุงูุฃูุงูู.

### ุงููุฑุญูุฉ 1: ุณูุงูุฉ ุงูุจูุงูุงุช (ุฃุณุจูุน 2) โ 100% ููุชูู โ

| #   | ุงูุฅุฌุฑุงุก                                                                             | ุงูุญุงูุฉ | ุงูุชูุงุตูู |
| --- | ----------------------------------------------------------------------------------- | ------ | -------- |
| 6   | **ุฅูุดุงุก RPC `create_order_atomic`** ูุฌูุน order + items + promo ูู transaction ูุงุญุฏุฉ | โ ููุชูู | Migration `supabase/migrations/20260226000001_create_order_atomic.sql` ุชููุดุฆ RPC ุจุฌููุน ุงูุฎุทูุงุช ุงูุฎูุณ ูู PostgreSQL transaction ูุงุญุฏุฉ. ุชุดูู idempotency key ู server-side price validation ู promo code atomic increment ูุน optimistic locking |
| 7   | **ุฅุถุงูุฉ server-side price validation** ูู RPC ุฃู API route                          | โ ููุชูู | ุงูู RPC ูุชุญูู ูู ุฃุณุนุงุฑ ุงูุฃุตูุงู (ุฃุณุทุฑ 78-112) ููุงุจู `menu_items` ู `product_variants`ุ ูุญุณุจ subtotal ุนูู ุงูุณูุฑูุฑ ูููุงุฑูู ุจุงููููุฉ ุงูููุฑุณูุฉ ูู ุงูุนููู ุจู tolerance 0.01. ูุณุชุฎุฏู ุงูุณุนุฑ ุงููุญุณูุจ server-side (ุณุทุฑ 158) |
| 8   | **ุฅุถุงูุฉ idempotency key** (UUID) ูุน unique constraint ุนูู orders                    | โ ููุชูู | Migration ุชูุถูู ุนููุฏ `idempotency_key UUID` ููู orders (ุณุทุฑ 17) ูุน unique constraint (ุฃุณุทุฑ 18-20). ุงูู RPC ููุญุต ูุฌูุฏ ุทูุจ ุณุงุจู ุจููุณ ุงูููุชุงุญ (ุฃุณุทุฑ 63-75) ูููุฑุฌุน idempotent flag |
| 9   | **ุฅุถุงูุฉ status transition guards** (`WHERE status = ?`)                             | โ ููุชูู | Migration ุชููุดุฆ trigger `guard_order_status_transition()` (ุฃุณุทุฑ 262-304) ููุนุฑูู ุงูุชุญููุงุช ุงููุณููุญุฉ (pendingโconfirmed/cancelled, confirmedโpreparing/cancelled, ุฅูุฎ) ููุฑูุถ ุงูุชุญููุงุช ุบูุฑ ุงูุตุงูุญุฉ |
| 10  | **ุฅุตูุงุญ profiles RLS** โ column-level access ุฃู USING ูุน owner check                | โ ููุชูู | Migration `supabase/migrations/20260226000002_fix_profiles_rls.sql` ุชูุทุจูู 4 ุณูุงุณุงุช: ุงููุณุชุฎุฏู ููุฑุฃ ูููู ุงูุดุฎุตู (ุณุทุฑ 27)ุ ุงูุฃุฏูู ููุฑุฃ ุงูุฌููุน (ุณุทุฑ 36)ุ ูุงูู ุงููุชุฌุฑ ููุฑุฃ ูููุงุช ุนููุงุฆู (ุฃุณุทุฑ 39-49)ุ ูุงูููุธููู ููุฑุคูู ูููุงุช ุงูุนููุงุก (ุฃุณุทุฑ 52-63) |

### ุงููุฑุญูุฉ 2: ุฃุฏุงุก ุงูู Frontend (ุฃุณุจูุน 3-4) โ 25% ููุชูู

| #   | ุงูุฅุฌุฑุงุก                                                           | ุงูุญุงูุฉ | ุงูุชูุงุตูู |
| --- | ----------------------------------------------------------------- | ------ | -------- |
| 11  | **ุชุญููู Home Page ูู Server Component** ูุน `fetch` + `revalidate` | โ ูู ูุจุฏุฃ | `src/app/[locale]/page.tsx` (ุณุทุฑ 1) ูุง ูุฒุงู ูุญุชูู `'use client'`. ุงูุตูุญุฉ ุชุฌูุจ ุงูุจูุงูุงุช client-side ุนุจุฑ hooks ุจุฏูุงู ูู server-side ูุน revalidate |
| 12  | **ุฅุถุงูุฉ `loading.tsx`** ูุฃูู 20 route                             | โ ูู ูุจุฏุฃ | 4 ูููุงุช `loading.tsx` ููุท: `[locale]/loading.tsx`, `[locale]/admin/loading.tsx`, `[locale]/provider/loading.tsx`, `[locale]/auth/callback/loading.tsx`. ูุฐุง 3.4% ูู 117 route โ ุจุนูุฏ ุนู ูุฏู 20 route |
| 13  | **ุชูุณูู ุงููููุงุช ุงููุจูุฑุฉ** (>1500 ุณุทุฑ) ุจู `next/dynamic`           | ๐ถ ุฌุฒุฆู | ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ุชุณุชุฎุฏู `next/dynamic` ูู `CategoriesSection` (ุฃุณุทุฑ 12-29). ููู 3 ุงุณุชุฎุฏุงูุงุช ููุท ูู `next/dynamic` ูู ูุงูู ุงููุดุฑูุน. ุงููููุงุช ุงููุจูุฑุฉ ูุง ุชุฒุงู ููุง ูู: provider/settings (2909 ุณุทุฑ), checkout (2278 ุณุทุฑ), admin/banners (2209 ุณุทุฑ), admin/locations (2017 ุณุทุฑ), provider/finance (1985 ุณุทุฑ) |
| 14  | **ุฅุถุงูุฉ ISR** ูู providers listing, categories, governorates      | ๐ถ ุฌุฒุฆู | ISR ูููุนูู ูู `providers/page.tsx` (`revalidate=300`) ู `providers/[id]/page.tsx` (`revalidate=300`). ูุง ููุฌุฏ ISR ูุตูุญุงุช categories ุฃู governorates |

### ุงููุฑุญูุฉ 3: ุงููุชุงูุฉ ูุงููุฑุงูุจุฉ (ุฃุณุจูุน 5-6) โ 17% ููุชูู

| #   | ุงูุฅุฌุฑุงุก                                                 | ุงูุญุงูุฉ | ุงูุชูุงุตูู |
| --- | ------------------------------------------------------- | ------ | -------- |
| 15  | **ุชูุนูู `withErrorHandler`** ูู ุฌููุน API routes         | โ ูู ูุจุฏุฃ | `src/lib/api/error-handler.ts` ูุญุชูู ุงูุฏุงูุฉ `withErrorHandler()` ุฌุงูุฒุฉ ููุงุณุชุฎุฏุงู. ููู **0 ูู 45** API route ูุณุชุฎุฏููุง ูุนููุงู. ุฌููุน ุงูู routes ุชุณุชุฎุฏู try-catch ูุฏูู |
| 16  | **ุชูุนูู `withValidation`** ูู ุฌููุน API routes           | โ ูู ูุจุฏุฃ | `src/lib/api/validate.ts` ููุตุฏูุฑ `withValidation()`. **0 API routes** ุชุณุชุฎุฏู ูุฐุง ุงูู wrapper. endpoint ุงูุชุณุฌูู (`auth/register/route.ts`) ูุนูู validation ูุฏูู ุจุฏูุงู ูู ุงุณุชุฎุฏุงู ุงูู wrapper |
| 17  | **ุฅุถุงูุฉ Alerting** (Slack/PagerDuty) ูู critical errors | โ ูู ูุจุฏุฃ | ูุง ููุฌุฏ ุฃู ุชูุงูู ูุน Slack webhooks ุฃู PagerDuty ูู ุงููุดุฑูุน. Sentry ูููุนูู ูุชุชุจุน ุงูุฃุฎุทุงุก ููู ุจุฏูู ุชูุจููุงุช ุฎุงุฑุฌูุฉ |
| 18  | **Rate limiting ูู register, contact, banners/track**   | ๐ถ ุฌุฒุฆู | `promo/validate` ูุญุชูู rate limiting in-memory (ุฃุณุทุฑ 34-50). Chat API ูุณุชุฎุฏู Upstash Redis rate limiting. ููู **ูุง ููุฌุฏ rate limiting** ุนูู `auth/register`, `contact`, ุฃู `banners/track` ุชุญุฏูุฏุงู |
| 19  | **ุญุฐู ุงูู 120+ ููุฑุณ ุงูููุช**                             | โ ููุชูู | Migration `20260225000001_fix_unused_indexes.sql` ุชุญุฐู 9 ููุงุฑุณ ุบูุฑ ูุณุชุฎุฏูุฉ (ุฃุณุทุฑ 18-38) ุจุดูู ูููุฌู ุจูุงุกู ุนูู ุจูุงูุงุช `pg_stat_user_indexes` |
| 20  | **ุชูููู Realtime publication** ููุฌุฏุงูู ุงููุทููุจุฉ ููุท     | โ ูู ูุจุฏุฃ | Migrations `20251207000005` ู `20251207000006` **ุชูุถูู** ุฌุฏุงูู ูู `supabase_realtime` publication ุจุฏูุงู ูู ุฅุฒุงูุชูุง. ูู ูุชู ุชูููู ูุทุงู ุงูู publication ููุฌุฏุงูู ุงููุทููุจุฉ ููุท |

### ุงููุฑุญูุฉ 4: ุงูุชุญุฌูู (ุฃุณุจูุน 7-8) โ 10% ููุชูู

| #   | ุงูุฅุฌุฑุงุก                                                   | ุงูุญุงูุฉ | ุงูุชูุงุตูู |
| --- | --------------------------------------------------------- | ------ | -------- |
| 21  | **Cart price re-validation** ุนูุฏ checkout                 | ๐ถ ุฌุฒุฆู | ุตูุญุฉ Checkout ุชุฑุณู ุงูุฃุณุนุงุฑ ุงููุญุณูุจุฉ client-side ููุณูุฑูุฑ. ุงูู RPC `create_order_atomic` ูุชุญูู ูู ุงูุฃุณุนุงุฑ ููุทูุจุงุช ุงูุฌุฏูุฏุฉ ุนุจุฑ ุงูุฏุงูุฉ ุงูุฐุฑูุฉุ ููู ูุง ููุฌุฏ re-validation ุนูุฏ ูุชุญ ุตูุญุฉ checkout ููุณูุง ููุงุจู ุงูุฃุณุนุงุฑ ุงูุญุงููุฉ ูู `menu_items` |
| 22  | **ุชูุนูู `strongPasswordSchema`** ูู auth                  | โ ูู ูุจุฏุฃ | `src/lib/validations/common.ts` ููุนุฑูู `strongPasswordSchema` ููููุง ุบูุฑ ูุณุชูุฑุฏุฉ ุฃู ููุณุชุฎุฏูุฉ ูู ุฃู ุตูุญุฉ auth. ุตูุญุงุช ุงูุชุณุฌูู ูุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ ูุง ุชุชุญูู ููุงุจู ูุฐุง ุงูู schema |
| 23  | **ุฅุตูุงุญ error boundaries locale** โ ุงุณุชุฎุฑุงุฌ locale ูู URL | โ ูู ูุจุฏุฃ | Error boundaries ุชุญุชูู ุฑูุงุจุท hardcoded ูู `/ar`: `error.tsx` ุณุทุฑ 95 `href="/ar"`ุ `provider/error.tsx` ุชุญุชูู `href="/ar/provider"`ุ `admin/error.tsx` ููุณ ุงููุดููุฉ. ูุฌุจ ุงุณุชุฎุฑุงุฌ locale ุฏููุงููููุงู ูู URL |
| 24  | **ุฅุถุงูุฉ Edge config data scrubbing**                      | โ ูู ูุจุฏุฃ | `sentry.edge.config.ts` (ุฃุณุทุฑ 33-47) ูุญุชูู `beforeSend()` ููุฑุดูุญ ุงูุฃุฎุทุงุก ุงูุดุงุฆุนุฉุ ููู **ูุง ููุฌุฏ data scrubbing** ูู auth headers ุฃู ุงูุจูุงูุงุช ุงูุญุณุงุณุฉ ููุง ูู server config. ุงูู headers ูุฏ ุชุชุณุฑุจ ูู Sentry ูู middleware |
| 25  | **ุชูุนูู Upstash ูู promo validation** ุจุฏู in-memory       | โ ูู ูุจุฏุฃ | `src/app/api/promo/validate/route.ts` (ุฃุณุทุฑ 34-50) ูุณุชุฎุฏู rate limiting in-memory (`rateLimitMap`). ูุฐุง ูุง ูุนูู ุนุจุฑ serverless instances. ูู ูุชู ุงูุชุฑุญูู ูู Upstash Redis ููุง ูู Chat API |

---

## ุงูุฎูุงุตุฉ

### ุงูุชูุฏู ุงูููุญูู

```
ุงูุชูููู ุงูุฃุตูู:         ุงููุถุน ุงูุญุงูู (ุจุนุฏ ุงูุชูููุฐ):   ุงููุฏู (ุจุนุฏ ูู ุงููุฑุงุญู):
โโโโโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโโโ
Score: 61/100          Score: ~78/100 (+17)          Score: ~92/100
Max Users: ~2,000      Max Users: ~8,000 โ          Max Users: ~25,000+
Downtime: hours        Downtime: minutes โ          Downtime: <5min/month
Alerting: none         Alerting: none โ             Alerting: comprehensive
Data Safety: risky     Data Safety: solid โ         Data Safety: excellent
```

### ูุง ุชู ุฅูุฌุงุฒู (ููุฎุต)

**ุงููุฑุญูุฉ 0+1 (ุงูุฃูุซุฑ ุฃูููุฉ) ุดุจู ููุชููุฉ:**
- โ ุงูุทูุจุงุช ุฃุตุจุญุช ุฐุฑูุฉ (atomic) โ ูุง ุทูุจุงุช ูุชููุฉ ุจุนุฏ ุงูุขู
- โ ุงูุชุญูู ูู ุงูุฃุณุนุงุฑ server-side โ ูุง ุชูุงุนุจ ุจุงูุฃุณุนุงุฑ
- โ ุญูุงูุฉ ุงูุชูุฑุงุฑ (idempotency key) โ ูุง double-submit
- โ ุญุฑุงุณุฉ ุชุญููุงุช ุงูุญุงูุฉ โ ูุง state transitions ุบูุฑ ุตุงูุญุฉ
- โ ุฅุตูุงุญ RLS ููููุงุช ุงููุณุชุฎุฏููู โ ูุง ุชุณุฑุจ PII
- โ Realtime Manager ูุน error recovery โ ุงุชุตุงูุงุช ูุณุชูุฑุฉ
- โ Visibility guard ููู polling โ ุชูููุฑ 30-50% ูู ุงูุงุณุชุนูุงูุงุช
- โ COUNT ุจุฏู SELECT ููู pending orders โ ุชูููู ููู ุงูุจูุงูุงุช 90%
- โ ุญุฐู ุงูููุงุฑุณ ุงูููุชุฉ โ ุชุญุณูู Write performance

### ูุง ุชุจูู โ ุฃููููุฉ ุงูุชูููุฐ

| ุงูุฃููููุฉ | ุงูุจูุฏ | ุงูุณุจุจ | ุงูุฌูุฏ |
| -------- | ----- | ----- | ----- |
| ๐ด 1 | **#15+16: ุชูุนูู `withErrorHandler` ู `withValidation`** | ุงูููุฏ **ุฌุงูุฒ** ููุญุชุงุฌ ููุท ุฑุจุทู ุจู 45 API route. ุฃุนูู ROI ูุชุจูู | 20 ุณุงุนุฉ |
| ๐ด 2 | **#1: ุชูุณูุน ุงุณุชุฎุฏุงู Cache Layer** | ููุณุชุฎุฏู ูู ููุงู ูุงุญุฏ ููุท (`Footer.tsx`). ูุญุชุงุฌ ุชูุนูู ูู ูู ุงูุฃูุงูู | 4 ุณุงุนุงุช |
| ๐ 3 | **#20: ุชูููู Realtime publication** | ูู ุงูุฌุฏุงูู ูุดุชุฑูุฉ ูู WAL โ ูุญุชุงุฌ ุชุญุฏูุฏ ุงูุฌุฏุงูู ุงููุทููุจุฉ ููุท | 4 ุณุงุนุงุช |
| ๐ 4 | **#17: ุฅุถุงูุฉ Alerting** | ูุง ููุฌุฏ ุฃู ุชูุจูู ุนูุฏ ุญุฏูุซ ูุดุงูู โ ุฎุทุฑ ูุจูุฑ ุนูู ุงูุฅูุชุงุฌ | 4 ุณุงุนุงุช |
| ๐ 5 | **#12: ุฅุถุงูุฉ `loading.tsx`** ูุฃูู 20 route | 4 ููุท ูู 117 route โ ุดุงุดุฉ ุจูุถุงุก ููุนุธู ุงููุณุชุฎุฏููู | 8 ุณุงุนุงุช |
| ๐ก 6 | **#11: ุชุญููู Home Page ูู Server Component** | ูุง ูุฒุงู `'use client'` โ ูุคุซุฑ ุนูู SEO ู LCP | 12 ุณุงุนุฉ |
| ๐ก 7 | **#22-25: ุจููุฏ ุงูุชุญุฌูู ุงูุตุบูุฑุฉ** | `strongPasswordSchema`, error boundaries locale, edge scrubbing, Upstash | 5 ุณุงุนุงุช |

### ุงููุฑุงุฑุงุช ุงูููุฏุณูุฉ ุงูุชู ูุง ุชุฒุงู ูุทููุจุฉ

1. **`withErrorHandler` ู `withValidation` ูุง ูุฒุงูุงู ุบูุฑ ูููุนูููู** โ ูุฐุง ูุจูู ุฃุฎุทุฑ ูุฑุงุฑ ููุฏุณู ูู ุงููุดุฑูุน. ุงูุฃูุธูุฉ ูุจููุฉ ุจุดูู ููุชุงุฒ ููู ุงููุฌูุฉ ุจูู "ูุจูู" ู "ูููุนูู" ุชุนุทู ุฅุญุณุงุณุงู ุฒุงุฆูุงู ุจุงูุฃูุงู
2. **ุงูู Frontend ูุง ูุฒุงู ุถุนููุงู** โ 95.7% client-rendered ูุน 4 `loading.tsx` ููุท ูู 117 route
3. **ูุง ููุฌุฏ Alerting** โ ุฅุฐุง ุญุฏุซ ุฎูู ูู ุงูุณุงุนุฉ 3 ุตุจุงุญุงูุ ูู ูุนุฑู ุฃุญุฏ

---

_ุชูุฑูุฑ ูููุดุฃ ุจุชุงุฑูุฎ: 26 ูุจุฑุงูุฑ 2026_
_ุขุฎุฑ ุชุญุฏูุซ ูุญุงูุฉ ุงูุชูููุฐ: 26 ูุจุฑุงูุฑ 2026_
_ุงูููุนุฏ: Claude โ Senior Software Architect Audit_
_ูุณุจุฉ ุงูุฅูุฌุงุฒ: 48% (10 ููุชููุ 5 ุฌุฒุฆูุ 10 ูู ูุจุฏุฃ)_
