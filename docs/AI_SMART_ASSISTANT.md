# ูุณุงุนุฏ ุฅูุฌุฒูุง ุงูุฐูู - AI Smart Assistant

> **ุญุงูุฉ ุงููุดุฑูุน:** โ ูุญุฏูุซ - ุชู ุฅุถุงูุฉ Direct Payload Handlers

---

## ูุธุฑุฉ ุนุงูุฉ

ูุณุงุนุฏ ุฐูู ููุฏุฑุฏุดุฉ ุฏุงุฎู ุชุทุจูู ุฅูุฌุฒูุง ููุชูุตููุ ูุณุชุฎุฏู GPT-4o-mini ูุน OpenAI Function Calling ููุณุงุนุฏุฉ ุงูุนููุงุก ูู:
- ุงุฎุชูุงุฑ ุงูุฃูุณุงู ูุงููุชุงุฌุฑ
- ุงูุจุญุซ ุนู ุงูููุชุฌุงุช
- ุงุณุชุนุฑุงุถ ุงูุนุฑูุถ
- ุฅุถุงูุฉ ุงูููุชุฌุงุช ููุณูุฉ

### ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ (13 ุฏูุณูุจุฑ 2025)
- **๐ Direct Payload Handlers**: ูุนุงูุฌุฉ ุฃุฒุฑุงุฑ ุงูุงุฎุชูุงุฑ (category, provider, item, variant) ูุจุงุดุฑุฉ ุจุฏูู GPT
- **๐พ Memory System**: ุญูุธ pending_item ู pending_variant ูู ุงูุฐุงูุฑุฉ ููุชุงุจุนุฉ ุงูุณูุงู
- **๐ข Arabic Quantity Parser**: ุชุญููู ุงูุฃุฑูุงู ุงูุนุฑุจูุฉ (ูุงุญุฏุ ุงุชูููุ ูข) ูููููุฉ
- **โก Faster Response**: ุฑุฏูุฏ ููุฑูุฉ ูุฃุฒุฑุงุฑ ุงูุงุฎุชูุงุฑ ุจุฏูู ุงุณุชุฏุนุงุก OpenAI
- **Intent Router**: ูุธุงู ุฐูู ูุงูุชุดุงู ููุฉ ุงููุณุชุฎุฏู ูุฅุฌุจุงุฑ ุงุณุชุฏุนุงุก Tools
- **Quick Replies ูู DB**: ุชูููุฏ ุฃุฒุฑุงุฑ ุชููุงุฆูุฉ ูู ูุชุงุฆุฌ ุงูุจุญุซ
- **ุฏุนู ุฃูุถู ููุฃุณูุงุก ุงูุนุฑุจูุฉ**: ุงูุจุญุซ ุนู ูุชุงุฌุฑ ุจุงูุงุณู ูุซู "ุงูุตูุง"

---

## ุงููููุงุช ุงูุฑุฆูุณูุฉ

| ุงูููู | ุงููุตู |
|-------|-------|
| `src/app/api/chat/route.ts` | API endpoint ุงูุฑุฆูุณู |
| `src/lib/ai/systemPrompt.ts` | System Prompt ุจุงูุนุฑุจูุฉ ุงููุตุฑูุฉ |
| `src/lib/ai/tools.ts` | ุชุนุฑูู OpenAI Function Calling Tools |
| `src/lib/ai/normalizeArabic.ts` | **ุฌุฏูุฏ** - ุชุทุจูุน ุงููุต ุงูุนุฑุจู ููุจุญุซ |
| `src/hooks/useAIChat.ts` | React Hook ููุชูุงุนู ูุน API |
| `src/lib/store/chat.ts` | Zustand Store ูุญูุธ ุงููุญุงุฏุซุงุช |
| `src/components/customer/voice/SmartAssistant.tsx` | UI Component |

---

## ุงูููุฒุงุช ุงูููููููุฐุฉ (ูุฐู ุงูุฌูุณุฉ)

### 1. ุชุทุจูุน ุงููุต ุงูุนุฑุจู (Arabic Normalization)

**ููู:** `src/lib/ai/normalizeArabic.ts`

ูุญู ูุดููุฉ ุงูุจุญุซ ุนู ูููุงุช ูุซู "ููุชุฉ" ู "ููุชู" ุจูุชุงุฆุฌ ูุฎุชููุฉ.

**ุงูุชุญูููุงุช:**
- `ุฉ โ ู` (ุชุงุก ูุฑุจูุทุฉ)
- `ู โ ู` (ุฃูู ููุตูุฑุฉ)
- `ุฃ, ุฅ, ุข โ ุง` (ุฃููุงุน ุงูุฃูู)
- `ุค โ ู`, `ุฆ โ ู` (ุงูููุฒุฉ)
- ุฅุฒุงูุฉ ุงูุชุดููู (ุงููุชุญุฉุ ุงูุถูุฉุ ุงููุณุฑุฉ...)

**ูุซุงู:**
```typescript
normalizeArabic("ููุชุฉ") // โ "ููุชู"
normalizeArabic("ูููุฎููุฉ") // โ "ูููุฎูู"
```

### 2. ุงุฎุชูุงุฑ ุงููุชุฌุฑ ุจุงูุงุณู (Provider Name Resolution)

**ุงููุดููุฉ:** ุงููุณุชุฎุฏู ูููู "ูู ุณูุทุงู ุงูุจูุชุฒุง" ูุงููุธุงู ูุญุชุงุฌ UUID.

**ุงูุญู:** ุฏุงูุฉ `resolveProviderByName()` ุชุญูู ุงูุงุณู ุฅูู UUID ุชููุงุฆูุงู.

**ูุนูู ูู:**
- `get_provider_menu`
- `search_in_provider`
- `get_promotions`

### 3. ุนุฑุถ ุงูุนุฑูุถ ูุน ุงูุฃุตูุงู ุงููุญุฏุฏุฉ

**ุงููุดููุฉ:** ุงูุนุฑูุถ ุงูุชู `applies_to = 'specific'` ูู ุชูุธูุฑ ุงูุฃุตูุงู ุงููุชุฃุซุฑุฉ.

**ุงูุญู:**
- ุฌูุจ `product_ids` ูู ุงูุนุฑุถ
- ุฌูุจ ุชูุงุตูู ุงูุฃุตูุงู ูู `menu_items`
- ุฅุถุงูุชูุง ูู `affected_products` ูู ุงูุฑุฏ

### 4. ุฅุตูุงุญ ุนุฑุถ ุงูุฃุณุนุงุฑ

**ุงููุดููุฉ:** ุงููุณุงุนุฏ ูุงู ูููู "ูุด ูุงุฏุฑ ุฃููู ุงูุฃุณุนุงุฑ" ุฑุบู ูุฌูุฏูุง ูู ุงูุจูุงูุงุช.

**ุงูุญู:** ูุงุนุฏุฉ ุตุฑูุญุฉ ูู System Prompt:
> "ูู ุงูุณุนุฑ ููุฌูุฏ ูู ูุชูุฌุฉ Tool Call โ ูุงุฒู ุชูููู ูููุณุชุฎุฏู ุจุงูุฃุฑูุงู"

### 5. ุญูุธ ุงููุณู ุงููุฎุชุงุฑ (selected_category)

**ุงููุดููุฉ:** ุงููุณุงุนุฏ ูุงู ูุณุฃู ุนู ุงููุณู ูุฑุฉ ุฃุฎุฑู ุจุนุฏ ุงุฎุชูุงุฑู.

**ุงูุญู:**
- ุฅุถุงูุฉ `selectedCategory` ูู Zustand Store
- ุฅุฑุณุงููุง ูุน ูู ุทูุจ API
- ูุงุนุฏุฉ ูู System Prompt: "ูู selected_category ููุฌูุฏ: ูุง ุชุณุฃู ุนู ุงููุณู"

### 6. Intent Router (Zapier-style)

**ุงููุดููุฉ:** ุงููุณุงุนุฏ ูุงู ูุฑุฏ ุฃุญูุงูุงู ุจุฏูู ุงุณุชุฏุนุงุก Tools.

**ุงูุญู:** ูุธุงู Intent Router ูุญูู ุฑุณุงูุฉ ุงููุณุชุฎุฏู ููุฌุจุฑ ุงุณุชุฏุนุงุก Tool ูุนูู:

| ุงูููุฉ | ุงููููุงุช ุงูููุชุงุญูุฉ | Tool ุงูููุฌุจูุฑ |
|-------|------------------|--------------|
| ุนุฑูุถ | ุนุฑูุถุ ุฎุตูุ promotions | `get_promotions` |
| ุชุญูุฉ | ูุงูุ ุงูุณูุงูุ ุฃููุง | `get_available_categories_in_city` |
| ุจุญุซ ููุชุฌ | ุนุงูุฒุ ุนุงูุฒุ ููุฌูุฏ | `search_in_provider` ุฃู `search_product_in_city` |
| ุงุฎุชูุงุฑ ูุชุฌุฑ | ูู Xุ ุนูุฏ Xุ ูุทุนู X | `search_providers` |

**ูุซุงู:**
```typescript
// ุงููุณุชุฎุฏู: "ุงูุตูุง"
// โ Intent: provider_selection
// โ Forced Tool: search_providers
// โ Args: { query: "ุงูุตูุง" }
```

### 7. ุชูููุฏ Quick Replies ูู ูุชุงุฆุฌ DB

**ุงููุดููุฉ:** ุงูุฃุฒุฑุงุฑ ูู ุชูู ุชูุนุฑุถ ูููุณุชุฎุฏู ุจุนุฏ ุงูุจุญุซ.

**ุงูุญู:** ุฏุงูุฉ `generateQuickRepliesFromToolResults()` ุชุญูู ูุชุงุฆุฌ DB ูุฃุฒุฑุงุฑ:

| Tool | ููุน ุงูุฃุฒุฑุงุฑ |
|------|------------|
| `search_providers` | ุฃุฒุฑุงุฑ ูุชุงุฌุฑ `provider:<id>` |
| `get_provider_menu` | ุฃุฒุฑุงุฑ ุฃุตูุงู `item:<id>` ูุน ุงูุณุนุฑ |
| `get_promotions` | ุฃุฒุฑุงุฑ ุงูุนุฑูุถ + ุงูุฃุตูุงู ุงููุชุฃุซุฑุฉ |
| `get_item_variants` | ุฃุฒุฑุงุฑ ุงูุฃุญุฌุงู `variant:<id>` ูุน ุงูุณุนุฑ |

---

## Tools ุงููุชุงุญุฉ (OpenAI Function Calling)

| Tool | ุงููุตู |
|------|-------|
| `get_customer_name` | ุฌูุจ ุงุณู ุงูุนููู ููุชุฑุญูุจ |
| `get_available_categories_in_city` | ุงูุฃูุณุงู ุงููุชุงุญุฉ ูู ุงููุฏููุฉ |
| `search_providers` | ุงูุจุญุซ ุนู ูุชุงุฌุฑ (ุจุงููุณู ุฃู ุงูุงุณู) |
| `get_provider_menu` | ูุงุฆูุฉ ููุชุฌุงุช ูุชุฌุฑ |
| `search_in_provider` | ุงูุจุญุซ ุฏุงุฎู ูุชุฌุฑ |
| `get_menu_item_details` | ุชูุงุตูู ููุชุฌ |
| `get_item_variants` | ุฃุญุฌุงู/ุงุฎุชูุงุฑุงุช ุงูููุชุฌ |
| `get_variant_details` | ุชูุงุตูู ุงุฎุชูุงุฑ |
| `get_promotions` | ุงูุนุฑูุถ ุงููุดุทุฉ |
| `search_product_in_city` | ุงูุจุญุซ ุนู ููุชุฌ ูู ูู ุงููุชุงุฌุฑ |

---

## Payloads ุงููุฏุนููุฉ

| Payload | ุงููุตู | ูุซุงู |
|---------|-------|------|
| `category:<code>` | ุงุฎุชูุงุฑ ูุณู | `category:restaurant_cafe` |
| `provider:<uuid>` | ุงุฎุชูุงุฑ ูุชุฌุฑ | `provider:abc123-...` |
| `item:<uuid>` | ุงุฎุชูุงุฑ ููุชุฌ | `item:xyz789-...` |
| `variant:<uuid>` | ุงุฎุชูุงุฑ ุญุฌู/ููุน | `variant:def456-...` |

---

## ูููู API Request

```typescript
interface ChatAPIRequest {
  messages: Array<{ role: 'user' | 'assistant'; content: string }>
  customer_id?: string
  city_id: string // ุฅูุฒุงูู
  selected_provider_id?: string
  selected_provider_category?: string
  selected_category?: string // ุฌุฏูุฏ - ุงููุณู ุงููุฎุชุงุฑ
  memory?: Record<string, unknown>
}
```

---

## ูููู API Response

```typescript
interface ChatAPIResponse {
  reply: string
  quick_replies?: Array<{ title: string; payload: string }>
  cart_action?: {
    type: 'ADD_ITEM'
    provider_id: string
    menu_item_id: string
    menu_item_name_ar: string
    quantity: number
    unit_price: number
    variant_id?: string
    variant_name_ar?: string
  }
  selected_provider_id?: string
  selected_provider_category?: string
  selected_category?: string
  memory?: Record<string, unknown>
}
```

---

## ููุงุนุฏ ููุงูุญุฉ ุงููููุณุฉ (Anti-Hallucination)

1. **ูุง ุชุฏุนู ูุฌูุฏ ุดูุก** ุฅูุง ุฅุฐุง ุฑุฌุน ูู Tool Call
2. **ูุง ุชุคูู ุฃุณูุงุก** ูุชุงุฌุฑ ุฃู ููุชุฌุงุช
3. **ูุง ุชุฐูุฑ ุฃุณุนุงุฑ** ุฅูุง ูู DB
4. **ูู ุงููุชูุฌุฉ ูุงุฑุบุฉ** โ ูู "ูุด ูุงูู ูุชุงูุฌ"
5. **ูู ุงูุณุนุฑ ููุฌูุฏ** โ ูุงุฒู ุชูููู (ููููุน "ูุด ุนุงุฑู")

---

## Logging

ุงูู Console ููุธูุฑ:
- `๐ฏ [INTENT ROUTER]` - ุชุญููู ููุฉ ุงููุณุชุฎุฏู
- `๐ฏ [INTENT]` - ุงูููุฉ ุงูููุชุดูุฉ
- `๐ [AI TOOL CALL]` - ุจุฏุงูุฉ ุงุณุชุฏุนุงุก tool
- `๐ฆ [AI RESULT]` - ูุชูุฌุฉ ุงูุงุณุชุฏุนุงุก
- `๐ค [NORM FILTER]` - ููุชุฑุฉ ุงูุชุทุจูุน ุงูุนุฑุจู
- `๐จ [AI EMPTY]` - ูุชูุฌุฉ ูุงุฑุบุฉ
- `โ [PROVIDER RESOLVE]` - ูุฌุงุญ ุชุญููู ุงุณู ูู UUID
- `๐ [QUICK REPLIES]` - ุชูููุฏ ุฃุฒุฑุงุฑ ูู ุงููุชุงุฆุฌ

---

## ุงูููุงู ุงููุชุจููุฉ (ููุฌูุณุฉ ุงููุงุฏูุฉ)

- [ ] ุงุฎุชุจุงุฑ ุดุงูู ููุณููุงุฑูููุงุช ูู Production
- [ ] ุฅุถุงูุฉ caching ูููุชุงุฆุฌ ุงููุชูุฑุฑุฉ
- [ ] ุชุญุณูู ุฃุฏุงุก ุงูุจุญุซ ูููุฏู ุงููุจูุฑุฉ

---

## ูุธุงู Direct Payload Handlers (ุฌุฏูุฏ)

### ููู ูุนููุ

ุจุฏูุงู ูู ุฅุฑุณุงู ูู ุฑุณุงูุฉ ูู GPTุ ุงููุธุงู ุงูุฌุฏูุฏ ูุนุงูุฌ ุงูุฃุฒุฑุงุฑ ูุจุงุดุฑุฉ:

```
User clicks "ุญูุงูุดู ูุญูุฉ (55 ุฌ.ู)" โ item:abc123
                                          โ
                               Direct Handler (NO GPT)
                                          โ
                           Get item details + variants
                                          โ
                        Show variant buttons + save to memory
```

### Payloads ุงููุฏุนููุฉ

| Payload | Handler | ุงููุตู |
|---------|---------|-------|
| `category:xxx` | `handleCategoryPayload()` | ุนุฑุถ ุงููุชุงุฌุฑ ูู ุงููุณู |
| `provider:xxx` | `handleProviderPayload()` | ุนุฑุถ ูููู ุงููุชุฌุฑ |
| `item:xxx` | `handleItemPayload()` | ุนุฑุถ variants ุฃู ุณุคุงู ุงููููุฉ |
| `variant:xxx` | `handleVariantPayload()` | ุณุคุงู ุงููููุฉ |
| `qty:x` | `handleQuantityInput()` | ุฅุถุงูุฉ ููุณูุฉ |

### Memory System

```typescript
interface ChatMemory {
  pending_item?: {
    id: string
    name_ar: string
    price: number
    provider_id: string
    provider_name_ar?: string
    has_variants?: boolean
  }
  pending_variant?: {
    id: string
    name_ar: string
    price: number
  }
  awaiting_quantity?: boolean
}
```

### Arabic Quantity Parser

ูุฏุนู ุชุญููู:
- ุฃุฑูุงู ุฅูุฌููุฒูุฉ: `1`, `2`, `3`...
- ุฃุฑูุงู ุนุฑุจูุฉ: `ูก`, `ูข`, `ูฃ`...
- ูููุงุช: `ูุงุญุฏ`, `ุงุชููู`, `ุชูุงุชู`...
- ูููุงุช ุดุงุฆุนุฉ: `ุนุงุฏู` = 1

---

## ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ (Acceptance Tests)

| # | ุงููุฏุฎู | ุงููุชูุฌุฉ ุงููุชููุนุฉ | Status |
|---|--------|-----------------|--------|
| 1 | "ุนุงูุฒ ููุชู" / "ููุชุฉ" | ููุณ ุงููุชุงุฆุฌ (ุชุทุจูุน ุนุฑุจู) | โ |
| 2 | "ูู ุณูุทุงู ุงูุจูุชุฒุง" | ุชุญููู ุงูุงุณู ูู UUID + ุนุฑุถ ุงููููู | โ |
| 3 | "ุงูุตูุง" | ุงูุจุญุซ ุนู ุงููุชุฌุฑ + ุนุฑุถ ุฃุฒุฑุงุฑ | โ |
| 4 | "ูููู ุงุณุนุงุฑูู" | ุนุฑุถ ุงูุฃุณุนุงุฑ ุจู ุฌ.ู | โ |
| 5 | "ููู ุนุฑูุถุ" | ุนุฑุถ ุงูุนุฑูุถ + ุงูุฃุตูุงู ุงููุชุฃุซุฑุฉ ูุฃุฒุฑุงุฑ | โ |
| 6 | "ุนุงูุฒ ุจูุชุฒุง" | ุนุฑุถ ุงููุชุงุฌุฑ ูุฃุฒุฑุงุฑ (ูุด ูุงุฆูุฉ) | โ |
| 7 | ุจุนุฏ ุงุฎุชูุงุฑ ุงููุณู | ูุง ูุณุฃู ุนู ุงููุณู ูุฑุฉ ุฃุฎุฑู | โ |
| 8 | "ูุงู" ุฃู "ุงูุณูุงู ุนูููู" | ุชุฑุญูุจ + ุฃุฒุฑุงุฑ ุงูุฃูุณุงู | โ |

---

## ููุงุญุธุงุช ูููุทูุฑ

1. **city_id ุฅูุฒุงูู** - ุจุฏููู ูุฑุฌุน ุฑุณุงูุฉ "ุงุฎุชุงุฑ ุงููุฏููุฉ"
2. **UUID Validation** - ูู IDs ูุชู ุงูุชุญูู ูููุง ูุจู ุงูุงุณุชุฎุฏุงู
3. **Rate Limiting** - 100 ุฑุณุงูุฉ / 24 ุณุงุนุฉ ููู user
4. **Temperature** - 0.7 ููุฑุฏูุฏ ุงูุทุจูุนูุฉ

---

*ุขุฎุฑ ุชุญุฏูุซ: 13 ุฏูุณูุจุฑ 2025 - ุชู ุฅุถุงูุฉ Direct Payload Handlers ู Memory System*
