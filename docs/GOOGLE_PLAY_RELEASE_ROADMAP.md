# خطة رفع إنجزنا على Google Play Store

## Engezna - Google Play Release Roadmap

**تاريخ الإنشاء:** 2026-02-08
**آخر تحديث:** 2026-02-08
**الحالة:** في انتظار الاعتماد

> **تعليمات المتابعة:** يتم تحديث هذا الملف مع كل مهمة تُنفذ. غيّر `[ ]` إلى `[x]` عند الاكتمال.
> أضف التاريخ الفعلي بجانب كل مهمة مكتملة.

---

## ملخص الخطة

| المرحلة                                        | الأهمية | المدة المتوقعة | الحالة     |
| ---------------------------------------------- | ------- | -------------- | ---------- |
| **المرحلة 0:** إصلاحات أمنية عاجلة             | حرج     | 1 يوم          | ⬜ لم يبدأ |
| **المرحلة 1:** إصلاح نظام الإشعارات والأصوات   | حرج     | 2-3 أيام       | ⬜ لم يبدأ |
| **المرحلة 2:** تحسين الأداء (Lighthouse)       | عالي    | 2-3 أيام       | ⬜ لم يبدأ |
| **المرحلة 3:** إعداد Capacitor + Android Build | عالي    | 2-3 أيام       | ⬜ لم يبدأ |
| **المرحلة 4:** تجهيز Google Play Store Listing | متوسط   | 1-2 يوم        | ⬜ لم يبدأ |
| **المرحلة 5:** الاختبار والمراجعة النهائية     | عالي    | 2-3 أيام       | ⬜ لم يبدأ |
| **المرحلة 6:** النشر على Google Play           | حرج     | 1-3 أيام       | ⬜ لم يبدأ |

**المدة الإجمالية المقدرة:** 11-18 يوم عمل

---

## المرحلة 0: إصلاحات أمنية عاجلة (يوم واحد)

> **السبب:** لا يمكن نشر التطبيق وبه ثغرات أمنية معروفة.

### 0.1 إزالة Firebase Credentials المكشوفة

| المهمة                                                                        | الحالة | التاريخ |
| ----------------------------------------------------------------------------- | ------ | ------- |
| [ ] نقل credentials من `public/firebase-messaging-sw.js` لـ dynamic injection | ⬜     |         |
| [ ] إزالة fallback values من `src/lib/firebase/config.ts`                     | ⬜     |         |
| [ ] التأكد إن كل Firebase config يجي من environment variables فقط             | ⬜     |         |
| [ ] إنشاء `firebase-messaging-sw.js` ديناميكياً عبر build script              | ⬜     |         |

**التفاصيل التقنية:**

المشكلة الحالية في `public/firebase-messaging-sw.js:8-16`:

```javascript
// مكشوف في الكود العام - يجب إزالته
const firebaseConfig = {
  apiKey: 'AIzaSyAMUPCzi2GacDUFIwFLZA11vpFI-bhAAmg',
  // ... باقي البيانات
};
```

الحل: إنشاء API route `/api/firebase-config` يرجع الـ config، والـ Service Worker يجيبه من الـ API.
أو: بناء الـ SW ديناميكياً في `next.config.ts` مع inject env vars.

### 0.2 تحديث Dependencies الضعيفة

| المهمة                                                 | الحالة | التاريخ |
| ------------------------------------------------------ | ------ | ------- |
| [ ] تحديث `jspdf` لأحدث إصدار (ثغرة حرجة)              | ⬜     |         |
| [ ] تحديث `xlsx` أو استبدالها بـ `sheetjs` (ثغرة حرجة) | ⬜     |         |
| [ ] تشغيل `npm audit fix` وإصلاح الباقي يدوياً         | ⬜     |         |
| [ ] إزالة `console.log` statements من ملفات الإشعارات  | ⬜     |         |

### 0.3 التحقق من الحماية

| المهمة                                                                            | الحالة | التاريخ |
| --------------------------------------------------------------------------------- | ------ | ------- |
| [ ] التأكد إن test account auto-confirmation معطل في production                   | ⬜     |         |
| [ ] التأكد إن RBAC middleware شغال وكل المسارات محمية                             | ⬜     |         |
| [ ] تشغيل security tests: `npx playwright test comprehensive-e2e --grep SECURITY` | ⬜     |         |

---

## المرحلة 1: إصلاح نظام الإشعارات والأصوات (2-3 أيام)

> **السبب:** الإشعارات جزء أساسي من تجربة المستخدم في تطبيق توصيل.

### 1.1 إصلاح مشكلة صوت الإشعارات (الأولوية القصوى)

| المهمة                                                              | الحالة | التاريخ |
| ------------------------------------------------------------------- | ------ | ------- |
| [ ] تطبيق User Interaction Audio Unlock Pattern                     | ⬜     |         |
| [ ] إضافة AudioContext resume عند أول تفاعل للمستخدم (click/touch)  | ⬜     |         |
| [ ] إنشاء Audio Manager مركزي بدل إنشاء Audio instances متعددة      | ⬜     |         |
| [ ] إضافة fallback: إذا الصوت فشل، يظهر toast بصري بارز + vibration | ⬜     |         |
| [ ] اختبار الصوت على Chrome Android, Safari iOS, Chrome Desktop     | ⬜     |         |

**التفاصيل التقنية - حل مشكلة الصوت:**

```
المشكلة: المتصفحات تمنع audio.play() بدون user interaction
الحل:
1. عند أول click/touch في أي مكان بالصفحة:
   - إنشاء AudioContext
   - تشغيل صوت فاضي (silent buffer) لفتح الـ audio context
   - تخزين الحالة في sessionStorage
2. بعدها أي إشعار هيقدر يشغل صوت عادي
3. إضافة "تشغيل الأصوات" toggle في الإعدادات كـ explicit permission
```

### 1.2 التأكد من عمل VAPID Key

| المهمة                                                                        | الحالة | التاريخ |
| ----------------------------------------------------------------------------- | ------ | ------- |
| [ ] التأكد إن `NEXT_PUBLIC_FIREBASE_VAPID_KEY` متعرف في environment variables | ⬜     |         |
| [ ] إضافة validation warning لو الـ VAPID key فاضي                            | ⬜     |         |
| [ ] اختبار FCM token generation على بيئة staging                              | ⬜     |         |

### 1.3 إشعارات مقدمي الخدمات (Provider)

| المهمة                                                                       | الحالة | التاريخ |
| ---------------------------------------------------------------------------- | ------ | ------- |
| [ ] التأكد من وصول إشعار صوتي عند طلب جديد (new-order.mp3 عند 0.7 volume)    | ⬜     |         |
| [ ] التأكد من وصول إشعار عند رسالة محادثة جديدة                              | ⬜     |         |
| [ ] التأكد من وصول إشعار عند تقييم جديد                                      | ⬜     |         |
| [ ] التأكد من وصول إشعار عند طلب استرجاع                                     | ⬜     |         |
| [ ] التأكد من وصول إشعار عند شكوى جديدة                                      | ⬜     |         |
| [ ] إضافة صوت مختلف ومميز للطلبات الجديدة (persistent alert حتى يقبل المزود) | ⬜     |         |

### 1.4 إشعارات العملاء (Customer)

| المهمة                                        | الحالة | التاريخ |
| --------------------------------------------- | ------ | ------- |
| [ ] التأكد من وصول إشعار عند تغيير حالة الطلب | ⬜     |         |
| [ ] التأكد من وصول إشعار عند رسالة من المزود  | ⬜     |         |
| [ ] التأكد من وصول إشعار عند تسعير طلب مخصص   | ⬜     |         |
| [ ] التأكد من وصول إشعار عند رد على تذكرة دعم | ⬜     |         |
| [ ] التأكد من وصول إشعار عند معالجة الاسترجاع | ⬜     |         |

### 1.5 إشعارات الأدمن

| المهمة                                                  | الحالة | التاريخ |
| ------------------------------------------------------- | ------ | ------- |
| [ ] تفعيل Push Notifications للأدمن (حالياً in-app فقط) | ⬜     |         |
| [ ] إشعار عند متجر جديد ينتظر الموافقة                  | ⬜     |         |
| [ ] إشعار عند شكوى escalated                            | ⬜     |         |
| [ ] إشعار عند طلب استرجاع جديد                          | ⬜     |         |

### 1.6 بناء واجهة إعدادات الإشعارات

| المهمة                                                       | الحالة | التاريخ |
| ------------------------------------------------------------ | ------ | ------- |
| [ ] إنشاء صفحة Notification Preferences في إعدادات العميل    | ⬜     |         |
| [ ] إنشاء صفحة Notification Preferences في إعدادات المزود    | ⬜     |         |
| [ ] ربط الصفحة بجدول `notification_preferences` الموجود      | ⬜     |         |
| [ ] إضافة toggles: صوت on/off, أنواع الإشعارات, ساعات الهدوء | ⬜     |         |

### 1.7 تنشيط Edge Functions

| المهمة                                                                      | الحالة | التاريخ |
| --------------------------------------------------------------------------- | ------ | ------- |
| [ ] نشر `send-notification` Edge Function على Supabase                      | ⬜     |         |
| [ ] نشر `handle-notification-trigger` Edge Function على Supabase            | ⬜     |         |
| [ ] إعداد Database Webhooks لربط triggers بالـ Edge Functions               | ⬜     |         |
| [ ] اختبار الدورة الكاملة: trigger → webhook → Edge Function → FCM → device | ⬜     |         |

---

## المرحلة 2: تحسين الأداء - Lighthouse (2-3 أيام)

> **السبب:** Google Play يتطلب تجربة مستخدم سلسة. LCP 7.9s غير مقبول.

### 2.1 تحسين Largest Contentful Paint (LCP)

| المهمة                                                      | الحالة | التاريخ |
| ----------------------------------------------------------- | ------ | ------- |
| [ ] تطبيق `priority` على hero images                        | ⬜     |         |
| [ ] استخدام `next/image` مع `sizes` و `srcSet` بشكل صحيح    | ⬜     |         |
| [ ] ضغط البانر الرئيسي (حالياً 938KB - يجب أن يكون < 200KB) | ⬜     |         |
| [ ] تفعيل `preload` لأهم الموارد في `<head>`                | ⬜     |         |
| [ ] الهدف: LCP < 2.5s                                       | ⬜     |         |

### 2.2 تحسين Cumulative Layout Shift (CLS)

| المهمة                                             | الحالة | التاريخ |
| -------------------------------------------------- | ------ | ------- |
| [ ] إضافة `width` و `height` صريح لكل صورة         | ⬜     |         |
| [ ] إضافة skeleton placeholders للمحتوى الديناميكي | ⬜     |         |
| [ ] إصلاح font loading (حالياً يسبب layout shift)  | ⬜     |         |
| [ ] الهدف: CLS < 0.1                               | ⬜     |         |

### 2.3 تحسين First Contentful Paint (FCP)

| المهمة                                            | الحالة | التاريخ |
| ------------------------------------------------- | ------ | ------- |
| [ ] تقليل initial JavaScript bundle size          | ⬜     |         |
| [ ] تأخير تحميل Firebase SDK (lazy loading محسّن) | ⬜     |         |
| [ ] استخدام dynamic imports للصفحات الثقيلة       | ⬜     |         |
| [ ] الهدف: FCP < 1.5s                             | ⬜     |         |

### 2.4 تحسين Speed Index

| المهمة                                                       | الحالة | التاريخ |
| ------------------------------------------------------------ | ------ | ------- |
| [ ] تحسين Server-Side Rendering وتقليل client-side hydration | ⬜     |         |
| [ ] تطبيق ISR Caching على صفحات المزودين والمنتجات           | ⬜     |         |
| [ ] إضافة streaming SSR لأجزاء الصفحة الكبيرة                | ⬜     |         |
| [ ] الهدف: Speed Index < 4s                                  | ⬜     |         |

### 2.5 تحسينات عامة

| المهمة                                                        | الحالة | التاريخ |
| ------------------------------------------------------------- | ------ | ------- |
| [ ] تحويل الصور الكبيرة لـ WebP/AVIF                          | ⬜     |         |
| [ ] إضافة المزيد من Skeleton Loaders (حالياً 2 فقط)           | ⬜     |         |
| [ ] تفعيل gzip/brotli compression                             | ⬜     |         |
| [ ] تحسين Accessibility score من 87 إلى 95+ (contrast ratios) | ⬜     |         |
| [ ] تشغيل Lighthouse audit ومقارنة النتائج                    | ⬜     |         |
| [ ] الهدف: Lighthouse Performance > 80                        | ⬜     |         |

---

## المرحلة 3: إعداد Capacitor + Android Build (2-3 أيام)

> **السبب:** لرفع التطبيق كـ APK/AAB على Google Play.

### 3.1 تثبيت وإعداد Capacitor

| المهمة                                                  | الحالة | التاريخ |
| ------------------------------------------------------- | ------ | ------- |
| [ ] تثبيت: `npm install @capacitor/core @capacitor/cli` | ⬜     |         |
| [ ] تشغيل: `npx cap init "إنجزنا" "com.engezna.app"`    | ⬜     |         |
| [ ] إنشاء `capacitor.config.ts` بالإعدادات المناسبة     | ⬜     |         |
| [ ] إضافة Android platform: `npx cap add android`       | ⬜     |         |

**إعدادات Capacitor المقترحة:**

```typescript
// capacitor.config.ts
const config = {
  appId: 'com.engezna.app',
  appName: 'إنجزنا',
  webDir: 'out', // أو '.next/standalone' حسب الـ build strategy
  server: {
    androidScheme: 'https',
    hostname: 'app.engezna.com', // أو الدومين المناسب
  },
  plugins: {
    PushNotifications: {
      presentationOptions: ['badge', 'sound', 'alert'],
    },
    SplashScreen: {
      launchAutoHide: false,
      backgroundColor: '#0F172A',
    },
  },
};
```

### 3.2 إعداد Native Plugins

| المهمة                                                         | الحالة | التاريخ |
| -------------------------------------------------------------- | ------ | ------- |
| [ ] تثبيت `@capacitor/push-notifications` لإشعارات native      | ⬜     |         |
| [ ] تثبيت `@capacitor/geolocation` للموقع الجغرافي             | ⬜     |         |
| [ ] تثبيت `@capacitor/camera` لتصوير المنتجات                  | ⬜     |         |
| [ ] تثبيت `@capacitor/share` للمشاركة                          | ⬜     |         |
| [ ] تثبيت `@capacitor/app` لـ deep linking و app state         | ⬜     |         |
| [ ] تثبيت `@capacitor/status-bar` و `@capacitor/splash-screen` | ⬜     |         |
| [ ] تثبيت `@capacitor/haptics` للاهتزاز عند الإشعارات          | ⬜     |         |

### 3.3 إعداد Android Project

| المهمة                                                                    | الحالة | التاريخ |
| ------------------------------------------------------------------------- | ------ | ------- |
| [ ] إعداد `google-services.json` من Firebase Console                      | ⬜     |         |
| [ ] إضافة Firebase dependencies في `android/app/build.gradle`             | ⬜     |         |
| [ ] إعداد Notification Channel مع sound في `MainActivity.java`            | ⬜     |         |
| [ ] إضافة notification sound files في `android/app/src/main/res/raw/`     | ⬜     |         |
| [ ] إعداد App Icon (Adaptive Icon) بالأحجام المطلوبة                      | ⬜     |         |
| [ ] إعداد Splash Screen                                                   | ⬜     |         |
| [ ] إعداد `AndroidManifest.xml` (permissions, deep links, intent filters) | ⬜     |         |

### 3.4 Build و Testing

| المهمة                                                          | الحالة | التاريخ |
| --------------------------------------------------------------- | ------ | ------- |
| [ ] بناء الـ Next.js static export: `next build && next export` | ⬜     |         |
| [ ] مزامنة: `npx cap sync android`                              | ⬜     |         |
| [ ] اختبار على Android Emulator                                 | ⬜     |         |
| [ ] اختبار على جهاز Android حقيقي                               | ⬜     |         |
| [ ] اختبار الإشعارات الصوتية على Android                        | ⬜     |         |
| [ ] اختبار Deep Linking                                         | ⬜     |         |
| [ ] اختبار Offline Mode                                         | ⬜     |         |
| [ ] بناء Release AAB: `./gradlew bundleRelease`                 | ⬜     |         |

---

## المرحلة 4: تجهيز Google Play Store Listing (1-2 يوم)

> **السبب:** Google Play يتطلب محتوى محدد لقبول التطبيق.

### 4.1 إنشاء حساب Google Play Developer

| المهمة                                       | الحالة | التاريخ |
| -------------------------------------------- | ------ | ------- |
| [ ] تسجيل حساب Google Play Developer ($25)   | ⬜     |         |
| [ ] إعداد ملف الشركة/المطور                  | ⬜     |         |
| [ ] التحقق من الهوية (Identity Verification) | ⬜     |         |

### 4.2 تجهيز المحتوى المرئي

| المهمة                                                        | الحالة | التاريخ |
| ------------------------------------------------------------- | ------ | ------- |
| [ ] تصميم Feature Graphic (1024x500 px)                       | ⬜     |         |
| [ ] تصميم App Icon (512x512 px - موجود بالفعل)                | ⬜     |         |
| [ ] أخذ Screenshots للموبايل (min 2, max 8) - أحجام مطلوبة:   | ⬜     |         |
| - Phone: 16:9 أو 9:16 (min 320px, max 3840px)                 |        |         |
| [ ] أخذ Screenshots للتابلت 7" (اختياري)                      | ⬜     |         |
| [ ] أخذ Screenshots للتابلت 10" (اختياري)                     | ⬜     |         |
| [ ] تحويل Screenshots من SVG إلى PNG (الحالية SVG غير مقبولة) | ⬜     |         |

### 4.3 كتابة محتوى المتجر

| المهمة                                              | الحالة | التاريخ |
| --------------------------------------------------- | ------ | ------- |
| [ ] Short Description (حتى 80 حرف) - عربي وإنجليزي  | ⬜     |         |
| [ ] Full Description (حتى 4000 حرف) - عربي وإنجليزي | ⬜     |         |
| [ ] Privacy Policy URL (موجود: `/ar/privacy`)       | ⬜     |         |
| [ ] رابط الشروط والأحكام                            | ⬜     |         |

**مقترح Short Description:**

```
AR: إنجزنا - اطلب احتياجات بيتك من محلات بلدك. توصيل سريع بأسعار المحل!
EN: Engezna - Order daily essentials from local stores. Fast delivery at store prices!
```

### 4.4 إعداد Content Rating و Data Safety

| المهمة                                          | الحالة | التاريخ |
| ----------------------------------------------- | ------ | ------- |
| [ ] ملء استبيان Content Rating (IARC)           | ⬜     |         |
| [ ] ملء Data Safety Form:                       | ⬜     |         |
| - Location data: نعم (لتحديد منطقة التوصيل)     |        |         |
| - Personal info: نعم (الاسم، الهاتف، العنوان)   |        |         |
| - Financial info: نعم (بيانات الدفع عبر Paymob) |        |         |
| - App activity: نعم (سجل الطلبات)               |        |         |
| [ ] تحديد Target Audience: 13+ (خدمة توصيل)     | ⬜     |         |
| [ ] اختيار App Category: Food & Drink           | ⬜     |         |
| [ ] تحديد البلدان المستهدفة: مصر                | ⬜     |         |

---

## المرحلة 5: الاختبار والمراجعة النهائية (2-3 أيام)

### 5.1 اختبار شامل قبل النشر

| المهمة                                                   | الحالة | التاريخ |
| -------------------------------------------------------- | ------ | ------- |
| [ ] تشغيل جميع Unit Tests (270 test)                     | ⬜     |         |
| [ ] تشغيل Security Tests (76 test)                       | ⬜     |         |
| [ ] تشغيل E2E Tests                                      | ⬜     |         |
| [ ] اختبار يدوي لكل flow أساسي:                          | ⬜     |         |
| - تسجيل حساب جديد → تصفح المتاجر → إضافة للسلة → طلب     |        |         |
| - تسجيل دخول مزود → استقبال طلب → قبول → تحضير → توصيل   |        |         |
| - إرسال رسالة محادثة → استقبال إشعار                     |        |         |
| - طلب استرجاع → الموافقة عليه                            |        |         |
| [ ] اختبار الإشعارات بالصوت على 3 أجهزة مختلفة على الأقل | ⬜     |         |
| [ ] اختبار Offline mode والعودة للاتصال                  | ⬜     |         |
| [ ] اختبار Deep Links                                    | ⬜     |         |

### 5.2 مراجعة الأداء النهائية

| المهمة                                   | الحالة | التاريخ |
| ---------------------------------------- | ------ | ------- |
| [ ] Lighthouse Performance Score > 80    | ⬜     |         |
| [ ] Lighthouse Accessibility Score > 90  | ⬜     |         |
| [ ] Lighthouse Best Practices Score > 90 | ⬜     |         |
| [ ] Lighthouse SEO Score > 90            | ⬜     |         |
| [ ] APK Size < 50MB (الأمثل < 30MB)      | ⬜     |         |

### 5.3 مراجعة أمنية نهائية

| المهمة                                           | الحالة | التاريخ |
| ------------------------------------------------ | ------ | ------- |
| [ ] التأكد من إزالة كل console.log من production | ⬜     |         |
| [ ] التأكد من عدم وجود API keys مكشوفة           | ⬜     |         |
| [ ] التأكد من عدم وجود test data في production   | ⬜     |         |
| [ ] npm audit بدون ثغرات critical أو high        | ⬜     |         |
| [ ] التأكد إن كل RLS policies شغالة              | ⬜     |         |

---

## المرحلة 6: النشر على Google Play (1-3 أيام)

### 6.1 Internal Testing (مطلوب قبل أي إصدار)

| المهمة                                 | الحالة | التاريخ |
| -------------------------------------- | ------ | ------- |
| [ ] رفع AAB على Internal Testing Track | ⬜     |         |
| [ ] إضافة مختبرين (5 على الأقل)        | ⬜     |         |
| [ ] اختبار التثبيت والتشغيل            | ⬜     |         |
| [ ] جمع feedback والإصلاح              | ⬜     |         |

### 6.2 Closed Testing (اختياري لكن مفضل)

| المهمة                                      | الحالة | التاريخ |
| ------------------------------------------- | ------ | ------- |
| [ ] نقل للـ Closed Testing Track            | ⬜     |         |
| [ ] إضافة 20+ مختبر من المستخدمين الحقيقيين | ⬜     |         |
| [ ] مراقبة Crash Reports و ANRs             | ⬜     |         |
| [ ] إصلاح أي مشاكل مكتشفة                   | ⬜     |         |

### 6.3 Production Release

| المهمة                                           | الحالة | التاريخ |
| ------------------------------------------------ | ------ | ------- |
| [ ] إرسال للمراجعة (Google Review يأخذ 1-7 أيام) | ⬜     |         |
| [ ] Staged Rollout: 10% → 25% → 50% → 100%       | ⬜     |         |
| [ ] مراقبة التقييمات والمراجعات                  | ⬜     |         |
| [ ] الرد على مراجعات المستخدمين                  | ⬜     |         |

---

## ملحق: ملاحظات هندسية إضافية

### مشاكل يجب مراقبتها بعد النشر

| المشكلة                              | الحل المقترح                                      |
| ------------------------------------ | ------------------------------------------------- |
| Double polling في الإشعارات          | إزالة الـ polling الزائد في `useNotifications.ts` |
| Supabase client creation متكرر       | استخدام singleton pattern                         |
| Memory leak محتمل في channel cleanup | استخدام useRef بدل state للـ channel              |
| Edge Functions غير منشورة            | نشرها وربطها بـ database webhooks                 |
| SMS/WhatsApp notifications           | توصيل provider (Twilio/MessageBird) - مرحلة لاحقة |

### ملفات مرجعية

| الملف                                               | المحتوى                        |
| --------------------------------------------------- | ------------------------------ |
| `docs/LAUNCH_READINESS_CHECKLIST.md`                | قائمة جاهزية الإطلاق العامة    |
| `docs/SECURITY_ISSUES_FOUND.md`                     | تقرير الثغرات الأمنية المكتشفة |
| `docs/features/FIREBASE_PUSH_NOTIFICATIONS_PLAN.md` | خطة Firebase المفصلة           |
| `docs/MONITORING_SETUP.md`                          | إعداد المراقبة                 |
| `docs/QUALITY_LAYERS_ROADMAP.md`                    | خريطة طبقات الجودة             |

---

## سجل التحديثات

| التاريخ    | التحديث             | بواسطة |
| ---------- | ------------------- | ------ |
| 2026-02-08 | إنشاء الخطة الشاملة | Claude |
|            |                     |        |
