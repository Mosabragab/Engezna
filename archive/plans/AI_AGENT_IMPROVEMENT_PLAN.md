# Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† AI Agent - Engezna Smart Assistant

**Ø§Ù„ØªØ§Ø±ÙŠØ®:** 2025-12-16
**Ø§Ù„Ø¥ØµØ¯Ø§Ø±:** v2.4 Plan
**Ø§Ù„Ø­Ø§Ù„Ø©:** ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙ†ÙÙŠØ°

---

## Ù…Ù„Ø®Øµ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚ (Ù…Ù† Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø´Ø§Øª)

### Ù…Ø§ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø¬ÙŠØ¯ âœ…

| Ø§Ù„Ù…ÙŠØ²Ø©            | Ø§Ù„Ø­Ø§Ù„Ø© | Ù…Ø«Ø§Ù„                                |
| ----------------- | ------ | ----------------------------------- |
| Ø§Ù„ØªØ­ÙŠØ© Ø¨Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª | âœ…     | "ØµØ¨Ø§Ø­ Ø§Ù„ÙÙ„!"                        |
| Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬Ø§Øª   | âœ…     | "Ø¹Ø§ÙŠØ² Ø­ÙˆØ§ÙˆØ´ÙŠ" â†’ Ù†ØªØ§Ø¦Ø¬ ØµØ­ÙŠØ­Ø©         |
| Ø¹Ø±Ø¶ Ø§Ù„Ù€ Variants  | âœ…     | Ø¹Ø§Ø¯ÙŠ/ÙƒØ¨ÙŠØ± Ù„Ù„Ø­ÙˆØ§ÙˆØ´ÙŠ                  |
| ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨       | âœ…     | "2x Ø­ÙˆØ§ÙˆØ´ÙŠ ÙØ±Ø§Ø® ÙƒØ¨ÙŠØ± Ø¨Ù€140 Ø¬.Ù… ØµØ­ØŸ" |
| Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ù…ØµØ±ÙŠØ©    | âœ…     | Ø·Ø¨ÙŠØ¹ÙŠØ© ÙˆÙˆØ¯ÙŠØ©                        |

### Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ´ÙØ© âŒ

| Ø§Ù„Ù…Ø´ÙƒÙ„Ø©                 | Ø§Ù„Ø£Ø«Ø± | Ø§Ù„ØªØ­Ù„ÙŠÙ„                                                      |
| ----------------------- | ----- | ------------------------------------------------------------ |
| **Ø§Ù„Ø³Ù„Ø© Ù„Ø§ ØªØªØ­Ø¯Ø«**      | Ø¹Ø§Ù„ÙŠ  | Ø§Ù„Ù€ `cart_action` ÙŠØ±Ø¬Ø¹ Ù…Ù† Ø§Ù„Ù€ API Ù„ÙƒÙ† Ø§Ù„Ù€ Frontend Ù„Ø§ ÙŠØ¹Ø§Ù„Ø¬Ù‡ |
| **Ø²Ø± Ø§Ù„Ù…Ù†ÙŠÙˆ Ù…Ø¹Ø·Ù„**      | Ø¹Ø§Ù„ÙŠ  | URL ÙŠØ³ØªØ®Ø¯Ù… Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø± Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ID/Slug                       |
| **Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙØ§Ø±ØºØ©**        | Ù…ØªÙˆØ³Ø· | Ø§Ù„Ù€ Tool ÙŠØ¹Ù…Ù„ Ù„ÙƒÙ† Ù‚Ø¯ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ DB                    |
| **Quick Replies Ø«Ø§Ø¨ØªØ©** | Ù…Ù†Ø®ÙØ¶ | Ù„Ø§ ØªØªØºÙŠØ± Ø¨Ø­Ø³Ø¨ Ø§Ù„Ø³ÙŠØ§Ù‚ Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„                               |

---

## ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø®Ù…Ø³Ø©

### 1ï¸âƒ£ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ø¨Ø­Ø« (Search Strategy)

**Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ:**

```typescript
// agentTools.ts - search_menu
.or(`name_ar.ilike.%${query}%,description_ar.ilike.%${query}%`)
```

**Ø§Ù„Ù…Ø´Ø§ÙƒÙ„:**

- `ilike` Ù„Ø§ ÙŠÙÙ‡Ù… Ø§Ù„Ù…ØªØ±Ø§Ø¯ÙØ§Øª: "Ø³Ø§Ù†Ø¯ÙˆØªØ´" â‰  "Ø³Ù†Ø¯ÙˆÙŠØªØ´"
- Ù„Ø§ ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¥Ù…Ù„Ø§Ø¦ÙŠØ©: "Ø¨ÙŠØªØ°Ø§" â‰  "Ø¨ÙŠØªØ²Ø§"
- Ù„Ø§ ÙŠÙÙ‡Ù… Ø§Ù„Ø³ÙŠØ§Ù‚: "Ø­Ø§Ø¬Ø© Ø®ÙÙŠÙØ©" Ù„Ø§ ØªØ±Ø¬Ø¹ Ø³Ù„Ø·Ø§Øª
- Ù„Ø§ ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ù€ Embeddings Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©!

**Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Hybrid Search Pipeline                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Keyword Match (ilike)                                       â”‚
â”‚     â””â”€â”€ Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø§Ù„Ø³Ø±ÙŠØ¹                                    â”‚
â”‚                                                                  â”‚
â”‚  2. Semantic Search (pgvector + embeddings)                     â”‚
â”‚     â””â”€â”€ Ù„ÙÙ‡Ù… Ø§Ù„Ù…Ø¹Ù†Ù‰ ÙˆØ§Ù„Ù…ØªØ±Ø§Ø¯ÙØ§Øª                                  â”‚
â”‚                                                                  â”‚
â”‚  3. Fuzzy Match (pg_trgm)                                       â”‚
â”‚     â””â”€â”€ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¥Ù…Ù„Ø§Ø¦ÙŠØ©                                        â”‚
â”‚                                                                  â”‚
â”‚  4. RRF (Reciprocal Rank Fusion)                                â”‚
â”‚     â””â”€â”€ Ø¯Ù…Ø¬ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ù† ÙƒÙ„ Ø§Ù„Ø·Ø±Ù‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§:**

- `src/lib/ai/agentTools.ts` - ØªØ¹Ø¯ÙŠÙ„ `search_menu`
- `supabase/migrations/` - Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© `hybrid_search_menu`
- `supabase/functions/search-embedding/` - Edge Function Ù„Ù„Ù€ query embedding

**Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:** ğŸ”´ Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹

---

### 2ï¸âƒ£ Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙˆØ§Ù„Ø³ÙŠØ§Ù‚ (Memory & Context)

**Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ:**

```typescript
// agentPrompt.ts - buildSystemPrompt
// Ø§Ù„Ø³ÙŠØ§Ù‚ ÙƒÙ„Ù‡ ÙÙŠ System Prompt (~700 Ø³Ø·Ø±!)
// Ù„Ø§ ØªÙˆØ¬Ø¯ Ø°Ø§ÙƒØ±Ø© Ø·ÙˆÙŠÙ„Ø© Ø§Ù„Ù…Ø¯Ù‰
// Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ø¯ÙˆÙ„ user_insights
```

**Ø§Ù„Ù…Ø´Ø§ÙƒÙ„:**

- System Prompt Ø¶Ø®Ù… Ø¬Ø¯Ø§Ù‹ (ÙŠØ³ØªÙ‡Ù„Ùƒ tokens ÙƒØ«ÙŠØ±Ø©)
- Ù„Ø§ ØªÙˆØ¬Ø¯ Ø°Ø§ÙƒØ±Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„ (ØªÙØ¶ÙŠÙ„Ø§ØªÙ‡ØŒ Ø¢Ø®Ø± Ø·Ù„Ø¨Ø§ØªÙ‡)
- Ù„Ø§ ÙŠÙˆØ¬Ø¯ context optimization
- Ù†ÙØ³ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªÙØ±Ø³Ù„ ÙÙŠ ÙƒÙ„ Ø±Ø³Ø§Ù„Ø©

**Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:**

```sql
-- Ø¬Ø¯ÙˆÙ„ Ø¬Ø¯ÙŠØ¯: user_insights
CREATE TABLE user_insights (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES profiles(id),

  -- ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ø·Ø¹Ø§Ù…
  favorite_categories text[],      -- ['Ø¨ÙŠØªØ²Ø§', 'Ø´Ø§ÙˆØ±Ù…Ø§']
  dietary_preferences jsonb,       -- {vegetarian: false, spicy: true}
  usual_order_time varchar(20),    -- 'lunch', 'dinner', 'late_night'

  -- Ø³Ù„ÙˆÙƒ Ø§Ù„Ø·Ù„Ø¨
  average_order_value decimal,
  preferred_providers uuid[],
  last_ordered_items jsonb,        -- [{item_id, name, count}]

  -- ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯
  successful_orders int DEFAULT 0,
  abandoned_carts int DEFAULT 0,
  common_queries text[],

  created_at timestamp DEFAULT now(),
  updated_at timestamp DEFAULT now()
);
```

**Context Optimization:**

```typescript
// Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ØŒ Ù†Ø±Ø³Ù„ ÙÙ‚Ø· Ø§Ù„Ù…Ù„Ø§Ø¦Ù…Ø© Ù„Ù„Ø³ÙŠØ§Ù‚
function buildOptimizedPrompt(context: AgentContext): string {
  const sections = [];

  // Core personality (Ø¯Ø§ÙŠÙ…Ø§Ù‹)
  sections.push(CORE_PERSONALITY);

  // Context-specific rules
  if (context.cartItems?.length > 0) {
    sections.push(CART_RULES);
  }
  if (context.providerContext) {
    sections.push(PROVIDER_RULES);
  }
  if (context.customerMemory?.orderCount > 0) {
    sections.push(RETURNING_CUSTOMER_RULES);
  }

  return sections.join('\n\n');
}
```

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§:**

- `supabase/migrations/` - Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙˆÙ„ `user_insights`
- `src/lib/ai/agentPrompt.ts` - ØªÙ‚Ø³ÙŠÙ… Prompt Ù„Ø£Ù‚Ø³Ø§Ù…
- `src/app/api/chat/route.ts` - Ø¬Ù„Ø¨ insights Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©

**Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:** ğŸŸ¡ Ù…ØªÙˆØ³Ø·Ø©

---

### 3ï¸âƒ£ Ø¯Ù‚Ø© Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø£Ø¯ÙˆØ§Øª (Tool Calling Precision)

**Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ:**

```typescript
// agentHandler.ts
const result = await executeAgentTool(toolName, toolArgs, context);
// Ù„Ø§ ÙŠÙˆØ¬Ø¯ validation
// Ù„Ø§ ÙŠÙˆØ¬Ø¯ fallback
// Ù„Ø§ ÙŠÙˆØ¬Ø¯ retry logic
```

**Ø§Ù„Ù…Ø´Ø§ÙƒÙ„:**

- Ø§Ù„Ù€ AI Ù‚Ø¯ ÙŠØ³ØªØ¯Ø¹ÙŠ tool Ø¨Ù€ parameters Ø®Ø§Ø·Ø¦Ø©
- Ù„Ø§ ÙŠÙˆØ¬Ø¯ validation Ù„Ù„Ù€ input
- Ù„Ø§ ÙŠÙˆØ¬Ø¯ fallback Ù„Ù†Ù…ÙˆØ°Ø¬ Ø£Ù‚ÙˆÙ‰ Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„
- Ù„Ø§ ÙŠÙˆØ¬Ø¯ caching Ù„Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©

**Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:**

```typescript
// Ø·Ø¨Ù‚Ø© Validation Ø¬Ø¯ÙŠØ¯Ø©
interface ToolValidation {
  toolName: string;
  validate: (params: Record<string, unknown>, context: ToolContext) => ValidationResult;
}

const TOOL_VALIDATORS: Record<string, ToolValidation> = {
  search_menu: {
    validate: (params, context) => {
      // Ù„Ùˆ Ù…ÙÙŠØ´ queryØŒ Ø§Ø±ÙØ¶
      if (!params.query || typeof params.query !== 'string') {
        return { valid: false, error: 'Query is required' };
      }
      // Ù„Ùˆ Ø§Ù„Ù€ query Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹
      if (params.query.length < 2) {
        return { valid: false, error: 'Query too short' };
      }
      return { valid: true };
    },
  },
  add_to_cart: {
    validate: (params, context) => {
      // Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† ÙÙŠÙ‡ item_id Ùˆ provider_id
      if (!params.item_id) {
        return { valid: false, error: 'item_id is required' };
      }
      // Ù„Ùˆ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† ØªØ§Ø¬Ø± Ù…Ø®ØªÙ„Ù ÙˆØ§Ù„Ø³Ù„Ø© ÙÙŠÙ‡Ø§ Ø­Ø§Ø¬Ø§Øª
      if (context.cartProviderId && params.provider_id !== context.cartProviderId) {
        return {
          valid: false,
          error: 'different_provider',
          message: 'Ø§Ù„Ø³Ù„Ø© ÙÙŠÙ‡Ø§ Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† ØªØ§Ø¬Ø± ØªØ§Ù†ÙŠ',
        };
      }
      return { valid: true };
    },
  },
};

// Fallback Strategy
async function executeWithFallback(
  toolName: string,
  params: Record<string, unknown>,
  context: ToolContext
): Promise<ToolResult> {
  // 1. Validate first
  const validation = TOOL_VALIDATORS[toolName]?.validate(params, context);
  if (validation && !validation.valid) {
    return { success: false, error: validation.error };
  }

  // 2. Try execution
  const result = await executeAgentTool(toolName, params, context);

  // 3. If failed with empty results, try alternative
  if (result.success && Array.isArray(result.data) && result.data.length === 0) {
    // Try semantic search as fallback
    if (toolName === 'search_menu' && params.query) {
      return await executeSemanticSearch(params.query, context);
    }
  }

  return result;
}
```

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§:**

- `src/lib/ai/toolValidation.ts` - Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯
- `src/lib/ai/agentHandler.ts` - Ø¥Ø¶Ø§ÙØ© validation layer
- `src/lib/ai/agentTools.ts` - ØªØ­Ø³ÙŠÙ† error handling

**Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:** ğŸ”´ Ø¹Ø§Ù„ÙŠØ©

---

### 4ï¸âƒ£ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù„Ù‡Ø¬Ø§Øª (Dialect Handling)

**Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ:**

```typescript
// agentHandler.ts - generateDynamicQuickReplies
// Quick replies Ø«Ø§Ø¨ØªØ© Ø¨Ù€ if/else
if (isAskingVariant && hasProducts) {
  return {
    suggestions: ['ØµØºÙŠØ±', 'ÙˆØ³Ø·', 'ÙƒØ¨ÙŠØ±'],
    // ...
  };
}
```

**Ø§Ù„Ù…Ø´Ø§ÙƒÙ„:**

- Quick replies Ø«Ø§Ø¨ØªØ© Ù„Ø§ ØªØªØºÙŠØ± Ø¨Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ÙØ¹Ù„ÙŠ
- Ù„Ùˆ Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù‡ Ø£Ø­Ø¬Ø§Ù… Ù…Ø®ØªÙ„ÙØ© (ØµØºÙŠØ±/Ù…ØªÙˆØ³Ø·/Ø¹Ø§Ø¦Ù„ÙŠ) Ù…Ø§ Ø¨ØªØ¸Ù‡Ø±Ø´
- Ø§Ù„Ù€ AI Ù…Ø´ Ø¨ÙŠÙˆÙ„Ø¯ Ø§Ù„Ù€ quick replies Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹

**Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:**

```typescript
// Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† hardcodedØŒ Ù†Ø®Ù„ÙŠ Ø§Ù„Ù€ AI ÙŠÙˆÙ„Ø¯ Quick Replies
// ÙÙŠ response format

interface AIResponseFormat {
  content: string;
  quick_replies?: Array<{
    title: string;
    payload: string;
  }>;
  // Ø§Ù„Ù€ AI ÙŠÙˆÙ„Ø¯Ù‡Ù… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ù‚
}

// ÙÙŠ Ø§Ù„Ù€ System Prompt
`
Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø¯ØŒ Ù„Ùˆ Ù…Ø­ØªØ§Ø¬ ØªØ¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª Ù„Ù„Ø¹Ù…ÙŠÙ„:
- Ø§ÙƒØªØ¨ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
- Frontend Ù‡ÙŠØ­ÙˆÙ„Ù‡Ù… Ù„Ø£Ø²Ø±Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ù‚

Ù…Ø«Ø§Ù„:
"Ø§Ù„Ø­ÙˆØ§ÙˆØ´ÙŠ ÙÙŠÙ‡ Ø­Ø¬Ù…ÙŠÙ†:
â€¢ Ø¹Ø§Ø¯ÙŠ - 50 Ø¬.Ù…
â€¢ ÙƒØ¨ÙŠØ± - 70 Ø¬.Ù…
Ø¹Ø§ÙŠØ² Ø£Ù†Ù‡ÙŠØŸ"

Frontend Ù‡ÙŠÙÙ‡Ù… Ø¥Ù† ÙÙŠÙ‡ Ø®ÙŠØ§Ø±ÙŠÙ†: Ø¹Ø§Ø¯ÙŠ ÙˆÙƒØ¨ÙŠØ±
`;

// Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ØªÙˆÙ„ÙŠØ¯ Quick Replies Ù…Ù† Ø§Ù„Ù€ handlerØŒ
// Ù†Ø­Ù„Ù„Ù‡Ø§ Ù…Ù† Ø±Ø¯ Ø§Ù„Ù€ AI Ù†ÙØ³Ù‡
function extractQuickRepliesFromContent(content: string, toolResults: ToolResult[]): QuickReply[] {
  const replies: QuickReply[] = [];

  // 1. Ù„Ùˆ ÙÙŠÙ‡ variants ÙÙŠ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
  const variants = extractVariantsFromToolResults(toolResults);
  if (variants.length > 0) {
    variants.forEach((v) => {
      replies.push({
        title: `ğŸ“ ${v.name} - ${v.price} Ø¬.Ù…`,
        payload: `Ø¹Ø§ÙŠØ² ${v.name}`,
      });
    });
  }

  // 2. Ù„Ùˆ Ø§Ù„Ù€ AI Ø¨ÙŠØ³Ø£Ù„ Ø¹Ù† Ø§Ù„ÙƒÙ…ÙŠØ©
  if (content.includes('ÙƒØ§Ù… ÙˆØ§Ø­Ø¯') || content.includes('ÙƒÙ…ÙŠØ©')) {
    replies.push(
      { title: '1ï¸âƒ£ ÙˆØ§Ø­Ø¯Ø©', payload: 'ÙˆØ§Ø­Ø¯Ø©' },
      { title: '2ï¸âƒ£ Ø§ØªÙ†ÙŠÙ†', payload: 'Ø§ØªÙ†ÙŠÙ†' },
      { title: '3ï¸âƒ£ ØªÙ„Ø§ØªØ©', payload: 'ØªÙ„Ø§ØªØ©' }
    );
  }

  return replies;
}
```

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§:**

- `src/lib/ai/agentHandler.ts` - ØªØ­Ø³ÙŠÙ† `generateDynamicQuickReplies`
- `src/lib/ai/agentPrompt.ts` - ØªØ¹Ø¯ÙŠÙ„ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù€ format

**Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:** ğŸŸ¡ Ù…ØªÙˆØ³Ø·Ø©

---

### 5ï¸âƒ£ Ø§Ù„Ø­ÙˆØ§Ø¬Ø² Ø§Ù„Ø£Ù…Ù†ÙŠØ© (Guardrails)

**Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ:**

```typescript
// agentHandler.ts - sanitizeAgentResponse
// ÙŠÙˆØ¬Ø¯ regex Ù„Ø¥Ø²Ø§Ù„Ø© URLs ÙˆØ§Ù„Ù€ markdown
sanitized = sanitized.replace(/https?:\/\/[^\s<>"\)]+/gi, '');
```

**Ù…Ø§ ÙŠØ¹Ù…Ù„ âœ…:**

- Ø¥Ø²Ø§Ù„Ø© URLs
- Ø¥Ø²Ø§Ù„Ø© Markdown images
- Ø¥Ø²Ø§Ù„Ø© code blocks

**Ù…Ø§ ÙŠÙ†Ù‚Øµ âŒ:**

- Ù„Ø§ ÙŠÙˆØ¬Ø¯ stock validation Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©
- Ù„Ø§ ÙŠÙˆØ¬Ø¯ price validation
- Ù„Ø§ ÙŠÙˆØ¬Ø¯ provider status check
- Ù„Ø§ ÙŠÙˆØ¬Ø¯ rate limiting Ù„Ù„Ù€ tool calls

**Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:**

```typescript
// Pre-execution Guardrails
const PRE_EXECUTION_GUARDS: Record<string, Guard> = {
  add_to_cart: async (params, context) => {
    // 1. Check item availability
    const item = await getMenuItem(params.item_id);
    if (!item?.is_available) {
      return {
        blocked: true,
        message: 'Ø§Ù„Ù…Ù†ØªØ¬ Ø¯Ù‡ Ù…Ø´ Ù…ØªØ§Ø­ Ø¯Ù„ÙˆÙ‚ØªÙŠ',
      };
    }

    // 2. Check stock
    if (item.has_stock === false) {
      return {
        blocked: true,
        message: 'Ø§Ù„Ù…Ù†ØªØ¬ Ø®Ù„Øµ Ù„Ù„Ø£Ø³Ù',
      };
    }

    // 3. Check provider is open
    const provider = await getProvider(params.provider_id);
    if (provider?.status !== 'open') {
      return {
        blocked: true,
        message: 'Ø§Ù„Ù…Ø·Ø¹Ù… Ù…ØºÙ„Ù‚ Ø¯Ù„ÙˆÙ‚ØªÙŠ',
      };
    }

    // 4. Validate price matches
    const expectedPrice = params.variant_id ? await getVariantPrice(params.variant_id) : item.price;
    if (Math.abs(params.price - expectedPrice) > 0.01) {
      return {
        blocked: true,
        message: 'ÙÙŠÙ‡ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø³Ø¹Ø±ØŒ Ø¬Ø±Ø¨ ØªØ§Ù†ÙŠ',
      };
    }

    return { blocked: false };
  },
};

// Post-execution Guardrails (ÙÙŠ sanitizeAgentResponse)
function sanitizeAgentResponse(content: string): string {
  let sanitized = content;

  // 1. Remove URLs (Ù…ÙˆØ¬ÙˆØ¯)
  sanitized = sanitized.replace(/https?:\/\/[^\s<>"\)]+/gi, '');

  // 2. Remove UUIDs (Ø¬Ø¯ÙŠØ¯)
  sanitized = sanitized.replace(
    /[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/gi,
    ''
  );

  // 3. Remove JSON (ØªØ­Ø³ÙŠÙ†)
  sanitized = sanitized.replace(/\{[^{}]*"[^"]*"[^{}]*:[^{}]*\}/g, '');

  // 4. Remove provider IDs that might leak
  sanitized = sanitized.replace(/provider[_-]?id[:=]\s*["']?[\w-]+["']?/gi, '');

  // 5. Remove any numeric IDs
  sanitized = sanitized.replace(/\b(id|ID)[:=]\s*\d+\b/g, '');

  return sanitized.trim();
}

// Rate Limiting
const toolCallCounts = new Map<string, number>();
const TOOL_RATE_LIMITS: Record<string, number> = {
  search_menu: 5, // max 5 searches per conversation
  add_to_cart: 10, // max 10 adds per conversation
  cancel_order: 1, // max 1 cancel per conversation
};

function checkRateLimit(toolName: string): boolean {
  const count = toolCallCounts.get(toolName) || 0;
  const limit = TOOL_RATE_LIMITS[toolName] || Infinity;

  if (count >= limit) {
    return false;
  }

  toolCallCounts.set(toolName, count + 1);
  return true;
}
```

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§:**

- `src/lib/ai/guardrails.ts` - Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯
- `src/lib/ai/agentHandler.ts` - Ø¥Ø¶Ø§ÙØ© pre/post guards
- `src/lib/ai/agentTools.ts` - Ø¥Ø¶Ø§ÙØ© stock check ÙÙŠ `add_to_cart`

**Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:** ğŸ”´ Ø¹Ø§Ù„ÙŠØ©

---

## Ø®Ø·Ø© Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ø­ÙƒÙ…Ø©

### Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„Ø¹Ø§Ø¬Ù„Ø© (ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯)

| #   | Ø§Ù„Ù…Ù‡Ù…Ø©                | Ø§Ù„Ù…Ù„Ù                | Ø§Ù„ÙˆØµÙ                              |
| --- | --------------------- | -------------------- | ---------------------------------- |
| 1.1 | Ø¥ØµÙ„Ø§Ø­ Cart Actions    | `useAIChat.ts`       | Ù…Ø¹Ø§Ù„Ø¬Ø© `cart_action` Ù…Ù† response   |
| 1.2 | Ø¥ØµÙ„Ø§Ø­ Menu Navigation | `SmartAssistant.tsx` | Ø§Ø³ØªØ®Ø¯Ø§Ù… provider ID Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø§Ø³Ù… |
| 1.3 | Ø¥Ø¶Ø§ÙØ© Stock Check     | `agentTools.ts`      | Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙØ± Ù‚Ø¨Ù„ `add_to_cart` |

**ÙƒÙˆØ¯ Ø¥ØµÙ„Ø§Ø­ Cart Actions:**

```typescript
// useAIChat.ts - ÙÙŠ handleResponse
if (response.cartAction) {
  const { type, provider_id, menu_item_id, quantity, unit_price, variant_id } = response.cartAction;

  switch (type) {
    case 'ADD_ITEM':
      addToCart({
        providerId: provider_id,
        menuItemId: menu_item_id,
        quantity,
        unitPrice: unit_price,
        variantId: variant_id,
      });
      break;
    case 'REMOVE_ITEM':
      removeFromCart(menu_item_id);
      break;
    case 'CLEAR_CART':
      clearCart();
      break;
  }
}
```

---

### Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¨Ø­Ø« (3-5 Ø£ÙŠØ§Ù…)

| #   | Ø§Ù„Ù…Ù‡Ù…Ø©              | Ø§Ù„Ù…Ù„Ù           | Ø§Ù„ÙˆØµÙ                     |
| --- | ------------------- | --------------- | ------------------------- |
| 2.1 | Ø¯Ø§Ù„Ø© Hybrid Search  | Migration       | SQL function Ù…Ø¹ pgvector  |
| 2.2 | Query Embedding API | Edge Function   | ØªÙˆÙ„ÙŠØ¯ embedding Ù„Ù„Ù€ query |
| 2.3 | ØªØ­Ø¯ÙŠØ« search_menu   | `agentTools.ts` | Ø§Ø³ØªØ®Ø¯Ø§Ù… Hybrid Search     |
| 2.4 | Fuzzy Match         | Migration       | Ø¥Ø¶Ø§ÙØ© pg_trgm extension   |

**SQL Function:**

```sql
CREATE OR REPLACE FUNCTION hybrid_search_menu(
  p_query text,
  p_query_embedding vector(1536),
  p_provider_id uuid DEFAULT NULL,
  p_city_id uuid DEFAULT NULL,
  p_limit int DEFAULT 10
)
RETURNS TABLE (
  id uuid,
  name_ar text,
  price decimal,
  image_url text,
  has_variants boolean,
  provider_id uuid,
  provider_name text,
  category_name text,
  match_score float
) AS $$
BEGIN
  RETURN QUERY
  WITH keyword_matches AS (
    SELECT
      mi.id,
      1.0 / (ROW_NUMBER() OVER (ORDER BY mi.name_ar ILIKE '%' || p_query || '%' DESC) + 60) as rrf_score
    FROM menu_items mi
    WHERE mi.is_available = true
      AND (p_provider_id IS NULL OR mi.provider_id = p_provider_id)
      AND (mi.name_ar ILIKE '%' || p_query || '%' OR mi.description_ar ILIKE '%' || p_query || '%')
    LIMIT 20
  ),
  semantic_matches AS (
    SELECT
      mi.id,
      1.0 / (ROW_NUMBER() OVER (ORDER BY mi.embedding <=> p_query_embedding) + 60) as rrf_score
    FROM menu_items mi
    WHERE mi.embedding IS NOT NULL
      AND mi.is_available = true
      AND (p_provider_id IS NULL OR mi.provider_id = p_provider_id)
    ORDER BY mi.embedding <=> p_query_embedding
    LIMIT 20
  ),
  fuzzy_matches AS (
    SELECT
      mi.id,
      1.0 / (ROW_NUMBER() OVER (ORDER BY similarity(mi.name_ar, p_query) DESC) + 60) as rrf_score
    FROM menu_items mi
    WHERE mi.is_available = true
      AND (p_provider_id IS NULL OR mi.provider_id = p_provider_id)
      AND similarity(mi.name_ar, p_query) > 0.3
    LIMIT 20
  ),
  combined AS (
    SELECT
      COALESCE(k.id, s.id, f.id) as item_id,
      COALESCE(k.rrf_score, 0) + COALESCE(s.rrf_score, 0) + COALESCE(f.rrf_score, 0) as total_score
    FROM keyword_matches k
    FULL OUTER JOIN semantic_matches s ON k.id = s.id
    FULL OUTER JOIN fuzzy_matches f ON COALESCE(k.id, s.id) = f.id
  )
  SELECT
    mi.id,
    mi.name_ar,
    mi.price,
    mi.image_url,
    mi.has_variants,
    mi.provider_id,
    p.name_ar as provider_name,
    pc.name_ar as category_name,
    c.total_score as match_score
  FROM combined c
  JOIN menu_items mi ON c.item_id = mi.id
  JOIN providers p ON mi.provider_id = p.id
  LEFT JOIN provider_categories pc ON mi.provider_category_id = pc.id
  ORDER BY c.total_score DESC
  LIMIT p_limit;
END;
$$ LANGUAGE plpgsql;
```

---

### Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø§Ù„Ø­ÙˆØ§Ø¬Ø² ÙˆØ§Ù„ØªØ­Ù‚Ù‚ (2-3 Ø£ÙŠØ§Ù…)

| #   | Ø§Ù„Ù…Ù‡Ù…Ø©                      | Ø§Ù„Ù…Ù„Ù               | Ø§Ù„ÙˆØµÙ                         |
| --- | --------------------------- | ------------------- | ----------------------------- |
| 3.1 | Tool Validation Layer       | `toolValidation.ts` | validation Ù„ÙƒÙ„ tool           |
| 3.2 | Pre-execution Guards        | `guardrails.ts`     | stock, price, provider checks |
| 3.3 | Post-execution Sanitization | `agentHandler.ts`   | ØªØ­Ø³ÙŠÙ† regex                   |
| 3.4 | Rate Limiting               | `agentHandler.ts`   | Ø­Ø¯ÙˆØ¯ Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª         |

---

### Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙˆØ§Ù„Ø³ÙŠØ§Ù‚ (3-5 Ø£ÙŠØ§Ù…)

| #   | Ø§Ù„Ù…Ù‡Ù…Ø©              | Ø§Ù„Ù…Ù„Ù            | Ø§Ù„ÙˆØµÙ                     |
| --- | ------------------- | ---------------- | ------------------------- |
| 4.1 | Ø¬Ø¯ÙˆÙ„ user_insights  | Migration        | Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„              |
| 4.2 | Insights Collection | API              | Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª |
| 4.3 | Prompt Optimization | `agentPrompt.ts` | ØªÙ‚Ø³ÙŠÙ… ÙˆØªØ­Ø³ÙŠÙ† Ø§Ù„Ù€ prompt   |
| 4.4 | Context Loading     | `route.ts`       | Ø¬Ù„Ø¨ insights Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© |

---

### Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5: ØªØ­Ø³ÙŠÙ† Quick Replies (1-2 ÙŠÙˆÙ…)

| #   | Ø§Ù„Ù…Ù‡Ù…Ø©                | Ø§Ù„Ù…Ù„Ù             | Ø§Ù„ÙˆØµÙ                           |
| --- | --------------------- | ----------------- | ------------------------------- |
| 5.1 | Dynamic Variants      | `agentHandler.ts` | Ø§Ø³ØªØ®Ø±Ø§Ø¬ variants Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« |
| 5.2 | Context-aware Replies | `agentHandler.ts` | ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ù†Ø·Ù‚                    |
| 5.3 | AI-generated Options  | `agentPrompt.ts`  | ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù„Ù„Ù€ AI                  |

---

## Ù…Ù„Ø®Øµ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª

```
ğŸ”´ Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹ (ÙŠØ¬Ø¨ Ø§Ù„Ø¨Ø¯Ø¡ ÙÙˆØ±Ø§Ù‹):
â”œâ”€â”€ Ø¥ØµÙ„Ø§Ø­ Cart Actions (Frontend Ù„Ø§ ÙŠØ¹Ø§Ù„Ø¬ cart_action)
â”œâ”€â”€ Ø¥ØµÙ„Ø§Ø­ Menu Navigation (URL Ù…Ø¹Ø·Ù„)
â””â”€â”€ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¨Ø­Ø« (Hybrid Search)

ğŸŸ  Ø¹Ø§Ù„ÙŠØ© (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù‚Ø§Ø¯Ù…):
â”œâ”€â”€ Tool Validation Layer
â”œâ”€â”€ Stock/Availability Check
â””â”€â”€ Post-processing Guardrails

ğŸŸ¡ Ù…ØªÙˆØ³Ø·Ø© (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø«Ø§Ù„Ø«):
â”œâ”€â”€ user_insights Table
â”œâ”€â”€ Prompt Optimization
â””â”€â”€ Dynamic Quick Replies

ğŸŸ¢ Ù…Ù†Ø®ÙØ¶Ø© (Ù„Ø§Ø­Ù‚Ø§Ù‹):
â”œâ”€â”€ Full Semantic Search Integration
â””â”€â”€ Advanced Context Management
```

---

## Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ù†Ø¬Ø§Ø­

| Ø§Ù„Ù…Ù‚ÙŠØ§Ø³           | Ø§Ù„Ù‡Ø¯Ù     | Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù‚ÙŠØ§Ø³           |
| ----------------- | --------- | ---------------------- |
| Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¨Ø­Ø«        | > 90%     | Ù†ØªØ§Ø¦Ø¬ / Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø­Ø«   |
| Ø¯Ù‚Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© | > 95%     | Ø¥Ø¶Ø§ÙØ§Øª Ù†Ø§Ø¬Ø­Ø© / Ù…Ø­Ø§ÙˆÙ„Ø§Øª |
| Ø±Ø¶Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„        | > 4/5     | Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©   |
| Ø²Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©     | < 2 Ø«Ø§Ù†ÙŠØ© | Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø±Ø¯         |

---

_Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: 2025-12-16_

---

## ğŸ“‹ Ø³Ø¬Ù„ Ø¬Ù„Ø³Ø§Øª Ø§Ù„ØªØ·ÙˆÙŠØ±

### Ø¬Ù„Ø³Ø© 2025-12-21: Regional Filtering Ù„Ù„Ù€ Admin Dashboard

#### Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…Ù†Ø¬Ø²Ø© âœ…

| Ø§Ù„Ù…Ù‡Ù…Ø©                    | Ø§Ù„ÙˆØµÙ                                | Ø§Ù„Ù…Ù„Ù                                 |
| ------------------------- | ------------------------------------ | ------------------------------------- |
| ØªØµÙÙŠØ© Ø§Ù„Ù…ØªØ§Ø¬Ø± Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© | Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø¥Ù‚Ù„ÙŠÙ…ÙŠ ÙŠØ±Ù‰ ÙÙ‚Ø· Ù…ØªØ§Ø¬Ø± Ù…Ù†Ø·Ù‚ØªÙ‡ | `admin/providers/page.tsx`            |
| ØªØµÙÙŠØ© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© | Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ù…ØªØ§Ø¬Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙÙ‚Ø·         | `admin/orders/page.tsx`               |
| ØªØµÙÙŠØ© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© | Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø±ØªØ¨Ø·ÙŠÙ† Ø¨Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù†Ø·Ù‚Ø©     | `admin/customers/page.tsx`            |
| ØªØµÙÙŠØ© Resolution Center   | Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø§Ø²Ø¹Ø§Øª Ù„Ù„Ù…Ù†Ø·Ù‚Ø© ÙÙ‚Ø·       | `admin/resolution-center/page.tsx`    |
| ØªØµÙÙŠØ© Analytics           | ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙÙ‚Ø·                  | `admin/analytics/page.tsx`            |
| ØªØµÙÙŠØ© Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø´Ø§Ø±Ø§Øª       | Badge counts Ø¹Ù„Ù‰ Ø§Ù„Ù€ sidebar         | `admin/layout.tsx`                    |
| ØªØµÙÙŠØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª           | Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙÙ‚Ø·                  | `components/admin/AdminHeader.tsx`    |
| AdminRegionContext        | ØªØ®Ø²ÙŠÙ† Ù…Ø¤Ù‚Øª Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±Ù            | `lib/contexts/AdminRegionContext.tsx` |
| Database Migration        | Ø¥Ø¶Ø§ÙØ© regional columns Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª     | Migration file                        |

#### Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…Ø³ØªÙØ§Ø¯Ø© ğŸ“š

##### 1. Whitelist vs Blacklist Ù„Ù„ØªØµÙÙŠØ©

```typescript
// âŒ Blacklist (ØºÙŠØ± Ù…ÙˆØ«ÙˆÙ‚): Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø£Ù†ÙˆØ§Ø¹ Ù…Ø¹ÙŠÙ†Ø©
const regionalTypes = ['new_provider', 'refund_escalated', 'late_order', ...]
if (regionalTypes.includes(notif.type)) {
  // filter by region
}
// Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: Ù…Ù…ÙƒÙ† ØªÙ†Ø³Ù‰ Ù†ÙˆØ¹ Ø¬Ø¯ÙŠØ¯

// âœ… Whitelist (Ù…ÙˆØ«ÙˆÙ‚): Ø§Ø³Ù…Ø­ ÙÙ‚Ø· Ø¨Ø£Ù†ÙˆØ§Ø¹ Ù…Ø­Ø¯Ø¯Ø©
const genericTypes = ['message', 'announcement', 'system', 'welcome', 'info']
if (genericTypes.includes(notif.type)) {
  return true // Ø³Ù…Ø§Ø­ Ø¹Ø§Ù…
}
if (notif.governorate_id) {
  return allowedGovernorateIds.includes(notif.governorate_id)
}
return false // Ø±ÙØ¶ Ø§Ù„Ø¨Ø§Ù‚ÙŠ
```

##### 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø§Ù„Ø© "Ù„Ø§ ÙŠÙˆØ¬Ø¯ providers ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©"

```typescript
// âŒ ØºÙ„Ø·: Ø§Ù„ÙÙ„ØªØ± Ù„Ø§ ÙŠÙØ·Ø¨Ù‚ Ø¹Ù†Ø¯Ù…Ø§ regionProviderIds ÙØ§Ø±ØºØ©
if (hasRegionFilter && regionProviderIds.length > 0) {
  query = query.in('provider_id', regionProviderIds);
}
// Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: Ù„Ùˆ regionProviderIds.length === 0ØŒ ÙŠØ¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!

// âœ… ØµØ­: Ø¥Ø±Ø¬Ø§Ø¹ ØµÙØ± Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
if (hasRegionFilter && regionProviderIds.length === 0) {
  setData([]); // Ø£Ùˆ Ø¹Ø±Ø¶ 0
  return;
}
if (hasRegionFilter && regionProviderIds.length > 0) {
  query = query.in('provider_id', regionProviderIds);
}
```

##### 3. Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙ„ØªØ± Ù‚Ø¨Ù„ ØªØ·Ø¨ÙŠÙ‚Ù‡

```typescript
// âŒ ØºÙ„Ø·: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø£Ù† ÙŠØ¬Ù‡Ø² Ø§Ù„ÙÙ„ØªØ±
useEffect(() => {
  loadData(); // Ø§Ù„ÙÙ„ØªØ± Ù‚Ø¯ ÙŠÙƒÙˆÙ† null
}, []);

// âœ… ØµØ­: Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙ„ØªØ±
const { loading: filterLoading, hasRegionFilter } = useAdminRegion();

useEffect(() => {
  if (!filterLoading) {
    loadData(); // Ø§Ù„ÙÙ„ØªØ± Ø¬Ø§Ù‡Ø² Ø§Ù„Ø¢Ù†
  }
}, [filterLoading]);
```

#### Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©

| Ø§Ù„Ù…Ù„Ù                                                                                  | Ø§Ù„ÙˆØµÙ                                        |
| -------------------------------------------------------------------------------------- | -------------------------------------------- |
| `src/lib/contexts/AdminRegionContext.tsx`                                              | Context Ù„Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø·Ù‚Ø©       |
| `supabase/migrations/20251221210000_add_regional_filtering_to_admin_notifications.sql` | Ø¥Ø¶Ø§ÙØ© columns Ùˆ triggers Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¥Ù‚Ù„ÙŠÙ…ÙŠØ© |

#### Database Functions Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©

```sql
-- Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† Ø¹Ù† Ù…Ø­Ø§ÙØ¸Ø©
get_admins_for_governorate(p_governorate_id UUID)

-- Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø± Ø¥Ù‚Ù„ÙŠÙ…ÙŠ
create_regional_admin_notification(
  p_type, p_title, p_body,
  p_provider_id, p_order_id, p_governorate_id, ...
)
```

#### SQL Query Ù„Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ

```sql
-- Ø­Ø°Ù admin user Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
DELETE FROM admin_users WHERE user_id IN (
  SELECT id FROM auth.users WHERE email = 'bebo@test.com'
);
DELETE FROM auth.users WHERE email = 'bebo@test.com';
```
